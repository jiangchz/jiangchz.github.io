<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content=",,,," />





  <link rel="alternate" href="/atom.xml" title="小土刀" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="本文的文章来自 http://chengway.in/，这里是把十五章的内容整理到一起，方便自己查阅。感谢原作者的详细笔记。">
<meta name="keywords">
<meta property="og:type" content="website">
<meta property="og:title" content="iOS 9 by Turorials 笔记">
<meta property="og:url" content="http://wdxtub.com/vault/ios9-by-tutorial-note.html">
<meta property="og:site_name" content="小土刀">
<meta property="og:description" content="本文的文章来自 http://chengway.in/，这里是把十五章的内容整理到一起，方便自己查阅。感谢原作者的详细笔记。">
<meta property="og:image" content="http://wdxtub.com/images/ibt1.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt2.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt3.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt4.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt5.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt6.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt7.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt8.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt9.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt10.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt11.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt12.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt13.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt14.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt15.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt16.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt17.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt18.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt19.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt20.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt21.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt22.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt23.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt24.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt25.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt26.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt27.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt28.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt29.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt30.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt31.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt32.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt33.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt34.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt35.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt36.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt37.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt38.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt39.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt40.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt41.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt42.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt43.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt44.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt45.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt46.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt47.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt48.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt49.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt50.gif">
<meta property="og:image" content="http://wdxtub.com/images/ibt51.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt52.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt53.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt54.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt55.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt56.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt57.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt58.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt59.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt60.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt61.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt62.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt63.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt64.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt65.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt66.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt67.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt68.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt69.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt70.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt71.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt72.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt73.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt74.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt75.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt76.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt77.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt78.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt79.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt80.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt81.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt82.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt83.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt84.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt85.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt86.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt87.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt88.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt89.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt90.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt91.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt92.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt93.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt94.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt95.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt96.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt97.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt98.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt99.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt100.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt101.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt102.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt103.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt104.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt105.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt106.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt107.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt108.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt109.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt110.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt111.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt112.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt113.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt114.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt115.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt116.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt117.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt118.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt119.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt120.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt121.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt122.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt123.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt124.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt125.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt126.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt127.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt128.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt129.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt130.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt131.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt132.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt133.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt134.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt135.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt136.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt137.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt138.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt139.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt140.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt141.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt142.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt143.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt144.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt145.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt146.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt147.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt148.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt149.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt150.jpg">
<meta property="og:image" content="http://wdxtub.com/images/ibt151.jpg">
<meta property="og:updated_time" content="2016-01-22T20:37:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS 9 by Turorials 笔记">
<meta name="twitter:description" content="本文的文章来自 http://chengway.in/，这里是把十五章的内容整理到一起，方便自己查阅。感谢原作者的详细笔记。">
<meta name="twitter:image" content="http://wdxtub.com/images/ibt1.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 4016951,
      author: '博主'
    }
  };
</script>

  <title>
  

  
    iOS 9 by Turorials 笔记 | 小土刀
  
</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <!-- hexo-inject:begin --><!-- hexo-inject:end --><script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=59042340";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div style="display: none;">
    <script src="http://s6.cnzz.com/stat.php?id=1260625611&web_id=1260625611" type="text/javascript"></script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-left  ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">小土刀</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Agony is my triumph</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-work">
          <a href="/2016/09/11/work-page" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-pencil"></i> <br />
            
            作品
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tech">
          <a href="/2009/09/11/tech-page" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-battery-full"></i> <br />
            
            技术
          </a>
        </li>
      
        
        <li class="menu-item menu-item-life">
          <a href="/1990/09/11/life-page" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-bolt"></i> <br />
            
            生活
          </a>
        </li>
      
        
        <li class="menu-item menu-item-booklist">
          <a href="/1997/09/11/booklist-page" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-diamond"></i> <br />
            
            书单
          </a>
        </li>
      
        
        <li class="menu-item menu-item-thanks">
          <a href="/thanks" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-gift"></i> <br />
            
            关于我
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
      <p>本文的文章来自 <a href="http://chengway.in/" target="_blank" rel="external">http://chengway.in/</a>，这里是把十五章的内容整理到一起，方便自己查阅。感谢原作者的详细笔记。</p>
<a id="more"></a>
<hr>
<h2 id="Chapter-1-Swift-2-0"><a href="#Chapter-1-Swift-2-0" class="headerlink" title="Chapter 1: Swift 2.0"></a>Chapter 1: Swift 2.0</h2><h3 id="Control-Flow"><a href="#Control-Flow" class="headerlink" title="Control Flow"></a>Control Flow</h3><h4 id="1、repeat"><a href="#1、repeat" class="headerlink" title="1、repeat"></a>1、repeat</h4><p><code>do/while</code> 变成了 <code>repeat/while</code>，语义更加明确</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> jamJarBeer = <span class="type">Beer</span>()</div><div class="line"><span class="keyword">repeat</span> &#123;</div><div class="line">  jamJarBeer.sip()</div><div class="line">&#125; <span class="keyword">while</span> (!jamJarBeer.isEmpty) <span class="comment">// 啤酒不为空就喝到空为止</span></div></pre></td></tr></table></figure>
<h4 id="2、guard"><a href="#2、guard" class="headerlink" title="2、guard"></a>2、guard</h4><p>这个是条件预判断，也没啥好说的，Swift 的创始人 Chris Lattner 在 WWDC 2015 上说推出新关键字 guard 的原因是： 在 early exit 时觉得用 if let 要缩进太丑了</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Beer</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> percentRemaining = <span class="number">100</span></div><div class="line">  <span class="keyword">var</span> isEmpty: <span class="type">Bool</span> &#123; <span class="keyword">return</span> percentRemaining &lt;= <span class="number">0</span> &#125;</div><div class="line">  <span class="keyword">var</span> owner: <span class="type">Patron</span>?</div><div class="line">  <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">sip</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">guard</span> percentRemaining &gt; <span class="number">0</span> <span class="keyword">else</span> &#123;</div><div class="line">      <span class="built_in">print</span>(<span class="string">"Your beer is empty, order another!"</span>)</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    percentRemaining -= <span class="number">10</span></div><div class="line">    <span class="built_in">print</span>(<span class="string">"Mmmm \(percentRemaining)% left"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Error-handling"><a href="#Error-handling" class="headerlink" title="Error handling"></a>Error handling</h3><p>本质上一个纯粹 Swift 错误（A pure Swift error），可以看做是遵循 ErrorType 协议的 enum。了解到这一点，我们就可以定制自己的 error type。</p>
<p>一般 Error handling 要记住三步：</p>
<p>1.创建自己的 ErrorType</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ParseError</span>: <span class="title">ErrorType</span> </span>&#123;</div><div class="line">    <span class="keyword">case</span> <span class="type">MissingAttribute</span>(message: <span class="type">String</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.声明一个方法会 throw 错误，然后在实现中 throw 第一步定义的 errorType 枚举对象具体的错误分支（case）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span>: <span class="title">JSONParsable</span> </span>&#123;</div><div class="line">    <span class="keyword">let</span> firstName: <span class="type">String</span></div><div class="line">    <span class="keyword">let</span> lastName: <span class="type">String</span></div><div class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">parse</span><span class="params">(json: [String : AnyObject])</span></span> <span class="keyword">throws</span></div><div class="line">      -&gt; <span class="type">Person</span> &#123;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> firstName = json[<span class="string">"first_name"</span>] <span class="keyword">as</span>? <span class="type">String</span> <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">let</span> message = <span class="string">"Expected first_name String"</span></div><div class="line">            <span class="keyword">throw</span> <span class="type">ParseError</span>.<span class="type">MissingAttribute</span>(message: message)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> lastName = json[<span class="string">"lastname"</span>] <span class="keyword">as</span>? <span class="type">String</span> <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">let</span> message = <span class="string">"Expected lastname String"</span></div><div class="line">            <span class="keyword">throw</span> <span class="type">ParseError</span>.<span class="type">MissingAttribute</span>(message: message)</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="type">Person</span>(firstName: firstName, lastName: lastName)</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>3.在 do/try/catch 中调用第二步创建的这个方法，并捕获错误</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">    <span class="keyword">let</span> person = <span class="keyword">try</span> <span class="type">Person</span>.parse([<span class="string">"foo"</span>: <span class="string">"bar"</span>])</div><div class="line">&#125; <span class="keyword">catch</span> <span class="type">ParseError</span>.<span class="type">MissingAttribute</span>(<span class="keyword">let</span> message) &#123;</div><div class="line">    <span class="built_in">print</span>(message)</div><div class="line">&#125; <span class="keyword">catch</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"Unexpected ErrorType"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果你能保证不出错误，也可以用 try!</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> p1 = <span class="keyword">try</span>! <span class="type">Person</span>.parse([<span class="string">"foo"</span>: <span class="string">"bar"</span>])</div></pre></td></tr></table></figure>
<h3 id="The-Project"><a href="#The-Project" class="headerlink" title="The Project"></a>The Project</h3><h4 id="1、String-Validation-Error"><a href="#1、String-Validation-Error" class="headerlink" title="1、String Validation Error"></a>1、String Validation Error</h4><p>①.字符串验证协议</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 字符串验证规则</span></div><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">StringValidationRule</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">validate</span><span class="params">(string: String)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Bool</span></div><div class="line">  <span class="keyword">var</span> errorType: <span class="type">StringValidationError</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了使用多个规则一起用，再定义一个 StringValidator 协议</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">StringValidator</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> validationRules: [<span class="type">StringValidationRule</span>] &#123; <span class="keyword">get</span> &#125;</div><div class="line">  <span class="comment">// 这种返回值是一个元组，带 errors 信息，就不用 throw 了</span></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">validate</span><span class="params">(string: String)</span></span> -&gt; (valid: <span class="type">Bool</span>,</div><div class="line">    errors: [<span class="type">StringValidationError</span>])</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在 Protocol Extensions 里可以直接写协议的方法实现了，只要遵循了该协议将自动享受到这些实现，比如在下面的 Protocol Extensions 中实现 <code>validate</code> 方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">StringValidator</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">validate</span><span class="params">(string: String)</span></span> -&gt; (valid: <span class="type">Bool</span>,</div><div class="line">    errors: [<span class="type">StringValidationError</span>]) &#123;</div><div class="line">    <span class="keyword">var</span> errors = [<span class="type">StringValidationError</span>]()</div><div class="line">    <span class="keyword">for</span> rule <span class="keyword">in</span> validationRules &#123;</div><div class="line">      <span class="keyword">do</span> &#123;</div><div class="line">        <span class="keyword">try</span> rule.validate(string)</div><div class="line">      &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error <span class="keyword">as</span> <span class="type">StringValidationError</span> &#123;</div><div class="line">        errors.append(error)</div><div class="line">      &#125; <span class="keyword">catch</span> <span class="keyword">let</span> error &#123;</div><div class="line">        <span class="built_in">fatalError</span>(<span class="string">"Unexpected error type: \(error)"</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> (valid: errors.isEmpty, errors: errors)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>②.具体的验证实例 以 xx 类型字符开头的验证规则，遵循 StringValidationRule 协议</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">StartsWithCharacterStringValidationRule</span></span></div><div class="line">  : <span class="title">StringValidationRule</span> &#123;</div><div class="line">  <span class="keyword">let</span> characterSet: <span class="type">NSCharacterSet</span></div><div class="line">  <span class="keyword">let</span> description: <span class="type">String</span></div><div class="line"></div><div class="line">  <span class="keyword">var</span> errorType: <span class="type">StringValidationError</span> &#123;</div><div class="line">    <span class="keyword">return</span> .<span class="type">MustStartWith</span>(<span class="keyword">set</span>: characterSet,</div><div class="line">      description: description)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">validate</span><span class="params">(string: String)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">if</span> string.startsWithCharacterFromSet(characterSet) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">throw</span> errorType</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用看输出</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> letterSet = <span class="type">NSCharacterSet</span>.letterCharacterSet()</div><div class="line"><span class="keyword">let</span> startsWithRule = <span class="type">StartsWithCharacterStringValidationRule</span>(</div><div class="line">  characterSet: letterSet,</div><div class="line">  description: <span class="string">"letter"</span>)</div><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">  <span class="keyword">try</span> startsWithRule.validate(<span class="string">"foo"</span>)</div><div class="line">  <span class="keyword">try</span> startsWithRule.validate(<span class="string">"123"</span>)</div><div class="line">&#125; <span class="keyword">catch</span> <span class="keyword">let</span> error &#123;</div><div class="line">  <span class="built_in">print</span>(error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>必须以某种字符结尾的验证规则</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">EndsWithCharacterStringValidationRule</span></span></div><div class="line">  : <span class="title">StringValidationRule</span> &#123;</div><div class="line">  <span class="keyword">let</span> characterSet: <span class="type">NSCharacterSet</span></div><div class="line">  <span class="keyword">let</span> description: <span class="type">String</span></div><div class="line">  <span class="keyword">var</span> errorType: <span class="type">StringValidationError</span> &#123;</div><div class="line">    <span class="keyword">return</span> .<span class="type">MustEndWith</span>(<span class="keyword">set</span>: characterSet,</div><div class="line">      description: description)</div><div class="line">&#125;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">validate</span><span class="params">(string: String)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">if</span> string.endsWithCharacterFromSet(characterSet) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">throw</span> errorType</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>结合上面两条 rules（StartsWithCharacterStringValidationRule，EndsWithCharacterStringValidationRule）创建一个 StartsAndEndsWithStringValidator，验证开头和结尾的字符</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">StartsAndEndsWithStringValidator</span>: <span class="title">StringValidator</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> startsWithSet: <span class="type">NSCharacterSet</span></div><div class="line">  <span class="keyword">let</span> startsWithDescription: <span class="type">String</span></div><div class="line">  <span class="keyword">let</span> endsWithSet: <span class="type">NSCharacterSet</span></div><div class="line">  <span class="keyword">let</span> endsWithDescription: <span class="type">String</span></div><div class="line">  <span class="keyword">var</span> validationRules: [<span class="type">StringValidationRule</span>] &#123;</div><div class="line">    <span class="keyword">return</span> [</div><div class="line">      <span class="type">StartsWithCharacterStringValidationRule</span>(</div><div class="line">        characterSet: startsWithSet,</div><div class="line">        description: startsWithDescription),</div><div class="line">      <span class="type">EndsWithCharacterStringValidationRule</span>(</div><div class="line">        characterSet: endsWithSet ,</div><div class="line">        description: endsWithDescription)</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>其实 StringValidator 协议还有个 validate 方法，但是在之前的 extension 方法已经实现了</p>
</blockquote>
<p>验证：以字母开头，数字结尾</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> numberSet = <span class="type">NSCharacterSet</span>.decimalDigitCharacterSet()</div><div class="line"></div><div class="line"><span class="keyword">let</span> startsAndEndsWithValidator =</div><div class="line">  <span class="type">StartsAndEndsWithStringValidator</span>(</div><div class="line">    startsWithSet: letterSet,</div><div class="line">    startsWithDescription: <span class="string">"letter"</span>,</div><div class="line">    endsWithSet: numberSet,</div><div class="line">    endsWithDescription: <span class="string">"number"</span>)</div><div class="line"></div><div class="line">startsAndEndsWithValidator.validate(<span class="string">"1foo"</span>).errors.description</div><div class="line">startsAndEndsWithValidator.validate(<span class="string">"foo"</span>).errors.description</div><div class="line">startsAndEndsWithValidator.validate(<span class="string">"foo1"</span>).valid</div></pre></td></tr></table></figure>
<h4 id="2、Password-Requirement-Validation"><a href="#2、Password-Requirement-Validation" class="headerlink" title="2、Password Requirement Validation"></a>2、Password Requirement Validation</h4><p>现在将 StringValidator 投入到实际的工作中，用来验证密码是否符合规范</p>
<ul>
<li>密码长度至少 8 位</li>
<li>必须包含一个大写字母</li>
<li>必须包含一个小写字母</li>
<li>必须包含一个数字</li>
<li>必须包含一个以下特殊字符：<code>!@#$%^&amp;*()_-+&lt;&gt;?/[]{}</code></li>
</ul>
<p>首先来创建一条验证字符串长度的 LengthStringValidationRule：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">LengthStringValidationRule</span></span></div><div class="line">  : <span class="title">StringValidationRule</span> &#123;</div><div class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> </span>&#123;</div><div class="line">    <span class="keyword">case</span> <span class="type">Min</span>(length: <span class="type">Int</span>)</div><div class="line">    <span class="keyword">case</span> <span class="type">Max</span>(length: <span class="type">Int</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">let</span> type: <span class="type">Type</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">var</span> errorType: <span class="type">StringValidationError</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(type: <span class="type">Type</span>)</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">validate</span><span class="params">(string: String)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着创建验证包含某些字符的 ContainsCharacterStringValidationRule</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">ContainsCharacterStringValidationRule</span></span></div><div class="line">  : <span class="title">StringValidationRule</span> &#123;</div><div class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Type</span> </span>&#123;</div><div class="line">    <span class="keyword">case</span> <span class="type">MustContain</span></div><div class="line">    <span class="keyword">case</span> <span class="type">CannotContain</span></div><div class="line">    <span class="keyword">case</span> <span class="type">OnlyContain</span></div><div class="line">    <span class="keyword">case</span> <span class="type">ContainAtLeast</span>(<span class="type">Int</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">let</span> characterSet: <span class="type">NSCharacterSet</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">let</span> description: <span class="type">String</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">let</span> type: <span class="type">Type</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">var</span> errorType: <span class="type">StringValidationError</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">init</span>(characterSet: <span class="type">NSCharacterSet</span>,</div><div class="line">    description: <span class="type">String</span>,</div><div class="line">    type: <span class="type">Type</span>)</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">validate</span><span class="params">(string: String)</span></span> <span class="keyword">throws</span> -&gt; <span class="type">Bool</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>两条 rules 在手，下面我们来验证密码的有效性：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PasswordRequirementStringValidator</span>: <span class="title">StringValidator</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> validationRules: [<span class="type">StringValidationRule</span>] &#123;</div><div class="line">    <span class="keyword">let</span> upper = <span class="type">NSCharacterSet</span>.uppercaseLetterCharacterSet()</div><div class="line">    <span class="keyword">let</span> lower = <span class="type">NSCharacterSet</span>.lowercaseLetterCharacterSet()</div><div class="line">    <span class="keyword">let</span> number = <span class="type">NSCharacterSet</span>.decimalDigitCharacterSet()</div><div class="line">    <span class="keyword">let</span> special = <span class="type">NSCharacterSet</span>(</div><div class="line">      charactersInString: <span class="string">"!@#$%^&amp;*()_-+&lt;&gt;?/\\[]&#125;&#123;"</span>)</div><div class="line">    <span class="keyword">return</span> [</div><div class="line">      <span class="type">LengthStringValidationRule</span>(type: .<span class="type">Min</span>(length: <span class="number">8</span>)),</div><div class="line">      <span class="type">ContainsCharacterStringValidationRule</span>(</div><div class="line">        characterSet:upper ,</div><div class="line">        description: <span class="string">"upper case letter"</span>,</div><div class="line">        type: .<span class="type">ContainAtLeast</span>(<span class="number">1</span>)),</div><div class="line">      <span class="type">ContainsCharacterStringValidationRule</span>(</div><div class="line">        characterSet: lower,</div><div class="line">        description: <span class="string">"lower case letter"</span>,</div><div class="line">        type: .<span class="type">ContainAtLeast</span>(<span class="number">1</span>)),</div><div class="line">      <span class="type">ContainsCharacterStringValidationRule</span>(</div><div class="line">        characterSet:number ,</div><div class="line">        description: <span class="string">"number"</span>,</div><div class="line">        type: .<span class="type">ContainAtLeast</span>(<span class="number">1</span>)),</div><div class="line">      <span class="type">ContainsCharacterStringValidationRule</span>(</div><div class="line">        characterSet:special,</div><div class="line">        description: <span class="string">"special character"</span>,</div><div class="line">        type: .<span class="type">ContainAtLeast</span>(<span class="number">1</span>))</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>验证：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> passwordValidator = <span class="type">PasswordRequirementStringValidator</span>()</div><div class="line">passwordValidator.validate(<span class="string">"abc1"</span>).errors.description</div><div class="line">passwordValidator.validate(<span class="string">"abc1!Fjk"</span>).errors.description</div></pre></td></tr></table></figure>
<h3 id="Additional-Things"><a href="#Additional-Things" class="headerlink" title="Additional Things"></a>Additional Things</h3><h4 id="1、Going-further-with-Extensions"><a href="#1、Going-further-with-Extensions" class="headerlink" title="1、Going further with Extensions"></a>1、Going further with Extensions</h4><p>我们可以在某些类型上通过 Extensions 添加一些方法实现，比如在数组类型上添加一个 shuffles 方法，对数组内的元素进行随机排序</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">MutableCollectionType</span> <span class="title">where</span> <span class="title">Index</span> == <span class="title">Int</span> </span>&#123;</div><div class="line">  <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">shuffleInPlace</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">let</span> <span class="built_in">c</span> = <span class="keyword">self</span>.<span class="built_in">count</span></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..&lt;(<span class="built_in">c</span>-<span class="number">1</span>) &#123;</div><div class="line">      <span class="keyword">let</span> j = <span class="type">Int</span>(arc4random_uniform(<span class="type">UInt32</span>(<span class="built_in">c</span> - i))) + i</div><div class="line">      <span class="keyword">guard</span> i != j <span class="keyword">else</span> &#123; <span class="keyword">continue</span> &#125;</div><div class="line">      <span class="built_in">swap</span>(&amp;<span class="keyword">self</span>[i], &amp;<span class="keyword">self</span>[j])</div><div class="line">     &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>验证：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 因为数组遵循 MutableCollectionType 协议</span></div><div class="line"><span class="keyword">var</span> people = [<span class="string">"Chris"</span>, <span class="string">"Ray"</span>, <span class="string">"Sam"</span>, <span class="string">"Jake"</span>, <span class="string">"Charlie"</span>]</div><div class="line">people.shuffleInPlace()</div></pre></td></tr></table></figure>
<blockquote>
<p>Extending functionality to generic type parameters is only available to classes and protocols.</p>
</blockquote>
<h4 id="2、Using-defer"><a href="#2、Using-defer" class="headerlink" title="2、Using defer"></a>2、Using defer</h4><p>使用 <code>defer { ... }</code> 来确保 defer 紧跟的代码块在离开当前范围之前总是被执行，这里书上举了个 ATM 机的例子：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ATM</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> log = <span class="string">""</span></div><div class="line"></div><div class="line">  <span class="keyword">mutating</span> <span class="function"><span class="keyword">func</span> <span class="title">dispenseFunds</span><span class="params">(amount: Float,</span></span></div><div class="line">    <span class="keyword">inout</span> account: Account) <span class="keyword">throws</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">defer</span> &#123;</div><div class="line">      log += <span class="string">"Card for \(account.name) has been returned "</span> +</div><div class="line">        <span class="string">"to customer.\n"</span></div><div class="line">      ejectCard()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    log += <span class="string">"====================\n"</span></div><div class="line">    log += <span class="string">"Attempted to dispense \(amount) from "</span> +</div><div class="line">      <span class="string">"\(account.name)\n"</span></div><div class="line"></div><div class="line">    <span class="keyword">guard</span> account.locked == <span class="literal">false</span> <span class="keyword">else</span> &#123;</div><div class="line">      log += <span class="string">"Account Locked\n"</span></div><div class="line">      <span class="keyword">throw</span> <span class="type">ATMError</span>.<span class="type">AccountLocked</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">guard</span> account.balance &gt;= amount <span class="keyword">else</span> &#123;</div><div class="line">      log += <span class="string">"Insufficient Funds\n"</span></div><div class="line">      <span class="keyword">throw</span> <span class="type">ATMError</span>.<span class="type">InsufficientFunds</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    account.balance -= amount</div><div class="line">    log += <span class="string">"Dispensed \(amount) from \(account.name)."</span></div><div class="line">    log += <span class="string">" Remaining balance: \(account.balance)\n"</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">ejectCard</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// physically eject card</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 ATM 机这个例子中，多个地方会对账户和取钱金额进行检查，不合适就会出错退出，我们这里用 defer 来保证用户的卡一定会被退回，即 <code>ejectCard()</code> 方法一定会被执行</p>
<p>验证一个被锁定的帐号：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">do</span> &#123;</div><div class="line">  <span class="keyword">try</span> atm.dispenseFunds(<span class="number">200.00</span>, account: &amp;billsAccount)</div><div class="line">&#125; <span class="keyword">catch</span> <span class="keyword">let</span> error &#123;</div><div class="line">  <span class="built_in">print</span>(error)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然帐号被锁了，但卡还是退回来了</p>
<h4 id="3、Pattern-Matching"><a href="#3、Pattern-Matching" class="headerlink" title="3、Pattern Matching"></a>3、Pattern Matching</h4><p>在 swift 2.0 中 for…in 循环和 where 可以一起用</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> namesThatStartWithC = [<span class="type">String</span>]()</div><div class="line"></div><div class="line"><span class="keyword">for</span> cName <span class="keyword">in</span> names <span class="keyword">where</span> cName.hasPrefix(<span class="string">"C"</span>) &#123;</div><div class="line">    namesThatStartWithC.append(cName)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>for…in 和 case 结合同样可以用在枚举集合里了</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> totalDaysLate = <span class="number">0</span></div><div class="line"><span class="comment">// 遍历枚举集合，针对特定 case 过滤出</span></div><div class="line"><span class="keyword">for</span> <span class="keyword">case</span> <span class="keyword">let</span> .<span class="type">Late</span>(daysLate) <span class="keyword">in</span> authorStatuses &#123;</div><div class="line">    totalDaysLate += daysLate</div><div class="line">&#125;</div><div class="line">```swift</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">case</span> 可以直接用来判断某个枚举对象属于哪一分支，不用写<span class="keyword">switch</span>，更不用 <span class="keyword">default</span></div><div class="line"></div><div class="line">```swift</div><div class="line"><span class="keyword">var</span> slapLog = <span class="string">""</span></div><div class="line"><span class="keyword">for</span> author <span class="keyword">in</span> authors &#123;</div><div class="line">    <span class="keyword">if</span> <span class="keyword">case</span> .<span class="type">Late</span>(<span class="keyword">let</span> daysLate) = author.status <span class="keyword">where</span> daysLate &gt; <span class="number">2</span> &#123;</div><div class="line">        slapLog += <span class="string">"Ray slaps \(author.name) around a bit "</span> +</div><div class="line">        <span class="string">"with a large trout.\n"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4、Option-Sets"><a href="#4、Option-Sets" class="headerlink" title="4、Option Sets"></a>4、Option Sets</h4><p>你现在可以创建自己的 option set，其实就是创建一个遵循 OptionSetType 协议的结构体</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">RectangleBorderOptions</span>: <span class="title">OptionSetType</span> </span>&#123;</div><div class="line">  <span class="keyword">let</span> rawValue: <span class="type">Int</span></div><div class="line">  <span class="keyword">init</span>(rawValue: <span class="type">Int</span>) &#123; <span class="keyword">self</span>.rawValue = rawValue &#125;</div><div class="line">  <span class="keyword">static</span> <span class="keyword">let</span> <span class="type">Top</span> = <span class="type">RectangleBorderOptions</span>(rawValue: <span class="number">0</span>)</div><div class="line">  <span class="keyword">static</span> <span class="keyword">let</span> <span class="type">Right</span> = <span class="type">RectangleBorderOptions</span>(rawValue: <span class="number">1</span>)</div><div class="line">  <span class="keyword">static</span> <span class="keyword">let</span> <span class="type">Bottom</span> = <span class="type">RectangleBorderOptions</span>(rawValue: <span class="number">2</span>)</div><div class="line">  <span class="keyword">static</span> <span class="keyword">let</span> <span class="type">Left</span> = <span class="type">RectangleBorderOptions</span>(rawValue: <span class="number">3</span>)</div><div class="line">  <span class="keyword">static</span> <span class="keyword">let</span> <span class="type">All</span>: <span class="type">RectangleBorderOptions</span> =</div><div class="line">    [<span class="type">Top</span>, <span class="type">Right</span>, <span class="type">Bottom</span>, <span class="type">Left</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="5、OS-Availability"><a href="#5、OS-Availability" class="headerlink" title="5、OS Availability"></a>5、OS Availability</h4><p>swift 2.0 可以让编译器帮你检查系统版本了</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">guard</span> #available(iOS <span class="number">9.0</span>, *) <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line"><span class="comment">// do some iOS 9 or higher only thing</span></div></pre></td></tr></table></figure>
<hr>
<h2 id="Chapter-2-Introducing-App-Search"><a href="#Chapter-2-Introducing-App-Search" class="headerlink" title="Chapter 2: Introducing App Search"></a>Chapter 2: Introducing App Search</h2><h3 id="App-search-APIs"><a href="#App-search-APIs" class="headerlink" title="App search APIs"></a>App search APIs</h3><p>App search in iOS 9 包含 三 部分</p>
<p><strong>NSUserActivity</strong></p>
<p>在 iOS 8 中，我们使用 NSUserActivity 来延续 activity 从一台设备到另一台设备上。在 iOS 9 上这个特性同样用来增强搜索，理论上讲，如果一个任务可以被表现为一个 NSUserActivity 传递给不同设备，那么也可以被存储在 search index 中，稍后用在同一台设备中。这样可以让你索引 App 的 activities，states 和 navigation poits，允许用户稍后通过 Spotlight 直接来找到这些内容。</p>
<p>比如一个旅行 app 可能会索引用户查看过的 hotels，或者一个新闻 app 会索引用户浏览过的新闻</p>
<p><strong>Core Spotlight</strong></p>
<p>最常规的 APP Search 就是 Core Spotlight，iOS 自带的如股票应用，邮件、备忘录都可以通过他来索引，下面我们将让 App 更多的内容可以被索引</p>
<p>你可以将 Core Spotlight 看做是搜索信息的数据库，他提供了更细致的操作，比如哪些内容可以被索引。你可以索引各种格式的内容，从 videos 到 messages，包含更新和移除的</p>
<p>Core Spotlight 是搜索你应用内私有数据的最好方式</p>
<p><strong>Web markup</strong></p>
<p>专门针对那种 app 数据来自网站，比如 Amazon，你可以搜索数百万的产品。使用开放标准的 web 内容标记，你可以将其显示在 Spotlight，Safari search results，或者在 app 中生成深链接</p>
<h3 id="Getting-started"><a href="#Getting-started" class="headerlink" title="Getting started"></a>Getting started</h3><p>现在来看一个简单的应用 Colleagues，类似于一个雇员通讯录，我们下面使其可以在 Spotlight 中搜索应用内容</p>
<p><img src="/images/ibt1.jpg" alt="ibt1"></p>
<p>大概浏览下整个工程：</p>
<ul>
<li>Employee.swift 是雇员 model，数据来自一个本地的 json</li>
<li>EmployeeService.swift 和数据库打交道（这里是解析本地这个 json）提供一些查询、获取雇员等操作。这里还有两个 TODO Method，稍后我们会实现：</li>
</ul>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">EmployeeService</span> </span>&#123;</div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">indexAllEmployees</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// <span class="doctag">TODO:</span> Implement this</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">destroyEmployeeIndexing</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// <span class="doctag">TODO:</span> Implement this</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>工程加入了一个 Settings.bundle，允许我们在 iOS 系统中进行 App 的相关设置</p>
<p><img src="/images/ibt2.jpg" alt="ibt2"></p>
<h3 id="Searching-previously-viewed-records"><a href="#Searching-previously-viewed-records" class="headerlink" title="Searching previously viewed records"></a>Searching previously viewed records</h3><p>先来看下用 NSUserActivity 实现 App search，选择 NSUserActivity 的理由：</p>
<ul>
<li>它很简单，创建一个实例，设置几个属性。</li>
<li>当你使用 NSUserActivity 来标记用户活动（user activities），iOS 会为频繁访问的内容进行评级，这样搜索出来的结果也会区分优先级</li>
<li>如果需要支持 Handoff 只需一步之遥</li>
</ul>
<h4 id="1、Implement-NSUserActivity"><a href="#1、Implement-NSUserActivity" class="headerlink" title="1、Implement NSUserActivity"></a>1、Implement NSUserActivity</h4><p>创建一个 <code>new file</code> EmployeeSearch.swift 在下面扩展了 Employee，主要添加了 userActivity</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> CoreSpotlight</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Employee</span> </span>&#123;</div><div class="line">     <span class="comment">// 用来标识 NSUserActivity 类型</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> domainIdentifier = <span class="string">"com.raywenderlich.colleagues.employee"</span></div><div class="line">    <span class="comment">// 这个字典为你的 NSUserActivity 提供一个属性，用来标识 activity</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> userActivityUserInfo: [<span class="type">NSObject</span>: <span class="type">AnyObject</span>] &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="string">"id"</span>: objectId]</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">var</span> userActivity: <span class="type">NSUserActivity</span> &#123;</div><div class="line">        <span class="keyword">let</span> activity = <span class="type">NSUserActivity</span>(activityType: <span class="type">Employee</span>.domainIdentifier)</div><div class="line">        activity.title = name</div><div class="line">        activity.userInfo = userActivityUserInfo</div><div class="line">        activity.keywords = [email, department]</div><div class="line">         <span class="keyword">return</span> activity</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>挑主要的属性来说说：</p>
<ul>
<li>activityType: 稍后你会用这个标记 NSUserActivity 实例</li>
<li>title: 作为搜索结果的名字显示</li>
<li>userInfo: 该字典用来存储需要传递内容，比如说存储搜索结果，然后点按搜索结果跳转到 app 相应的内容。</li>
<li>keywords: 一组本地化的关键字，方便用户搜索时找到记录</li>
</ul>
<p>下面在 EmployeeViewController.swift 中设置 employee 的 userActivity 属性，这样每次点开一个 employee，都会记录在 NSUserActivity 里，至于具体的记录细节要根据 Setting 的设定来做决定</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> activity = employee.userActivity</div><div class="line"></div><div class="line"><span class="keyword">switch</span> <span class="type">Setting</span>.searchIndexingPreference &#123;</div><div class="line"><span class="keyword">case</span> .<span class="type">Disabled</span>:</div><div class="line">  activity.eligibleForSearch = <span class="literal">false</span></div><div class="line"><span class="keyword">case</span> .<span class="type">ViewedRecords</span>:</div><div class="line">  activity.eligibleForSearch = <span class="literal">true</span></div><div class="line">  activity.contentAttributeSet?.relatedUniqueIdentifier = <span class="literal">nil</span></div><div class="line"><span class="keyword">case</span> .<span class="type">AllRecords</span>:</div><div class="line">  activity.eligibleForSearch = <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">userActivity = activity</div></pre></td></tr></table></figure>
<p>eligibleForSearch 表示 activity 是否被加入设备的索引中。第二个的 <code>.ViewedRecords</code> 中的 <code>relatedUniqueIdentifier</code> 被设为 nil 是因为并没有对应的 Core Spotlight 来索引他，稍后在 Core Spotlight 章节中会重新设置</p>
<p><code>userActivity = activity</code> 表明要设置当前 EmployeeViewController 实例的 <code>userActivity</code> 属性为这个配置好的 activity。</p>
<blockquote>
<p>ViewController 的 userActivity 属性其实继承自 UIResponder</p>
</blockquote>
<p>最后，重写同样是继承自 UIResponder 的方法，确保当你选中 search 结果时能够得到必要的信息：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">updateUserActivityState</span><span class="params">(activity: NSUserActivity)</span></span>&#123;</div><div class="line">  activity.addUserInfoEntriesFromDictionary(employee.userActivityUserInfo)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 UIResponder 的生命周期里，系统会多次调用该方法，你所要做的就是保持 activity 始终为最新状态。在这种情况下，你只需要简单地提供包含 <code>employee&#39;s objectId</code> 的字典 <code>employee.userActivityUserInfo</code></p>
<blockquote>
<p>文档中说该方法是用来让子类更新指定的 user activity，通常使用 <code>addUserInfoEntriesFromDictionary:</code> 方法来添加一个 state 信息（表示 user’s activity）到当前 activity 对象中，其实就是从给定的字典中获取信息然后添加到 activity 的 userInfo 字典中。传递给 userInfo 的信息尽可能地要小，否则需要更多的时间来恢复。经过实际测试，系统索引也是需要时间的。</p>
<p>然后，当 state 发生变化时，你需要设置 NSUserActivity 的 needsSave 为 YES，然后 updateUserActivityState： 方法会在合适的时候被调用</p>
</blockquote>
<p>在 iOS 系统设置下，将 Colleagues 的索引设置为 Viewed Records ，然后运行 App，在 List 主界面中选择 Brent Reid ，按 Home 键退出，在系统搜索栏中输入 Brent Reid，Bingo！出来结果了</p>
<p><img src="/images/ibt3.jpg" alt="ibt3"></p>
<h4 id="2、Adding-more-information-to-search-results"><a href="#2、Adding-more-information-to-search-results" class="headerlink" title="2、Adding more information to search results"></a>2、Adding more information to search results</h4><p>现在搜索结果有点单调，NSUserActivity 提供了一个叫做 contentAttributeSet 的集合属性来允许你描述要显示的内容</p>
<p><img src="/images/ibt4.jpg" alt="ibt4"></p>
<p>你已经设置了 title，下面来补充 thumbnailData, supportsPhoneCall, contentDescription</p>
<p>还是在 EmployeeSearch.swift 下面增加一个计算属性 <code>attributeSet</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">var</span> attributeSet: <span class="type">CSSearchableItemAttributeSet</span> &#123;</div><div class="line">    <span class="comment">// kUTTypeContact 表示联系人信息</span></div><div class="line">    <span class="keyword">let</span> attributeSet = <span class="type">CSSearchableItemAttributeSet</span>(itemContentType: kUTTypeContact <span class="keyword">as</span> <span class="type">String</span>)</div><div class="line">    attributeSet.title = name</div><div class="line">    attributeSet.contentDescription = <span class="string">"\(department), \(title)\n\(phone)"</span></div><div class="line">    attributeSet.thumbnailData = <span class="type">UIImageJPEGRepresentation</span>(loadPicture(), <span class="number">0.9</span>)</div><div class="line"></div><div class="line">    <span class="comment">// 为了让电话按钮显示，你必须设置 supportsPhoneCall 为 true 然后提供一个电话号码</span></div><div class="line">    attributeSet.supportsPhoneCall = <span class="literal">true</span></div><div class="line">    attributeSet.phoneNumbers = [phone]</div><div class="line">    attributeSet.emailAddresses = [email]</div><div class="line">    attributeSet.keywords = skills</div><div class="line"></div><div class="line">    <span class="keyword">return</span> attributeSet</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有了这些细节， Core Spotlight 将会索引每一个然后显示在搜索结果中，也意味着现在可以通过：名字，部门，电话号码，甚至技能来搜索职员了。</p>
<p><img src="/images/ibt5.jpg" alt="ibt5"></p>
<p>不过现在还不能点击搜索结果跳转到相应的职员界面，我们下面来实现</p>
<h4 id="3、Opening-search-results"><a href="#3、Opening-search-results" class="headerlink" title="3、Opening search results"></a>3、Opening search results</h4><p>前面已经为 <code>NSUserActivity</code> 实例设置了 activityType 和 userInfo 对象，打开 AppDelegate.swift 加入下面方法，告诉 delegate 相关的 data 要持续可用。当用户选择搜索结果时，该方法会被调用：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(application: UIApplication,</span></span></div><div class="line">    continueUserActivity userActivity: NSUserActivity,</div><div class="line">     restorationHandler: <span class="params">([AnyObject]?)</span> -&gt; <span class="type">Void</span>) -&gt; <span class="type">Bool</span> &#123;</div><div class="line">     <span class="comment">// 验证然后找出 objectId</span></div><div class="line">     <span class="keyword">guard</span> userActivity.activityType == <span class="type">Employee</span>.domainIdentifier,</div><div class="line">         <span class="keyword">let</span> objectId = userActivity.userInfo?[<span class="string">"id"</span>] <span class="keyword">as</span>? <span class="type">String</span> <span class="keyword">else</span> &#123;</div><div class="line">         <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line">     <span class="comment">// 设置 employeeViewController 然后压入 navigationController</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> nav = window?.rootViewController <span class="keyword">as</span>? <span class="type">UINavigationController</span>,</div><div class="line">         listVC = nav.viewControllers.first <span class="keyword">as</span>? <span class="type">EmployeeListViewController</span>,</div><div class="line">         employee = <span class="type">EmployeeService</span>().employeeWithObjectId(objectId) &#123;</div><div class="line"></div><div class="line">             nav.popToRootViewControllerAnimated(<span class="literal">false</span>)</div><div class="line"></div><div class="line">             <span class="keyword">let</span> employeeViewController = listVC.storyboard?</div><div class="line">                 .instantiateViewControllerWithIdentifier(<span class="string">"EmployeeView"</span>)</div><div class="line">                 <span class="keyword">as</span>! <span class="type">EmployeeViewController</span></div><div class="line"></div><div class="line">             employeeViewController.employee = employee</div><div class="line">             nav.pushViewController(employeeViewController, animated: <span class="literal">false</span>)</div><div class="line">             <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在点击搜索结果可以直接跳转到相应的职员页面了。</p>
<h3 id="Indexing-with-Core-Spotlight"><a href="#Indexing-with-Core-Spotlight" class="headerlink" title="Indexing with Core Spotlight"></a>Indexing with Core Spotlight</h3><p>前面我们先学习 NSUserActivity，只是因为简单，现在我们使用 Core Spotlight 来索引全部数据。</p>
<p>在 EmployeeSearch.swift 中添加：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">attributeSet.relatedUniqueIdentifier = objectId</div></pre></td></tr></table></figure>
<p>这条命令会在 NSUserActivity 和 Core Spotlight 索引对象之间建立某种联系，如果你不做这一步，搜索时会得到重复的结果。</p>
<p>接着创建 <code>CSSearchableItem</code> 对象，表示 Core Spotlight 将要索引的对象：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> searchableItem: <span class="type">CSSearchableItem</span> &#123;</div><div class="line">    <span class="keyword">let</span> item = <span class="type">CSSearchableItem</span>(uniqueIdentifier: objectId,</div><div class="line">                                domainIdentifier: <span class="type">Employee</span>.domainIdentifier,</div><div class="line">                                    attributeSet: attributeSet)</div><div class="line">    <span class="keyword">return</span> item</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为我们之前就已经设置了 attributeSet，所以这里就很简单了。</p>
<p>打开 EmployeeService.swift 并 <code>import CoreSpotlight</code>，现在我们来实现 <code>indexAllEmployees()</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">indexAllEmployees</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 1. 从数据库中提取所有的 employee 存放到 employees 数组中</span></div><div class="line">    <span class="keyword">let</span> employees = fetchEmployees()</div><div class="line">    <span class="comment">// 2. map 遍历为 [CSSearchableItem] 数组</span></div><div class="line">    <span class="keyword">let</span> searchableItems = employees.<span class="built_in">map</span> &#123; $<span class="number">0</span>.searchableItem &#125;</div><div class="line"></div><div class="line">    <span class="type">CSSearchableIndex</span>.defaultSearchableIndex()</div><div class="line">    <span class="comment">// 3. 使用 Core Spotlight 的默认索引，将 searchableItems 数组添加到索引中</span></div><div class="line">         .indexSearchableItems(searchableItems) &#123; error <span class="keyword">in</span></div><div class="line">        <span class="comment">// 4. completionHandler</span></div><div class="line">             <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</div><div class="line">                 <span class="built_in">print</span>(<span class="string">"Error indexing employees: \(error)"</span>)</div><div class="line">             &#125; <span class="keyword">else</span> &#123;</div><div class="line">                 <span class="built_in">print</span>(<span class="string">"Employees indexed."</span>)</div><div class="line">         &#125;</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，已经可以所以全部记录了，在设置中将 Indexing 切换为 All Records，运行，搜索：</p>
<p><img src="/images/ibt6.jpg" alt="ibt6"></p>
<h4 id="Make-the-results-do-something"><a href="#Make-the-results-do-something" class="headerlink" title="Make the results do something"></a>Make the results do something</h4><p>和之前用 NSUserActivity 遇到的问题一样，点击搜索结果并不能跳转到对应的页面，还是到 AppDelegate.swift 里来修正一下：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> CoreSpotlight</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(application: UIApplication, continueUserActivity userActivity: NSUserActivity, restorationHandler: <span class="params">([AnyObject]?)</span></span></span> -&gt; <span class="type">Void</span>) -&gt; <span class="type">Bool</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">let</span> objectId: <span class="type">String</span></div><div class="line">    <span class="comment">// 如果是由 NSUserActivity 索引的，activityType 应该是 reverse-DNS</span></div><div class="line">    <span class="keyword">if</span> userActivity.activityType == <span class="type">Employee</span>.domainIdentifier, <span class="keyword">let</span> activityObjectId = userActivity.userInfo?[<span class="string">"id"</span>] <span class="keyword">as</span>? <span class="type">String</span> &#123;</div><div class="line">      objectId = activityObjectId</div><div class="line">    <span class="comment">// 如果是 Core Spotlight 索引的，activityType 是 CSSearchableItemActionType</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> userActivity.activityType == <span class="type">CSSearchableItemActionType</span>, <span class="keyword">let</span> activityObjectId = userActivity.userInfo?[<span class="type">CSSearchableItemActivityIdentifier</span>] <span class="keyword">as</span>? <span class="type">String</span> &#123;</div><div class="line">      objectId = activityObjectId</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> nav = window?.rootViewController <span class="keyword">as</span>? <span class="type">UINavigationController</span>, listVC = nav.viewControllers.first <span class="keyword">as</span>? <span class="type">EmployeeListViewController</span>, employee = <span class="type">EmployeeService</span>().employeeWithObjectId(objectId) &#123;</div><div class="line"></div><div class="line">      nav.popToRootViewControllerAnimated(<span class="literal">false</span>)</div><div class="line"></div><div class="line">      <span class="keyword">let</span> employeeViewController = listVC.storyboard?.instantiateViewControllerWithIdentifier(<span class="string">"EmployeeView"</span>) <span class="keyword">as</span>! <span class="type">EmployeeViewController</span></div><div class="line"></div><div class="line">      employeeViewController.employee = employee</div><div class="line">      nav.pushViewController(employeeViewController, animated: <span class="literal">false</span>)</div><div class="line">      <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h4 id="Deleting-items-from-the-search-index"><a href="#Deleting-items-from-the-search-index" class="headerlink" title="Deleting items from the search index"></a>Deleting items from the search index</h4><p>如果职员被老板开除了，我们删除职员信息的同时记得也要删除索引，这里可以简单的删除所有索引：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="type">CSSearchableIndex</span></div><div class="line">    .defaultSearchableIndex()</div><div class="line">    .deleteAllSearchableItemsWithCompletionHandler &#123; error <span class="keyword">in</span></div><div class="line"></div><div class="line">     <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</div><div class="line">         <span class="built_in">print</span>(<span class="string">"Error deleting searching employee items: \(error)"</span>)</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         <span class="built_in">print</span>(<span class="string">"Employees indexing deleted."</span>)</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>去系统设置里，将 Indexing 设置为 Disabled，运行观察下效果</p>
<p>除了全部删除我们还可以按组删除和按具体的 item 删除：</p>
<ul>
<li>按组删除 <code>deleteSearchableItemsWithDomainIdentifiers(_:completionHandler:)</code></li>
<li>按具体 item 删除 <code>deleteSearchableItemsWithIdentifiers(_:completionHandler:)</code></li>
</ul>
<p>最后要注意是保持 indexes 更新，使用之前介绍的方法来更新要索引的 items</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">indexSearchableItems(<span class="number">_</span>:completionHandler:)</div></pre></td></tr></table></figure>
<h3 id="Private-vs-public-indexing"><a href="#Private-vs-public-indexing" class="headerlink" title="Private vs. public indexing"></a>Private vs. public indexing</h3><p>默认的所有 Core Spotlight 索引的内容都是私有的，但你可以标记 NSUserActivity 的属性 eligibleForPublicIndexing 为 true，将其设置为 public。这样就能使内容成为 Apple cloud 索引的一部分。</p>
<p>另外一种使内容公开索引的方式是使用 web 标记，下章介绍。</p>
<h3 id="Advanced-features"><a href="#Advanced-features" class="headerlink" title="Advanced features"></a>Advanced features</h3><p>Core Spotlight 框架也提供了几个高级特性</p>
<h4 id="1、Core-Spotlight-App-Extensions"><a href="#1、Core-Spotlight-App-Extensions" class="headerlink" title="1、Core Spotlight App Extensions"></a>1、Core Spotlight App Extensions</h4><p>Core Spotlight app extension 可以在程序不运行的情况下也能对索引进行维护</p>
<p>Spotlight index extensions 包含一个 CSIndexExtensionRequestHandler 子类（遵循 CSSearchableIndexDelegate 协议）遵循两个方法：</p>
<ul>
<li><code>searchableIndex(_: reindexAllSearchableItemsWithAcknowledgementHandler:)</code></li>
<li><code>searchableIndex(_: reindexSearchableItemsWithIdentifiers:
acknowledgementHandler:)</code></li>
</ul>
<h4 id="2、Batch-indexing"><a href="#2、Batch-indexing" class="headerlink" title="2、Batch indexing"></a>2、Batch indexing</h4><p>Core Spotlight 也支持批量更新，这种情况不能使用 defaultSearchableIndex，你需要创建你自己的 CSSearchableIndex 实例</p>
<ul>
<li>创建 CSSearchableIndex.</li>
<li>标记开始更新 beginIndexBatch()</li>
<li>获取最近更新 fetchLastClientStateWithCompletionHandler()</li>
<li>准备下一次更新的 CSSearchableItem 对象用来索引</li>
<li>使用 indexSearchableItems(_:completionHandler:) 用来索引</li>
<li>结束更新 endIndexBatchWithClientState()</li>
</ul>
<hr>
<h2 id="Chapter-3：Your-App-on-the-Web"><a href="#Chapter-3：Your-App-on-the-Web" class="headerlink" title="Chapter 3：Your App on the Web"></a>Chapter 3：Your App on the Web</h2><p>iOS 9 用 universal links 和 web markup 让二者走的更近，他让你提供直接进入你 app 的 deep link，以及可以展示在 Spotlight 和 Safari 搜索框中的 web 内容</p>
<h3 id="Linking-to-your-app"><a href="#Linking-to-your-app" class="headerlink" title="Linking to your app"></a>Linking to your app</h3><p>前面已经熟悉了 deep links，本节介绍一种新技术，开始前，再来回顾下 Deep links</p>
<h4 id="Deep-links"><a href="#Deep-links" class="headerlink" title="Deep links"></a>Deep links</h4><p>在 iOS 9 之前，Apps 之间通讯的方式主要是通过注册自定义的 url scheme（在 Info.plist 中使用 CFBundleURLTypes key ）</p>
<p>例如你的一个社交类 App 注册了自定义的 <code>clownapp://</code> 或 <code>clown://</code>，此时你就能从其他地方构造 <code>clownapp://home/feed</code> 这样的结构，一旦链接被打开，iOS 会打开你的 app 并通过 URL 传递一个 URL（通过 <code>application(_:handleOpenURL:)</code>）此时，你的 app 就可以对这个 URL 做出解释，并做出相应的回应</p>
<p>Apple 从 iOS 3.0 就开始这么做了，随着时间的推移，也产生了一些问题，这么做有如下缺点：</p>
<ul>
<li>隐私： <code>canOpenURL(_:)</code> 这个方法可用来收集已安装应用程序列表</li>
<li>冲突：如果存在同名的 custom URL scheme 就会有冲突</li>
<li>No fallback：如果 iOS 试图打开没有注册的 URL scheme，会静默失败</li>
</ul>
<p>幸运的是 iOS 9 使用 universal links 解决了这些问题。universal links 使用 基础的 HTTP 和 HTTPS links</p>
<h4 id="Universal-links"><a href="#Universal-links" class="headerlink" title="Universal links"></a>Universal links</h4><p>你可以将 <code>http://clownapp.com/clowns/*</code> 注册为唯一的 app link，如果用户安装了你的 app，然后在 Safari 或 web 上点击了 <code>http://clownapp.com/clowns/fizbo</code> 这个链接，就会跳转到你的 APP 的 Fizbo 的用户界面上，如果没装你的 App，那么 iOS 会跳转到 App 的主页上。你会发现和使用 <code>openURL(_:)</code> 基本上没有区别</p>
<p>Universal links 相对 deep links 有如下优势：</p>
<p>唯一</p>
<ul>
<li>安全：将你的域名与 App 绑定，你要上传一个安全签名文件到 web 服务器上，这样其他的 App 就无法查询你的 App 是否被安装了</li>
<li>简单：universal link 其实就是个简单的 Http 链接，即使用户没装你的 App，或不是 iOS 9 也能通过浏览器打开</li>
</ul>
<h4 id="Registering-your-app-to-handle-universal-links"><a href="#Registering-your-app-to-handle-universal-links" class="headerlink" title="Registering your app to handle universal links"></a>Registering your app to handle universal links</h4><p>为了将 website 和 app 绑定，并且证明这就是你的 website，这里会有两种绑定：</p>
<ul>
<li>你要告诉你的 app 关于你的域名信息</li>
<li>你要告诉你的域名关于你 app 的信息</li>
</ul>
<p>在此之后，你只需要简单地在 app 中添加一些代码来处理即将到来的链接就好</p>
<p>让你的 APP 了解关于你域名的信息通常在 Capabilities tab 下的 Associated Domains 添加相关域名</p>
<p><img src="/images/ibt7.jpg" alt="ibt7"></p>
<p>这会告诉你的 app 将要响应的域名，确保域名以 <code>applinks</code> 开头（只有team agent 或 a team administrator 才能打开 Associated Domains）</p>
<h4 id="Registering-your-server-to-handle-universal-links"><a href="#Registering-your-server-to-handle-universal-links" class="headerlink" title="Registering your server to handle universal links"></a>Registering your server to handle universal links</h4><p>接下来创建一个从 website 到 app 的连接，你可以在你的 website 上放置一个 JSON 文件，如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"applinks"</span>: &#123;</div><div class="line">        <span class="attr">"apps"</span>: [],</div><div class="line">        <span class="attr">"details"</span>: [</div><div class="line">            &#123;</div><div class="line">               <span class="attr">"appID"</span>: <span class="string">"KFCNEC27GU.com.razeware.RWDevCon"</span>,</div><div class="line">                <span class="attr">"paths"</span>: [</div><div class="line">                <span class="string">"/videos/*"</span></div><div class="line">                ]</div><div class="line">            &#125;</div><div class="line">        ]</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>在服务器上放置一个包含 app 信息的 json，名字必须是 apple-app-site-association，且不能带扩展名，json 也不行。apple-app-site-association 之前被用在 iOS 8 上来实现 web 和 app 之间的 Handoff</p>
</blockquote>
<p>这个 <code>applinks</code> 部分决定了哪些 apps 可以处理 website 上特定的 <code>URL paths</code>，而 details 部分包含了一个字典：</p>
<ul>
<li>appID 由 teamID + bundleID 组成</li>
<li>Paths 数组包含了一个你的 app 应该处理的 URLs 白名单，这个 paths 数组还支持 基本的模式匹配，例如 <em>，？ 等，如 /videos/ </em>/year/201?/videoName</li>
</ul>
<p>一旦这个 Json 文件准备完毕，你必须上传到 website 的根目录下才能正常工作，而且不能有任何的重定向，而且必须可以通过 Https 访问到</p>
<p>这里还有额外的两点需要考虑下：</p>
<ol>
<li>由于 Handoff 等特性要照顾 iOS 8，那么可以使用 openssl 来对 apple-app-site- association 进行签名 <a href="https://developer.apple.com/library/ios/documentation/UserExperience/Conceptual/Handoff/AdoptingHandoff/AdoptingHandoff.html" target="_blank" rel="external">链接</a></li>
<li>上传之前先检查下 Json 文件有无语法错误</li>
</ol>
<h4 id="Handling-universal-links-in-your-app"><a href="#Handling-universal-links-in-your-app" class="headerlink" title="Handling universal links in your app"></a>Handling universal links in your app</h4><p>你的 App 接收到 universal link，你需要做出针对性的回应，简单说就是解析 URL，决定哪些内容需要显示，然后导航到相关的界面上。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">sessionByWebPath</span>(<span class="title">path</span>: <span class="title">String</span>,</span></div><div class="line">  <span class="title">context</span>: <span class="title">NSManagedObjectContext</span>) -&gt; <span class="title">Session</span>? &#123;</div><div class="line">  <span class="keyword">let</span> fetch = <span class="type">NSFetchRequest</span>(entityName: <span class="string">"Session"</span>)</div><div class="line">  fetch.predicate =</div><div class="line">    <span class="type">NSPredicate</span>(format: <span class="string">"webPath = %@"</span>, path)</div><div class="line">  <span class="keyword">do</span> &#123;</div><div class="line">    <span class="keyword">let</span> results = <span class="keyword">try</span> context.executeFetchRequest(fetch)</div><div class="line">    <span class="keyword">return</span> results.first <span class="keyword">as</span>? <span class="type">Session</span></div><div class="line">  &#125; <span class="keyword">catch</span> <span class="keyword">let</span> fetchError <span class="keyword">as</span> <span class="type">NSError</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"fetch error: \(fetchError.localizedDescription)"</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Session 类有个 webPath 的属性，包含着 <code>rwdevcon.com</code> 上 <code>video</code> 页面的 <code>path</code>。这个方法找出与 path 相匹配的 Session 对象</p>
<p>接着写一个 help 方法，接受一个 video URL ，然后在 UINavigationController 上嵌入一个 AVPlayerViewController 进行播放</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">presentVideoViewController</span><span class="params">(URL: NSURL)</span></span> &#123;</div><div class="line">  <span class="keyword">let</span> storyboard = <span class="type">UIStoryboard</span>(name: <span class="string">"Main"</span>, bundle: <span class="literal">nil</span>)</div><div class="line">  <span class="keyword">let</span> navID = <span class="string">"NavPlayerViewController"</span></div><div class="line">  <span class="keyword">let</span> navVideoPlayerVC =</div><div class="line">    storyboard.instantiateViewControllerWithIdentifier(navID)</div><div class="line">    <span class="keyword">as</span>! <span class="type">UINavigationController</span></div><div class="line">  navVideoPlayerVC.modalPresentationStyle = .<span class="type">FormSheet</span></div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> videoPlayerVC = navVideoPlayerVC.topViewController</div><div class="line">    <span class="keyword">as</span>? <span class="type">AVPlayerViewController</span> &#123;</div><div class="line">    videoPlayerVC.player = <span class="type">AVPlayer</span>(<span class="type">URL</span>: <span class="type">URL</span>)</div><div class="line">    <span class="keyword">let</span> rootViewController = window?.rootViewController</div><div class="line">    rootViewController?.presentViewController(</div><div class="line">      navVideoPlayerVC, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后实现如下 <code>UIApplicationDelegate</code> 方法，当有来自于注册过的 universal HTTP link call 就会自动被 iOS 调用</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(application: UIApplication,</span></span></div><div class="line">  continueUserActivity</div><div class="line">  userActivity: NSUserActivity,</div><div class="line">  restorationHandler: <span class="params">([AnyObject]?)</span> -&gt; <span class="type">Void</span>) -&gt; <span class="type">Bool</span> &#123;</div><div class="line"><span class="comment">//1 系统用 NSUserActivityTypeBrowsingWeb 表示对应的 universal HTTP links</span></div><div class="line">  <span class="keyword">if</span> userActivity.activityType ==</div><div class="line">    <span class="type">NSUserActivityTypeBrowsingWeb</span> &#123;</div><div class="line">    <span class="keyword">let</span> universalURL = userActivity.webpageURL!</div><div class="line"><span class="comment">//2 提取出 url 的不同部分</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> components = <span class="type">NSURLComponents</span>(<span class="type">URL</span>: universalURL,</div><div class="line">      resolvingAgainstBaseURL: <span class="literal">true</span>),</div><div class="line">      <span class="keyword">let</span> path = components.path &#123;</div><div class="line">      <span class="keyword">if</span> <span class="keyword">let</span> session = <span class="type">Session</span>.sessionByWebPath(path,</div><div class="line">        context: coreDataStack.context) &#123;</div><div class="line">        <span class="comment">//3 找到 session，然后播放 video</span></div><div class="line">        <span class="keyword">let</span> videoURL = <span class="type">NSURL</span>(string: session.videoUrl)!</div><div class="line">        presentVideoViewController(videoURL)</div><div class="line">        <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="comment">//4 无法理解就打开网站首页</span></div><div class="line">        <span class="keyword">let</span> app = <span class="type">UIApplication</span>.sharedApplication()</div><div class="line">        <span class="keyword">let</span> url =</div><div class="line">          <span class="type">NSURL</span>(string: <span class="string">"http://www.rwdevcon.com"</span>)!</div><div class="line">        app.openURL(url)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p><code>application(_:continueUserActivity:restorationHandler:)</code> 也被用做 iOS 8 的 Handoff，之前的 App Search 我们也用到了这个方法</p>
</blockquote>
<p>现在在你的设备上，打开邮件客户端，如果里面有这些链接：</p>
<p><img src="/images/ibt8.jpg" alt="ibt8"></p>
<p>点击第一个，就会打开 app 播放相关视频</p>
<p>而点击第二个则会用 Safari 打开网站主页</p>
<p><img src="/images/ibt9.jpg" alt="ibt9"></p>
<blockquote>
<p>注意到顶部 banner 下的东东了吗？那叫做 Smart App Banner，稍后会提到</p>
</blockquote>
<p>The RWDevCon app 干净利落地处理了他能够识别的 universal links，不能识别的则用 Safari 来打开。除了通过链接来触发，你还可以通过直接载入一个 URL，一个 WKWebView，一个 UIWebView 或使用 openURL(_:) 来触发你的 App 来处理 universal link。</p>
<h3 id="Working-with-web-markup"><a href="#Working-with-web-markup" class="headerlink" title="Working with web markup"></a>Working with web markup</h3><p>Search 包含三种不同的 API：NSUserActivity，CoreSpotlight，web markup。前两种已经介绍过了，现在来看第三种。</p>
<p>你可以使用 web markup 在搜索结果中得到你 app 应用里面的内容。如果你有一个网站，内容与 APP 的内容一致，你可以使用基本的 markup、Smart App Banners、universal links 来标记你的 web pages。</p>
<p>优化你的网站标记，苹果会派机器人去爬你的网站，即使用户没有安装应用，也能搜索相关内容。</p>
<h4 id="Making-your-website-discoverable"><a href="#Making-your-website-discoverable" class="headerlink" title="Making your website discoverable"></a>Making your website discoverable</h4><p>苹果爬虫不保证什么时候会去爬你的网站，但你可以做下面的事情来保证网站更容易被发现：</p>
<ol>
<li>iTunes Connect 中设置 Support URL 和 Marketing URL 为包含 web markup 的域名</li>
<li>确保这些域名可以访问到你的 web markup</li>
<li>检查 robots.txt，确保苹果的爬虫可以正常工作</li>
</ol>
<h4 id="Embedding-universal-links-using-Smart-App-Banners"><a href="#Embedding-universal-links-using-Smart-App-Banners" class="headerlink" title="Embedding universal links using Smart App Banners"></a>Embedding universal links using Smart App Banners</h4><p>一旦苹果的爬虫找到并索引了你的 website，Apple 建议添加 Smart App Banners 到你的网站的索引中</p>
<p>Smart App Banners 最早出现在 iOS 6，他啊可以在网页顶部显示一个 banner，推广你的 App，对于已经安装 App 的用户，这个 banner 可以很容易地提供一个前往 App 指定界面的 deep link</p>
<blockquote>
<p>如果 iOS 检测到 APP 已安装，banner 会变成 OPEN，否则会显示 View，点击会跳转到 App Store</p>
</blockquote>
<p>现在到网站的 Video 目录下，用文本编辑器打开 <code>talk-ray-wenderlich- teamwork.html</code>，添加：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"apple-itunes-app"</span> <span class="attr">content</span>=<span class="string">"app-id=958625272, app-</span></span></div><div class="line">argument=http://www.rwdevcon.com/videos/talk-ray-wenderlich-</div><div class="line">teamwork.html"&gt;</div></pre></td></tr></table></figure>
<p>属性 name 一定要是 <code>apple-itunes-app</code>，这个类型的标记代表 Smart App Banner tag，反过来会告诉 Safari 显示 Smart App Banner</p>
<p>内容属性包含两个重要的参数：</p>
<ul>
<li>app-id：对应着你 App 的 Apple ID，不同于 登录 iCloud 的 Apple ID，这个 ID 是唯一的一串 number，所有 App Store 上的应用都有着唯一的 ID</li>
<li>app-argument：包含跳转回 App 的 URL，iOS 9 之前这个参数是自定义的 URL scheme deep link，现在 Apple 推荐使用 HTTP/HTTPS universal links</li>
</ul>
<blockquote>
<p>Smart App Banners 仅仅支持 Safari</p>
</blockquote>
<p>Applebot 仅仅支持两种方式的 mobile links：Twitter Cards 和 Facebook App Links</p>
<p>使用了 Twitter Cards：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"twitter:app:name:iphone"</span> <span class="attr">content</span>=<span class="string">"RWDevCon"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"twitter:app:id:iphone"</span> <span class="attr">content</span>=<span class="string">"958625272"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"twitter:app:url:iphone"</span> <span class="attr">content</span>=<span class="string">"http://www.rwdevcon.com/</span></span></div><div class="line">videos/talk-ray-wenderlich-teamwork.html"&gt;</div></pre></td></tr></table></figure>
<p>使用了 Facebook’s App Links：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"al:ios:app_name"</span> <span class="attr">content</span>=<span class="string">"RWDevCon"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"al:ios:app_store_id"</span> <span class="attr">content</span>=<span class="string">"958625272"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"al:ios:url"</span> <span class="attr">content</span>=<span class="string">"http://www.rwdevcon.com/videos/talk-</span></span></div><div class="line">ray-wenderlich-teamwork.html"&gt;</div></pre></td></tr></table></figure>
<p>现在打开 Safari，输入 <a href="http://www.rwdevcon.com/videos/talk-jake-gundersen-" target="_blank" rel="external">http://www.rwdevcon.com/videos/talk-jake-gundersen-</a> opportunity.html.</p>
<p>你会发现 Smart App Banner 与之前的不太一样，变得更窄了，而且按钮变成了 OPEN，这种特殊的 banner 仅仅会 URL 匹配时才会展示。在其他未匹配状态，banner 还是会变成正常尺寸</p>
<blockquote>
<p>点击这个 Smart App Banner，Safari 会打开 App 然后播放相关 video，前面的 <code>application(_:continueUserActivity:restorationHandler:)</code>方法中已经实现了这一功能</p>
</blockquote>
<h4 id="Semantic-markup-using-Open-Graph"><a href="#Semantic-markup-using-Open-Graph" class="headerlink" title="Semantic markup using Open Graph"></a>Semantic markup using Open Graph</h4><p>苹果爬虫爬到你的内容并不保证会显示在 Spotlight 的搜索结果中，因为他还会和其他搜索结果内容进行竞争。</p>
<p>Apple 并没有公布具体的评级算法，只是确保你的内容会被考虑。而当用户明显地点击或搜索结果与你的内容高度相关，那么就会优先被 Apple 考虑。</p>
<p>最后，Apple 建议为 markup 添加一些结构化的数据，来使其更好地以富文本的形式显示在 Spotlight 中。在 <code>/videos/talk-ray-wenderlich-teamwork.html</code> 上添加下面代码：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:image"</span> <span class="attr">content</span>=<span class="string">"http://www.rwdevcon.com/assets/images/</span></span></div><div class="line">videos/talk-ray-wenderlich-teamwork.jpg" /&gt;</div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:image:secure_url"</span> <span class="attr">content</span>=<span class="string">"https://www.rwdevcon.com/</span></span></div><div class="line">assets/images/videos/talk-ray-wenderlich-teamwork.jpg" /&gt;</div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:image:type"</span> <span class="attr">content</span>=<span class="string">"image/jpeg"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:image:width"</span> <span class="attr">content</span>=<span class="string">"640"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:image:height"</span> <span class="attr">content</span>=<span class="string">"340"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:video"</span> <span class="attr">content</span>=<span class="string">"http://www.rwdevcon.com/videos/Ray-</span></span></div><div class="line">Wenderlich-Teamwork.mp4" /&gt;</div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:video:secure_url"</span> <span class="attr">content</span>=<span class="string">"https://www.rwdevcon.com/</span></span></div><div class="line">videos/Ray-Wenderlich-Teamwork.mp4" /&gt;</div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:video:type"</span> <span class="attr">content</span>=<span class="string">"video/mp4"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:video:width"</span> <span class="attr">content</span>=<span class="string">"1280"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:video:height"</span> <span class="attr">content</span>=<span class="string">"720"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">property</span>=<span class="string">"og:description"</span> <span class="attr">content</span>=<span class="string">"Learn how teamwork lets you</span></span></div><div class="line">dream bigger, through the story of an indie iPhone developer who almost</div><div class="line">missed out on the greatest opportunity of his life." /&gt;</div></pre></td></tr></table></figure>
<p>这将会使爬虫更好地查找和处理信息，og 代表 Open Graph</p>
<blockquote>
<p>Open Graph 协议可以让网页成为一个“富媒体对象”。用了 Meta Property = og 标签，就是你同意了网页内容可以被其他社会化网站引用等，目前这种协议被 Fackbook 等 SNS 网站所采用。</p>
</blockquote>
<p>在你的网站上添加 rich markup 主要目的在于：装饰 Spotlight 的搜索结果，使其展示更多的信息</p>
<p><img src="/images/ibt10.jpg" alt="ibt10"></p>
<p>注意 YouTube 是能够获取这些『富文本标记』</p>
<h4 id="Validating-your-markup"><a href="#Validating-your-markup" class="headerlink" title="Validating your markup"></a>Validating your markup</h4><p>你在网站上都做好了 markup 标记，下一步验证是否能被 Apple 正确的支持也很简单。Apple 提供了在线 <a href="https://search.developer.apple.com/appsearch-validation-tool" target="_blank" rel="external">验证工具</a></p>
<hr>
<h2 id="Chapter-4：App-Thinning"><a href="#Chapter-4：App-Thinning" class="headerlink" title="Chapter 4：App Thinning"></a>Chapter 4：App Thinning</h2><p>Apple 已经推出了很多种尺寸的 iPhone 了，从 iOS 方面，苹果也一直努力地消除这种硬件多元化给开发者带来的困扰，如 iOS 8 推出了 <code>Adaptive Layout</code>, <code>Trait Collections</code>, <code>Universal split view controllers</code>，从此你不再需要为某个特定的设备开发独占 App，而是开发一个通用 App 适配所有设备。</p>
<p>然而这也带来一些挑战，因为要包含所有设备的资源文件，这个通用的 App 所占空间容量都比较大。所以 iOS 9 拿出了新的解决方案：</p>
<ul>
<li>App Slicing 当你将 iOS 9 打包的二进制文件提交到 App Store，Apple 会编译然后为每个特定的设备单独形成一个可执行文件，这样设备真正从商店下载的时候，只会根据特定的设备来下载安装，削减了尺寸。</li>
<li>On Demand Resources 应用资源可以在仅被需要时才下载</li>
<li>Bitcode bitcode是被编译程序的一种中间形式的代码。包含bitcode配置的程序将会在App store上被编译和链接。bitcode允许苹果在后期重新优化我们程序的二进制文件，而不需要我们重新提交一个新的版本到App store上。</li>
</ul>
<p>以上这三种技术加起来被称为 App Thinning</p>
<h3 id="Measuring-your-work"><a href="#Measuring-your-work" class="headerlink" title="Measuring your work"></a>Measuring your work</h3><p>我们可以通过这种方式来对 App 瘦身过程进行量化</p>
<p><img src="/images/ibt11.jpg" alt="ibt11"></p>
<h4 id="Slicing-up-app-slicing"><a href="#Slicing-up-app-slicing" class="headerlink" title="Slicing up app slicing"></a>Slicing up app slicing</h4><p>App slicing 可分为两部分：<code>executable slicing</code> 和 <code>resource slicing</code>。Executable slicing 就是 Apple 将根据不同的设备安装特定的 App，你不需要做太多事情，Apple 已经为你做好了一切。</p>
<p>Being smart with resources<br>Resource slicing 要求你做的事情也很简单，将所有的资源文件放到 Asset Catalogs 下，并且按照相关特性进行组织，从 Xcode 7 开始，你可以根据 Memory 和 Graphics 来标记资源文件了</p>
<p><img src="/images/ibt12.jpg" alt="ibt12"></p>
<h4 id="Lazily-down-loading-content"><a href="#Lazily-down-loading-content" class="headerlink" title="Lazily (down)loading content"></a>Lazily (down)loading content</h4><p>现在我们通过对资源的『按需使用』来削减内容尺寸（俗称 ODR），ODR 允许你将资源存储在 Apple 的服务器上，之后仅在需要时才会下载使用。</p>
<p><code>NSBundleResourceRequest</code> 负责处理 ODR，通过这个类，可以通过 Tags 来控制内容的下载。对 tags 的使用，Apple 模糊了本地资源和远程资源的界限。</p>
<blockquote>
<p>使用 ODR 可以包括 images，data，OpenGL shaders，SpriteKit Particles，Watchkit Complications 等</p>
</blockquote>
<p>针对 NSBundles 可看做是 data 文件，因此对于 ODR 来说也是支持的。</p>
<h4 id="Wire-things-up-to-use-tags"><a href="#Wire-things-up-to-use-tags" class="headerlink" title="Wire things up to use tags"></a>Wire things up to use tags</h4><p>现在是代码时间，将之前的本地载入资源文件（ NSBundles 文件）改为远程异步载入，修改 <code>downloadAndDisplayMapOverlay()</code> 方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 1</span></div><div class="line"><span class="keyword">guard</span> <span class="keyword">let</span> bundleTitle =</div><div class="line">  mapOverlayData?.bundleTitle <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 2</span></div><div class="line"><span class="keyword">let</span> bundleResource =</div><div class="line"><span class="type">NSBundleResourceRequest</span>(tags: [bundleTitle])</div><div class="line"><span class="comment">// 3</span></div><div class="line">bundleResource.beginAccessingResourcesWithCompletionHandler &#123;</div><div class="line">  [<span class="keyword">weak</span> <span class="keyword">self</span>] error <span class="keyword">in</span></div><div class="line"><span class="comment">// 4</span></div><div class="line">  <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</div><div class="line"><span class="comment">// 5</span></div><div class="line">    <span class="keyword">if</span> error == <span class="literal">nil</span> &#123;</div><div class="line">      <span class="keyword">self</span>?.displayOverlayFromBundle(bundleResource.bundle)</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>beginAccessingResourcesWithCompletionHandler(_:)</code> 会在完成 on-demand 内容下载后，调用 completion block 将资源文件显示到屏幕上。</p>
<h4 id="How-about-those-tags"><a href="#How-about-those-tags" class="headerlink" title="How about those tags"></a>How about those tags</h4><p>现在我们完成最后一步：标记 tags：</p>
<ol>
<li>选中我们要标记的资源文件（LA_Map.bundle）</li>
<li>在 File Inspector 中找到 On Demand Resource Tags 部分</li>
<li>填写相应的 Tags</li>
</ol>
<p><img src="/images/ibt13.jpg" alt="ibt13"></p>
<p>现在运行程序，选中 LA（LA_Map.bundle 被标记过，所以会被存储在云端），此时将从 Apple 的服务器上下载相应的资源文件</p>
<h4 id="Make-it-download-faster"><a href="#Make-it-download-faster" class="headerlink" title="Make it download faster"></a>Make it download faster</h4><p>LA 这个 bundle 相对来说还比较小，如果你尝试下 San Diego，会发现花很长时间来下载</p>
<p>对于已经通过 ODR 加载过的资源文件，再次显示的时候，ODR 会缓存来保证速度，除非触发了清空条件，否则将会一直缓存这些资源文件</p>
<p>为了避免应用被评为一星，你可以加一个进度条来告诉用户你的 app 正在下载内容，同样是回到 <code>downloadAndDisplayMapOverlay()</code> 方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">guard</span> <span class="keyword">let</span> bundleTitle =</div><div class="line">  mapOverlayData?.bundleTitle <span class="keyword">else</span> &#123;</div><div class="line">  <span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="keyword">let</span> bundleResource</div><div class="line">  = <span class="type">NSBundleResourceRequest</span>(tags: [bundleTitle])</div><div class="line"><span class="comment">// 1</span></div><div class="line">bundleResource.loadingPriority</div><div class="line">  = <span class="type">NSBundleResourceRequestLoadingPriorityUrgent</span></div><div class="line"><span class="comment">// 2</span></div><div class="line">loadingProgressView.observedProgress</div><div class="line">  = bundleResource.progress</div><div class="line"><span class="comment">// 3</span></div><div class="line">loadingProgressView.hidden = <span class="literal">false</span></div><div class="line"><span class="type">UIApplication</span>.sharedApplication()</div><div class="line">  .networkActivityIndicatorVisible = <span class="literal">true</span></div><div class="line"></div><div class="line">bundleResource.beginAccessingResourcesWithCompletionHandler &#123;</div><div class="line">  [<span class="keyword">weak</span> <span class="keyword">self</span>] error <span class="keyword">in</span></div><div class="line">  <span class="type">NSOperationQueue</span>.mainQueue().addOperationWithBlock(&#123;</div><div class="line"><span class="comment">// 4</span></div><div class="line">    <span class="keyword">self</span>?.loadingProgressView.hidden = <span class="literal">true</span></div><div class="line">    <span class="type">UIApplication</span>.sharedApplication()</div><div class="line">      .networkActivityIndicatorVisible = <span class="literal">false</span></div><div class="line">    <span class="keyword">if</span> error == <span class="literal">nil</span> &#123;</div><div class="line">      <span class="keyword">self</span>?.displayOverlayFromBundle(bundleResource.bundle)</div><div class="line">    &#125;</div><div class="line">  &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>loadingProgressView 将会随下载进度进行实时更新</p>
<h3 id="The-many-flavors-of-tagging"><a href="#The-many-flavors-of-tagging" class="headerlink" title="The many flavors of tagging"></a>The many flavors of tagging</h3><p>在真实世界，虽然你加上了进度条来做标记，但用户等待太长时间总归是件非常蛋疼的事情。因此你可以考虑将一些较大的资源文件设为初始数据打包进 IPA ，让他们一起下载安装</p>
<h4 id="Initial-install-tags"><a href="#Initial-install-tags" class="headerlink" title="Initial install tags"></a>Initial install tags</h4><p>选择工程名称 -&gt; Target -&gt; Resource Tags，将 <code>All</code> 切换为 <code>Prefetched</code>，会发现 ODR 有三种类型的处理方式：</p>
<ul>
<li>Initial Install Tags：这个是资源文件随应用一起打包安装时使用，之后不需要时可以移除，所以也要由 ODR 来管理</li>
<li>Prefetched Tag Order：一旦完成下载，按顺序排列</li>
<li>Download Only On Demand：按需下载</li>
</ul>
<p>现在我们可以根据需要，添加相应的资源文件</p>
<p><img src="/images/ibt14.jpg" alt="ibt14"></p>
<p>想要测试实际效果，需要提交到 TestFlight Beta Testing，然后用真实设备下载测试即可。</p>
<h3 id="Purging-content"><a href="#Purging-content" class="headerlink" title="Purging content"></a>Purging content</h3><p>你可以帮助 iOS 系统在资源文件不再需要时从磁盘清除掉</p>
<h4 id="Set-a-resource-to-be-purged"><a href="#Set-a-resource-to-be-purged" class="headerlink" title="Set a resource to be purged"></a>Set a resource to be purged</h4><p>设置一个 <code>NSBundleResourceRequest</code> 类型的属性 <code>overlayBundleResource</code> 用来标记下载到的资源文件</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> overlayBundleResource: <span class="type">NSBundleResourceRequest</span>?</div></pre></td></tr></table></figure>
<p>将这个属性标记的指针指向获取到的资源文件，在资源文件下载显示方法 <code>downloadAndDisplayMapOverlay()</code> 中添加一条：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">overlayBundleResource = bundleResource</div></pre></td></tr></table></figure>
<p>最后在屏幕消失时告诉系统完成了对资源文件的访问</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidDisappear</span><span class="params">(animated: Bool)</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewDidDisappear(animated)</div><div class="line">    overlayBundleResource?.endAccessingResources()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>具体的资源文件是否占用磁盘，可以通过下面的方式进行查看</p>
<p><img src="/images/ibt15.jpg" alt="ibt15"></p>
<hr>
<h2 id="Chapter-5：Multitasking"><a href="#Chapter-5：Multitasking" class="headerlink" title="Chapter 5：Multitasking"></a>Chapter 5：Multitasking</h2><p>iOS 9 苹果为 iPad 带来了多任务，允许同时在一个界面上运行两个程序，本章来学习下如何在现有 App 上添加多任务环境</p>
<p>现在 Multitasking 有三种模式：</p>
<ul>
<li>Slide Over 多任务模式：打开一个 App，从 iPad Air 边缘向中心滑动，会出现一个窄边框，此时刚才打开的 App 主界面会变暗（蒙上一层灰色 mask），从边缘拉出来的空间内会出现一个 App 列表（仅限适配过的 App），你可以选择打开某个应用，此时该应用会在边缘空间显示。</li>
<li>Split View 多任务模式：当你继续往中心拉，屏幕会被分为两部分，左右两边的 App 会同时显示在屏幕上，也不会有任何一个 App 处于 mask 之下。</li>
<li>Picture in Picture 模式：也就是所谓的画中画模式，一般在播放视频时使用</li>
</ul>
<blockquote>
<p>Split View 模式仅支持 iPad Air 2，Picture in Picture 和 Slide Over 则支持 iPad Air, iPad Air 2, iPad Mini 2, 和 iPad Mini 3。<br>因为 iPad Air 2 是 2 G 内存，Split View 也是最占内存的</p>
</blockquote>
<h3 id="Preparing-your-app-for-multitasking"><a href="#Preparing-your-app-for-multitasking" class="headerlink" title="Preparing your app for multitasking"></a>Preparing your app for multitasking</h3><p>如果你的 App 是按照如下方式开发的，那么恭喜你。只要你用 iOS 9 的 SDK 重新编译下就自动支持 multitasking 了</p>
<ul>
<li>使用 size classes, adaptive layout 开发的 universal app</li>
<li>用 SDK 9.X 编译过</li>
<li>支持所有方向</li>
<li>使用 launch storyboard 或 XIB</li>
</ul>
<p>注意：做到上面这几点也仅仅是支持 multitasking 而已，并不意味完美适配。</p>
<h3 id="Orientation-and-size-changes"><a href="#Orientation-and-size-changes" class="headerlink" title="Orientation and size changes"></a>Orientation and size changes</h3><p>下面看一下本章的 Travelog （该 App 已经做到上述 4 点）在 multitasking 下的表现</p>
<p>首先是单个 App 全屏运行的表现（横屏和竖屏）：</p>
<p><img src="/images/ibt16.jpg" alt="ibt16"></p>
<p>Split View 多任务模式下竖屏的表现：</p>
<p><img src="/images/ibt17.jpg" alt="ibt17"></p>
<p>Split View 多任务模式下横屏的表现：</p>
<p><img src="/images/ibt18.jpg" alt="ibt18"></p>
<p>master view 的内容太拥挤了，并且右边的列表栏并未显示任何内容</p>
<p>App 在多任务模式下，部分情况下 bounds 发生变化，也可看做是触发了 size class 的变化，下面是在各种多任务模式下 size class 的具体情形：</p>
<p><img src="/images/ibt19.jpg" alt="ibt19"></p>
<p>(R 代表 Regular 而 C 代表 Compact)</p>
<p>幸好 UIKit 提供了一些更新 layout 的契机，我们可以在下面的方法中更新 layout：</p>
<ol>
<li><code>willTransitionToTraitCollection(_:,withTransitionCoordinator:)</code></li>
<li><code>viewWillTransitionToSize(_:,withTransitionCoordinator:)</code></li>
<li><code>traitCollectionDidChange(_:):</code></li>
</ol>
<p>回顾下 Split View 多任务模式 下竖屏的表现，再对比下上图 33% split 的情形，App 的 size class 仍然为 Regular，但整体 width 变窄了，所以 master view 就会略显拥挤</p>
<p>修正办法也很简单，先设置一个 <code>maximumPrimaryColumnWidth</code> 属性值</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateMaximumPrimaryColumnWidthBasedOnSize</span><span class="params">(size: CGSize)</span></span> &#123;</div><div class="line"><span class="comment">// 如果是小于屏幕宽度或竖屏状况，就设置一个较小的值</span></div><div class="line">  <span class="keyword">if</span> size.width &lt; <span class="type">UIScreen</span>.mainScreen().bounds.width</div><div class="line">    || size.width &lt; size.height &#123;</div><div class="line">    maximumPrimaryColumnWidth = <span class="number">170.0</span></div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    maximumPrimaryColumnWidth =</div><div class="line">      <span class="type">UISplitViewControllerAutomaticDimension</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在第一次载入时更新：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">super</span>.viewDidLoad()</div><div class="line">  updateMaximumPrimaryColumnWidthBasedOnSize(view.bounds.size)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 size 发生变化时更新</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewWillTransitionToSize</span><span class="params">(size: CGSize,</span></span></div><div class="line">  withTransitionCoordinator coordinator:</div><div class="line">  UIViewControllerTransitionCoordinator) &#123;</div><div class="line">  <span class="keyword">super</span>.viewWillTransitionToSize(size,</div><div class="line">    withTransitionCoordinator: coordinator)</div><div class="line">  updateMaximumPrimaryColumnWidthBasedOnSize(size)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再次运行，好像变得更糟了</p>
<p><img src="/images/ibt20.jpg" alt="ibt20"></p>
<p>似乎 table view cell 没有随 size 变化而自适应，cell 是自定义的 view，我们打开看一下（<code>LogCell.swift</code>）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">let</span> widthThreshold: <span class="type">CGFloat</span> = <span class="number">1024.0</span></div><div class="line"></div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSubviews</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.layoutSubviews()</div><div class="line">    <span class="keyword">let</span> isTooNarrow = <span class="type">UIScreen</span>.mainScreen().bounds.width &lt; <span class="type">LogCell</span>.widthThreshold</div><div class="line">    compactView.hidden = !isTooNarrow</div><div class="line">    regularView.hidden = isTooNarrow</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>发现问题所在了吗？UIScreen 的尺寸一般是固定的，并不会响应 App size 的变化。因此我们用 UIWindow.bounds 来替代</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">let</span> widthThreshold: <span class="type">CGFloat</span> = <span class="number">180.0</span></div><div class="line"></div><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">layoutSubviews</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">super</span>.layoutSubviews()</div><div class="line">  <span class="keyword">let</span> isTooNarrow = bounds.width &lt;= <span class="type">LogCell</span>.widthThreshold</div><div class="line">  <span class="comment">// some code ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在就好很多</p>
<p><img src="/images/ibt21.jpg" alt="ibt21"></p>
<blockquote>
<p>UIWindow.bounds 一直会响应 size 的变化，并且他的原点始终为 (0, 0)。在 iOS 9 你可以直接创建 UIWindow 的实例，且不需要通过 <code>let window = UIWindow()</code> 来传递一个 frame，系统会自动提供一个和应用 frame 相同的 frame</p>
</blockquote>
<h3 id="Adaptive-presentation"><a href="#Adaptive-presentation" class="headerlink" title="Adaptive presentation"></a>Adaptive presentation</h3><p>点击左上角的 Photo Library bar button</p>
<p><img src="/images/ibt22.jpg" alt="ibt22"></p>
<p>此时将两个 App 之间的分割线继续向左拖动</p>
<p><img src="/images/ibt23.jpg" alt="ibt23"></p>
<p>到了 50% 模式下，popover 没有任何过渡动作自动变成了模态显示，因为在此模式显示下，App 的 size class 由 regular 变成了 compact。但这并不是你想要的，你仅仅想让你的 App 在占屏幕 33% 的情形下才用模态展示照片库（in Slide Over 或 in 33% part）</p>
<p>iOS 8 介绍了 <code>UIPopoverPresentationController</code> 管理 popover 显示的内容，你会通过 <code>UIModalPresentationPopover</code> 提供的样式来展示。</p>
<p>UIPopoverPresentationControllerDelegate 提供了回调注射方法，你可以提供自定义的样式来展示 popover：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">LogsViewController</span>:</span></div><div class="line">  <span class="title">UIPopoverPresentationControllerDelegate</span> &#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">adaptivePresentationStyleForPresentationController</span><span class="params">(</span></span></div><div class="line">    controller: UIPresentationController,</div><div class="line">    traitCollection: UITraitCollection)</div><div class="line">    -&gt; <span class="type">UIModalPresentationStyle</span> &#123;</div><div class="line">    <span class="comment">//1 检查是否运行在 iPad 上</span></div><div class="line">    <span class="keyword">guard</span> traitCollection.userInterfaceIdiom == .<span class="type">Pad</span> <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> .<span class="type">FullScreen</span></div><div class="line">    &#125;</div><div class="line">   <span class="comment">//2 检查是否大于 320 即 33%</span></div><div class="line">    <span class="keyword">if</span> splitViewController?.view.bounds.width &gt; <span class="number">320</span> &#123;</div><div class="line">      <span class="keyword">return</span> .<span class="type">None</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">return</span> .<span class="type">FullScreen</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>只要大于 33%，一律以正常 popover 展示，只有小于或等于 33%，才会全屏模态展示</p>
</blockquote>
<p>最后修改 <code>presentImagePickerControllerWithSourceType(_:)</code> 找机会添加 <code>popoverPresentationController</code> 的 delete 为 self</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">presentImagePickerControllerWithSourceType</span><span class="params">(sourceType:</span></span></div><div class="line">  UIImagePickerControllerSourceType) &#123;</div><div class="line">  <span class="comment">// some code...</span></div><div class="line">  <span class="keyword">if</span> sourceType ==</div><div class="line">    <span class="type">UIImagePickerControllerSourceType</span>.<span class="type">PhotoLibrary</span> &#123;</div><div class="line">    <span class="keyword">let</span> presenter = controller.popoverPresentationController</div><div class="line">    <span class="comment">// some code...</span></div><div class="line">    presenter?.delegate = <span class="keyword">self</span></div><div class="line">&#125;</div><div class="line">  <span class="comment">// some code...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终运行，一切 OK</p>
<p><img src="/images/ibt24.jpg" alt="ibt24"></p>
<h3 id="Other-considerations"><a href="#Other-considerations" class="headerlink" title="Other considerations"></a>Other considerations</h3><p>除此之外，还应该考虑的有：</p>
<ul>
<li>Keyboard：要考虑多任务模式下，键盘出来后的 layout 设置</li>
<li>Designs：设计主要考虑下面几点<ul>
<li>Be flexible 考虑在多任务模式下各种 size class 下的表现</li>
<li>Use Auto Layout：使用 Auto Layout</li>
<li>Use size classes：使用 Size Class 适应各种布局</li>
</ul>
</li>
<li>Resources：因为多任务的引用，所以最大的情况下，iPad 在 Split View 多任务模式下可以有三个 App 在一个屏幕上同时运行（第一个 App，第二个 App 和画中画 App），因此你需要思考在多任务模式下尽量缩减 App 不必要的内存开销。</li>
</ul>
<hr>
<h2 id="Chapter-6：3D-Touch"><a href="#Chapter-6：3D-Touch" class="headerlink" title="Chapter 6：3D Touch"></a>Chapter 6：3D Touch</h2><p>苹果在 iPhone 6s 与 iPhone 6s Plus 上推出了 3D Touch 功能，不同于以往，这次的新 feature 是对开发者开放的，你也可以在自己的 App 上部署 3D Touch，API 层面上的变化主要是下面三点：</p>
<ul>
<li>UITouch 现在有了 <code>force</code> 属性，可以识别按压力度了</li>
<li>UIViewController 扩展了一系列 API，允许你的 ViewController 以一个预览的方式展示（peek），当用户持续重压屏幕则会全屏展示（pop）</li>
<li>UIApplicationShortcutItem 是一个全新增加的类，增加一些可以执行的动作，然后你可以在 iPhone 主界面重压程序图标快捷执行。</li>
</ul>
<h3 id="UITouch-force"><a href="#UITouch-force" class="headerlink" title="UITouch force"></a>UITouch force</h3><p>UITouch 有了一个新的属性 <code>force</code>，他值的范围（CGFloat）从 0 到 <code>maximumPossibleForce</code>（新添加的属性），通常值为 1 表示一个平均的压力水平。</p>
<p>现在你可以实现一个画板 App，画布对按压力度敏感，力度越大笔画越粗，反之越细。</p>
<p>下面的方法实现了划线这一步骤，注意他带三个参数：起点、终点、力度（默认为1，稍后我们会从 UITouch 的 force 属性中获取真实的值）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Canvas</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">addLineFromPoint</span><span class="params">(from: CGPoint, toPoint: CGPoint, withForce force: CGFloat = <span class="number">1</span>)</span></span> &#123;</div><div class="line"></div><div class="line">    <span class="type">UIGraphicsBeginImageContextWithOptions</span>(bounds.size, <span class="literal">false</span>, <span class="number">0.0</span>)</div><div class="line"></div><div class="line">    drawing?.drawInRect(bounds)</div><div class="line"></div><div class="line">    <span class="keyword">let</span> cxt = <span class="type">UIGraphicsGetCurrentContext</span>()</div><div class="line">    <span class="type">CGContextMoveToPoint</span>(cxt, from.x, from.y)</div><div class="line">    <span class="type">CGContextAddLineToPoint</span>(cxt, toPoint.x, toPoint.y)</div><div class="line"></div><div class="line">    <span class="type">CGContextSetLineCap</span>(cxt, .<span class="type">Round</span>)</div><div class="line"></div><div class="line">    <span class="type">CGContextSetLineWidth</span>(cxt, <span class="number">2</span> * force * strokeWidth)</div><div class="line"></div><div class="line">    strokeColor.setStroke()</div><div class="line"></div><div class="line">    <span class="type">CGContextStrokePath</span>(cxt)</div><div class="line"></div><div class="line">    drawing = <span class="type">UIGraphicsGetImageFromCurrentImageContext</span>()</div><div class="line"></div><div class="line">    layer.contents = drawing?.<span class="type">CGImage</span></div><div class="line"></div><div class="line">    <span class="type">UIGraphicsEndImageContext</span>()</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在 touchesMoved(_:withEvent:) 中判断当前设备是否支持 3D Touch，支持就从 touch 中获取真实的 force，不支持 force 就默认设为 1（前面已经设好了）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> traitCollection.forceTouchCapability == .<span class="type">Available</span> &#123;</div><div class="line">  addLineFromPoint(touch.previousLocationInView(<span class="keyword">self</span>),</div><div class="line">    toPoint: touch.locationInView(<span class="keyword">self</span>), withForce: touch.force)</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  addLineFromPoint(touch.previousLocationInView(<span class="keyword">self</span>),</div><div class="line">    toPoint: touch.locationInView(<span class="keyword">self</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在你可以随心所欲地画画了</p>
<p><img src="/images/ibt25.jpg" alt="ibt25"></p>
<h3 id="Peeking-and-popping"><a href="#Peeking-and-popping" class="headerlink" title="Peeking and popping"></a>Peeking and popping</h3><p>在支持 3D Touch 的设备上，View Controller 是可以识别出不同的压力力度的</p>
<ol>
<li>用户开始用力按压一个界面，该界面会逐渐以焦点显示，而周围的背景会慢慢模糊掉</li>
<li>当用户继续用力，这个预览界面会显示在屏幕中心，这个就叫做 peek 此时手指离开，预览界面也会消失。当手指向上滑动，这个预览界面会展示几个 action 按钮供你选择</li>
<li>当用户继续重压，整个预览界面就会全屏展示，被称为 pop</li>
</ol>
<p><img src="/images/ibt26.jpg" alt="ibt26"></p>
<p>前面我们已经提到，iOS 9 的 View Controller 已经添加了 3D Touch API 支持，下面的代码首先判断了设备是否支持 3D Touch，<code>registerForPreviewingWithDelegate(_:sourceView:)</code> 是 iOS 9 新增的 API，见名思义，注册一个 view controller 参与 3D Touch 的预览 <code>peek</code> 和 <code>pop</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> traitCollection.forceTouchCapability == .<span class="type">Available</span> &#123;</div><div class="line">  registerForPreviewingWithDelegate(<span class="keyword">self</span>, sourceView: view)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该方法带两个参数，<code>delegate</code> 通过实现 <code>UIViewControllerPreviewingDelegate</code> 来协调展示 preview VC，<code>sourceView</code> 表示需要回应 3D Touch 的 view</p>
<blockquote>
<p>回顾上图所示，我们在 TableView 上实现按压 cell 弹出 preview，所以我们就在 TableView Controller 上实现这个方法，那么 sourceView 也就是 tableView</p>
</blockquote>
<p>既然指定了 self 是 delegate，下面要实现 <code>UIViewControllerPreviewingDelegate</code> 方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DoodlesViewController</span>:</span></div><div class="line">  <span class="title">UIViewControllerPreviewingDelegate</span> &#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">previewingContext</span><span class="params">(</span></span></div><div class="line">    previewingContext: UIViewControllerPreviewing,</div><div class="line">    viewControllerForLocation location: CGPoint)</div><div class="line">    -&gt; <span class="type">UIViewController</span>? &#123;</div><div class="line">    <span class="comment">// peek!</span></div><div class="line">    <span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">previewingContext</span><span class="params">(</span></span></div><div class="line">    previewingContext: UIViewControllerPreviewing,</div><div class="line">    commitViewController viewControllerToCommit:</div><div class="line">    UIViewController) &#123;</div><div class="line">    <span class="comment">// pop!</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>1.第一个 delegate 方法 <code>previewingContext(_:viewControllerForLocation:)</code> 带两个参数：</p>
<ul>
<li>location 表示 3D Touch 发生的位置，你根据该参数判断那个 view 被按压</li>
<li>previewingContext 是一个 UIViewControllerPreviewing 实例，这个类有两个属性比较有用：<ul>
<li>sourceView：就是你之前从 registerForPreviewingWithDelegate(_:sourceView:) 方法中传递进来的 view</li>
<li>sourceRect：表示可以按下去的尺寸，这里为一个 cell 的 frame<br>这个 delegate 返回一个被 preview 展示的 view controller</li>
</ul>
</li>
</ul>
<p>2.第二个 delegate 方法 <code>previewingContext(_:commitViewController:)</code> 当用户按压力度更大触发 pop 时被调用，该方法同样带两个参数，一个与上面相同，另一个 <code>viewControllerToCommit</code> 来自于上面 delegate 方法的返回值，即将要被展示的 VC。当用户持续重压，由 preview 转到全屏展示，也是会显示这个 VC</p>
<p>现在来完善这两个方法：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">DoodlesViewController</span>:</span></div><div class="line">  <span class="title">UIViewControllerPreviewingDelegate</span> &#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">previewingContext</span><span class="params">(</span></span></div><div class="line">    previewingContext: UIViewControllerPreviewing,</div><div class="line">    viewControllerForLocation location: CGPoint)</div><div class="line">    -&gt; <span class="type">UIViewController</span>? &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 1</span></div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> indexPath =</div><div class="line">      tableView.indexPathForRowAtPoint(location),</div><div class="line">      cell = tableView</div><div class="line">        .cellForRowAtIndexPath(indexPath) <span class="keyword">as</span>? <span class="type">DoodleCell</span></div><div class="line">      <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 2</span></div><div class="line">    <span class="keyword">let</span> identifier = <span class="string">"DoodleDetailViewController"</span></div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> detailVC = storyboard?</div><div class="line">      .instantiateViewControllerWithIdentifier(identifier)</div><div class="line">      <span class="keyword">as</span>? <span class="type">DoodleDetailViewController</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> <span class="literal">nil</span> &#125;</div><div class="line">    detailVC.doodle = cell.doodle</div><div class="line"></div><div class="line">    <span class="comment">// 3 这样当 cell 被持续按压的话，tableView 其余的地方就会变模糊</span></div><div class="line">    previewingContext.sourceRect = cell.frame</div><div class="line">    <span class="comment">// 4</span></div><div class="line">    <span class="keyword">return</span> detailVC</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">previewingContext</span><span class="params">(</span></span></div><div class="line">    previewingContext: UIViewControllerPreviewing,</div><div class="line">    commitViewController viewControllerToCommit:</div><div class="line">    UIViewController) &#123;</div><div class="line"></div><div class="line">    showViewController(viewControllerToCommit, sender: <span class="keyword">self</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>Preview view controller 通常会显示一个默认的尺寸，但是你可以通过覆盖 <code>preferredContentSize</code> 属性来修改</p>
</blockquote>
<p>Apple 已经为一些控件实现了 peek 和 pop，比如 UIWebView 和 WKWebView，你只需要将他们的 <code>allowsLinkPreview</code> 属性设为 <code>true</code> 即可</p>
<h3 id="Preview-actions"><a href="#Preview-actions" class="headerlink" title="Preview actions"></a>Preview actions</h3><p>前面我们提到在 peek 展示 preview 阶段，用户手指不离开屏幕向上滑动，会显示一些操作按钮。实现起来也很简单，在将会被 preview 展示的 VC （即最终会被 pop 到屏幕上的 VC）上实现  <code>previewActionItems</code> 方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">previewActionItems</span><span class="params">()</span></span> -&gt; [<span class="type">UIPreviewActionItem</span>] &#123;</div><div class="line">  <span class="comment">// 1</span></div><div class="line">  <span class="keyword">let</span> shareAction = <span class="type">UIPreviewAction</span>(title: <span class="string">"Share"</span>,</div><div class="line">    style: .<span class="type">Default</span>) &#123;</div><div class="line">    (previewAction, viewController) <span class="keyword">in</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> doodlesVC = <span class="keyword">self</span>.doodlesViewController,</div><div class="line">      activityViewController = <span class="keyword">self</span>.activityViewController &#123;</div><div class="line">      doodlesVC.presentViewController(activityViewController,</div><div class="line">        animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 2</span></div><div class="line">  <span class="keyword">let</span> deleteAction = <span class="type">UIPreviewAction</span>(title: <span class="string">"Delete"</span>,</div><div class="line">    style: .<span class="type">Destructive</span>) &#123;</div><div class="line">    (previewAction, viewController) <span class="keyword">in</span></div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> doodle = <span class="keyword">self</span>.doodle <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">    <span class="type">Doodle</span>.deleteDoodle(doodle)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> doodlesViewController = <span class="keyword">self</span>.doodlesViewController &#123;</div><div class="line">      doodlesViewController.tableView.reloadData()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> [shareAction, deleteAction]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面分别用 <code>UIPreviewAction</code> 创建了两个 preview action：分享和删除操作</p>
<blockquote>
<p><code>UIPreviewAction</code> 类似于 <code>UIAlertActions</code>，你还可以使用 UIPreviewActionGroup 将他们分组，也就是说一个 group 可以包含多个 action，当你点击这个 group ，会打开个子菜单提供一些 actions 供你选择。</p>
</blockquote>
<p>因为这个 preview action 方法最终是要由 containerVC（<code>doodlesViewController</code>） 来执行，在这里我们仅仅是在 preview VC 中保留了 containerVC 的一个引用（注意是 weak 的），当然你也可以用代理这种设计模式来解耦。</p>
<p><img src="/images/ibt27.jpg" alt="ibt27"></p>
<h3 id="Home-screen-quick-actions"><a href="#Home-screen-quick-actions" class="headerlink" title="Home screen quick actions"></a>Home screen quick actions</h3><p>最后一个关于 3D Touch 的特性是可以在手机主屏，重压 App 图标弹出一个菜单来快速执行一些操作</p>
<p><img src="/images/ibt28.jpg" alt="ibt28"></p>
<p>每个 App 图标可以添加四个 action，每个 action 分成两种类型：</p>
<ul>
<li>Static shortcuts: Static shortcuts 在 Info.plist 中定义，随 App 安装生效</li>
<li>Dynamic shortcuts: 在 runtime 时设置，能够被动态添加移除。只有运行一次才会生效</li>
</ul>
<h4 id="Adding-a-static-shortcut"><a href="#Adding-a-static-shortcut" class="headerlink" title="Adding a static shortcut"></a>Adding a static shortcut</h4><p><img src="/images/ibt29.jpg" alt="ibt29"></p>
<p>增加一个 key 为 UIApplicationShortcutItems 的 Array，添加一个字典，然后添加下面的 item：</p>
<p><img src="/images/ibt30.jpg" alt="ibt30"></p>
<ul>
<li>UIApplicationShortcutItemTitle: 表示 Action 的标题为 New Doodle</li>
<li>UIApplicationShortcutItemType: <code>com.razeware.Doodles.new</code> 表示唯一的标识符，稍后代码中会用到</li>
<li>UIApplicationShortcutItemIconType: UIApplicationShortcutIconTypeAdd 表示 Action 为 Add，稍后展示的 icon 也为 Add（ + 号）</li>
</ul>
<p>除了这三个类型的 key 外，通过查看文档还有下面三种 key：</p>
<ul>
<li>UIApplicationShortcutItemSubtitle：定义了子标题</li>
<li>UIApplicationShortcutItemIconFile：用来提供自定义的 icon 图像</li>
<li>UIApplicationShortcutItemUserInfo：允许你提供自定义的字典，包含你所需要的内容</li>
</ul>
<p>现在你已经定义了一个 shortcut item，当用户用力按压图标时，iOS 9 会执行一个新的 <code>UIApplicationDelegate</code> 方法  <code>application:performActionForShortcutItem:completionHandler:</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(application: UIApplication,</span></span></div><div class="line">  performActionForShortcutItem</div><div class="line">  shortcutItem: UIApplicationShortcutItem,</div><div class="line">  completionHandler: <span class="params">(Bool)</span> -&gt; <span class="type">Void</span>) &#123;</div><div class="line"></div><div class="line">  handleShortcutItem(shortcutItem)</div><div class="line">  completionHandler(<span class="literal">true</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们来实现这个 <code>handleShortcutItem</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleShortcutItem</span><span class="params">(</span></span></div><div class="line">  shortcutItem: UIApplicationShortcutItem) &#123;</div><div class="line">  <span class="keyword">switch</span> shortcutItem.type &#123;</div><div class="line">  <span class="keyword">case</span> <span class="string">"com.razeware.Doodles.new"</span>:</div><div class="line">    presentNewDoodleViewController()</div><div class="line">  <span class="keyword">default</span>: <span class="keyword">break</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据我们之前在 Info.plist 中定义的 <code>UIApplicationShortcutItemType</code> 唯一标识符来判断是否执行快捷操作，在这里我们快速新建一个新的 VC</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">presentNewDoodleViewController</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">let</span> identifier = <span class="string">"NewDoodleNavigationController"</span></div><div class="line">  <span class="keyword">let</span> doodleViewController = <span class="type">UIStoryboard</span>.mainStoryboard</div><div class="line">    .instantiateViewControllerWithIdentifier(identifier)</div><div class="line"></div><div class="line">  window?.rootViewController?</div><div class="line">    .presentViewController(doodleViewController, animated: <span class="literal">true</span>,</div><div class="line">    completion: <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终效果：</p>
<p><img src="/images/ibt31.jpg" alt="ibt31"></p>
<blockquote>
<p>当你从 quick action 启动一个应用，application(_:didFinishLaunchingWithOptions:) 依然会被调用，且他的 <code>launchOptions</code> 字典中的 <code>UIApplicationLaunchOptionsShortcutItemKey</code> 会包含这个 <code>UIApplicationShortcutItem</code></p>
</blockquote>
<h4 id="Adding-a-dynamic-shortcut"><a href="#Adding-a-dynamic-shortcut" class="headerlink" title="Adding a dynamic shortcut"></a>Adding a dynamic shortcut</h4><p>在 Doodle.swift（包含涂鸦的 model） 中增加一个静态方法，所做的事情也很简单，用代码创建一个 <code>UIApplicationShortcutItem</code> 且加入应用程序的 <code>shortcutItems</code> 数组：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">configureDynamicShortcuts</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> mostRecentDoodle = <span class="type">Doodle</span>.sortedDoodles.first &#123;</div><div class="line">    <span class="keyword">let</span> shortcutType = <span class="string">"com.razeware.Doodles.share"</span></div><div class="line">    <span class="keyword">let</span> shortcutItem = <span class="type">UIApplicationShortcutItem</span>(</div><div class="line">      type: shortcutType,</div><div class="line">      localizedTitle: <span class="string">"Share Latest Doodle"</span>,</div><div class="line">      localizedSubtitle: mostRecentDoodle.name,</div><div class="line">      icon: <span class="type">UIApplicationShortcutIcon</span>(type: .<span class="type">Share</span>),</div><div class="line">      userInfo: <span class="literal">nil</span>)</div><div class="line">    <span class="type">UIApplication</span>.sharedApplication().shortcutItems =</div><div class="line">      [ shortcutItem ]</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="type">UIApplication</span>.sharedApplication().shortcutItems = []</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>接着在 <code>addDoodle(_:)</code> 和 <code>deleteDoodle(_:)</code> 更新 model 的操作中都执行下 <code>Doodle.configureDynamicShortcuts()</code>，这样无论新增或删除一个涂鸦，你都会动态更新 shortcut item</p>
<p>除了更新 model，在 App 启动时也要动态更新下，在 <code>application(_:didFinishLaunchingWithOptions:)</code> 添加 <code>Doodle.configureDynamicShortcuts()</code></p>
<p>最后来处理按下 shortItem action 所要执行的操作：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">handleShortcutItem</span><span class="params">(</span></span></div><div class="line">  shortcutItem: UIApplicationShortcutItem) &#123;</div><div class="line">  <span class="keyword">switch</span> shortcutItem.type &#123;</div><div class="line">  <span class="keyword">case</span> <span class="string">"com.razeware.Doodles.new"</span>:</div><div class="line">    presentNewDoodleViewController()</div><div class="line">  <span class="keyword">case</span> <span class="string">"com.razeware.Doodles.share"</span>:</div><div class="line">    shareMostRecentDoodle()</div><div class="line">  <span class="keyword">default</span>: <span class="keyword">break</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">shareMostRecentDoodle</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> mostRecentDoodle = <span class="type">Doodle</span>.sortedDoodles.first,</div><div class="line">    navigationController = window?.rootViewController <span class="keyword">as</span>?</div><div class="line">    <span class="type">UINavigationController</span></div><div class="line">    <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">  <span class="keyword">let</span> identifier = <span class="string">"DoodleDetailViewController"</span></div><div class="line">  <span class="keyword">let</span> doodleViewController = <span class="type">UIStoryboard</span>.mainStoryboard</div><div class="line">    .instantiateViewControllerWithIdentifier(identifier) <span class="keyword">as</span>!</div><div class="line">    <span class="type">DoodleDetailViewController</span></div><div class="line"></div><div class="line">  doodleViewController.doodle = mostRecentDoodle</div><div class="line">  doodleViewController.shareDoodle = <span class="literal">true</span></div><div class="line">  navigationController</div><div class="line">    .pushViewController(doodleViewController, animated: <span class="literal">true</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最终结果：</p>
<p><img src="/images/ibt32.jpg" alt="ibt32"></p>
<hr>
<h2 id="Chapter-7：UIStackView-amp-AutoLayout-changes"><a href="#Chapter-7：UIStackView-amp-AutoLayout-changes" class="headerlink" title="Chapter 7：UIStackView &amp; AutoLayout changes"></a>Chapter 7：UIStackView &amp; AutoLayout changes</h2><p>从 iOS 8 开始，Apple 就一直改进 AutoLayout 的体验，iOS 9 UIKit 团队推出了 UIStackView，让自动化布局变得更加简单</p>
<p>Stack View 提供了一些垂直和水平方向上的布局方式，通过设置这些属性如 alignment，distribution，spacing 你可以定义这些 contained views 之间的距离</p>
<blockquote>
<p>stack view 可看作是一个容器，包含着需要布局的 views</p>
</blockquote>
<p>现在来玩第一个 Stack View</p>
<p><img src="/images/ibt33.jpg" alt="ibt33"></p>
<p>选中这三个 view，然后将他们加入 Stack View</p>
<p><img src="/images/ibt34.jpg" alt="ibt34"></p>
<p>将 view 加入 stackView 会将原有的约束全部清除掉，因此我们需要重新添加约束，不过这一次是在 stackView 上添加</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">Top: 20, Leading: 0, Trailing: 0, Bottom: 0</div></pre></td></tr></table></figure>
<p>解决了外部，再回到 stack view 内部，内部 view 之前的间距太近了，我们来添加一些 Spacing，方法如下：</p>
<p><img src="/images/ibt35.jpg" alt="ibt35"></p>
<p>照例，运行看下效果：</p>
<p><img src="/images/ibt36.jpg" alt="ibt36"></p>
<h3 id="Stack-views-are-just-better"><a href="#Stack-views-are-just-better" class="headerlink" title="Stack views are just better"></a>Stack views are just better</h3><p>如果你有一堆 views，相互之间都设好约束。如果其中一个 view 被隐藏掉，为了保证显示效果，你需要对约束做一些调整。而现在有了 stack view，你只需要将 view 的 hidden 设为 true，隐藏掉就好了，其余的事情交给 stack view 来处理。</p>
<p>除了在 Auto Layout 上的改进，iOS 9 还放出了两个新玩意： layout anchors 和 layout guides，分别来自 <code>NSLayoutAnchor</code> 类和 <code>UILayoutGuide</code> 类</p>
<h3 id="Layout-anchors"><a href="#Layout-anchors" class="headerlink" title="Layout anchors"></a>Layout anchors</h3><p>Layout anchors 提供了一种直观的方式来创建约束，想象下你有两个 labels，<code>bottomLabel</code> 和 <code>topLabel</code>。你想让 bottomLabel 位于 topLabel 的下方，且二者直接的距离为 8 points。在 iOS 9 之前，你可能要这么写：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> constraint = <span class="type">NSLayoutConstraint</span>(</div><div class="line">  item: topLabel,</div><div class="line">  attribute: .<span class="type">Bottom</span>,</div><div class="line">  relatedBy: .<span class="type">Equal</span>,</div><div class="line">  toItem: bottomLabel,</div><div class="line">  attribute: .<span class="type">Top</span>,</div><div class="line">  multiplier: <span class="number">1</span>,</div><div class="line">  constant: <span class="number">8</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>而有了 Layout anchors 允许我们这么做</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> constraint = topLabel.bottomAnchor.constraintEqualToAnchor(</div><div class="line">    bottomLabel.topAnchor, constant: <span class="number">8</span>)</div></pre></td></tr></table></figure>
<p><code>constraintEqualToAnchor:constant:</code> 方法属于类 <code>NSLayoutAnchor</code> 的实例方法，这个类还有几个类似的方法：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">- constraintEqualToAnchor:</div><div class="line">- constraintGreaterThanOrEqualToAnchor:</div><div class="line">- constraintGreaterThanOrEqualToAnchor:constant:</div><div class="line">- constraintLessThanOrEqualToAnchor:</div><div class="line">- constraintLessThanOrEqualToAnchor:constant:</div></pre></td></tr></table></figure>
<p><code>NSLayoutAnchor</code> 主要优势在于你不用直接创建 <code>NSLayoutConstraint</code>了，而是先选择你要添加约束的对象包括（UIView、NSView、UILayoutGuide），然后用这些对象的 <code>anchor</code> 属性通过上面的方法来构建你的约束</p>
<p>再回到上面的例子中，现在 view 有 <code>layout anchor</code> 对象（bottomAnchor）来表示  <code>.Bottom attribute</code> 了，而 <code>bottomAnchor</code> 属于 <code>NSLayoutYAxisAnchor</code>，继承自 <code>NSLayoutAnchor</code></p>
<p><code>NSLayoutAnchor</code> 有四个子类以及分别对应了如下 anchor：</p>
<ul>
<li>NSLayoutDimension<ul>
<li>heightAnchor</li>
<li>widthAnchor</li>
</ul>
</li>
<li>NSLayoutXAxisAnchor<ul>
<li>centerXAnchor</li>
<li>leadingAnchor</li>
<li>leftAnchor</li>
<li>rightAnchor</li>
<li>trailingAnchor</li>
</ul>
</li>
<li>NSLayoutYAxisAnchor<ul>
<li>bottomAnchor</li>
<li>centerYAnchor</li>
<li>topAnchor</li>
</ul>
</li>
</ul>
<p>如果你查看文档，会发现 <code>NSLayoutDimension</code> 多了一些方法，增加了 <code>multiplier</code> 和 <code>Constant</code></p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">func constraintEqualToConstant(_:)</div><div class="line">func constraintEqualToAnchor(_:multiplier:)</div><div class="line">func constraintEqualToAnchor(_:multiplier:constant:)</div><div class="line"></div><div class="line">func constraint[Less|Greater]ThanOrEqualToConstant(_:)</div><div class="line">func constraint[Less|Greater]ThanOrEqualToAnchor(_:multiplier:)</div><div class="line">func constraint[Less|Greater]ThanOrEqualToAnchor(</div><div class="line">  _:multiplier:constant:)</div></pre></td></tr></table></figure>
<blockquote>
<p>heightAnchor 和 widthAnchor 都是属于 <code>NSLayoutDimension</code>，而文档的意思只有涉及这两种才会用到 <code>multiplier</code></p>
</blockquote>
<p>还有注意的一点就是使用这些 <code>NSLayoutAnchor</code> 构建约束时，类型必须一致。即 <code>constraint[Equal|LessThanOrEqual|GreaterThanOrEqual]ToAnchor</code> 这些方法的两个对象的 anchor 类型必须一致。</p>
<ul>
<li>NSLayoutDimension 只能和 NSLayoutDimension</li>
<li>NSLayoutXAxisAnchor 只能和 NSLayoutXAxisAnchor</li>
<li>NSLayoutYAxisAnchor 只能和 NSLayoutYAxisAnchor</li>
</ul>
<p>不一致 OC 会警告</p>
<p><img src="/images/ibt37.jpg" alt="ibt37"></p>
<p>而 Swift 会直接报错</p>
<p><img src="/images/ibt38.jpg" alt="ibt38"></p>
<h3 id="Layout-guides"><a href="#Layout-guides" class="headerlink" title="Layout guides"></a>Layout guides</h3><p>layout guide 解决了你之前用 dummy view 才能解决的布局问题，将 layout guide 想象成一个隐形的矩形或 view 层级上的框架，你可以利用矩形的边缘来布局，就和你之前加个 dummy view 用法完全一样，你可以在上面添加约束什么的。</p>
<p>这样做的好处就是轻量，没有副作用，之前 dummy view 虽然也是隐形的，但毕竟在 view 层级结构中，还是要参与消息传递过程。</p>
<p>UILayoutGuide 定义的这个矩形区域也能很好的与 Auto Layout 交互</p>
<p>下面来解决一个布局问题</p>
<p><img src="/images/ibt39.jpg" alt="ibt39"></p>
<p>红框圈出的 cell 文字没有居中，原因也很简单，设置了 label 的 top constant 为固定值（15），这个 value 在单行文字正常，多行就有问题了。</p>
<p><img src="/images/ibt40.jpg" alt="ibt40"></p>
<p>在 iOS 9 之前，你可能会创建一个 dummy container view 来居中，现在则完全可以用 layout guide 来做</p>
<p>目前 layout guide 还只能通过代码添加，在 awakeFromNib(): 中添加如下代码：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">// 1 为 cell 的 contentView 添加 layoutGuide</span></div><div class="line"><span class="keyword">let</span> layoutGuide = <span class="type">UILayoutGuide</span>()</div><div class="line">contentView.addLayoutGuide(layoutGuide)</div><div class="line"><span class="comment">// 2</span></div><div class="line"><span class="keyword">let</span> topConstraint = layoutGuide.topAnchor</div><div class="line">  .constraintEqualToAnchor(nameLabel.topAnchor)</div><div class="line"><span class="comment">// 3</span></div><div class="line"><span class="keyword">let</span> bottomConstraint = layoutGuide.bottomAnchor</div><div class="line">  .constraintEqualToAnchor(locationNameLabel.bottomAnchor)</div><div class="line"><span class="comment">// 4</span></div><div class="line"><span class="keyword">let</span> centeringConstraint = layoutGuide.centerYAnchor</div><div class="line">  .constraintEqualToAnchor(contentView.centerYAnchor)</div><div class="line"><span class="comment">// 5</span></div><div class="line"><span class="type">NSLayoutConstraint</span>.activateConstraints(</div><div class="line">  [topConstraint, bottomConstraint, centeringConstraint])</div></pre></td></tr></table></figure>
<p>首先为 cell 的 contentView 添加 layoutGuide，其实就相当于给 cell 的 contentView 加了一个隐形的矩形框（尺寸等于 contentView 的 frame），接着利用 layoutGuide 的 Anchor 对象创建需要的约束，最后一步激活这些约束。</p>
<blockquote>
<p><code>activateConstraints(_:)</code> 是从 iOS 8 开始，苹果推荐使用的</p>
</blockquote>
<p>再次运行，居中问题似乎解决了</p>
<p><img src="/images/ibt41.jpg" alt="ibt41"></p>
<p>不过仔细一看，之前 cell 的内容确实居中了，不过 下面的 locationNameLabel 被压扁了。还记得之前提到过『label 的 top constant 被设为固定值（15）』吗？我们现在已经通过 layout guide 设置了居中，不再需要这个 <code>top</code> 约束了。</p>
<p>直接在 Xcode 中删除的话，会报错缺失约束，这是因为我们通过 layout guide 添加的那些约束只有在运行时才会生效，所以暂时还不能删掉这个 top 约束，还好，Xcode 已经提供了解决方案，在 <code>top</code> 约束 的 <code>Placeholder</code> 上打上勾即可。</p>
<p><img src="/images/ibt42.jpg" alt="ibt42"></p>
<p>这样，top 约束 会在运行时移除，Xcode 也不会报错了</p>
<p>最后运行，一切 OK</p>
<p><img src="/images/ibt43.jpg" alt="ibt43"></p>
<hr>
<h2 id="Chapter-8-Intermediate-UIStackView"><a href="#Chapter-8-Intermediate-UIStackView" class="headerlink" title="Chapter 8: Intermediate UIStackView"></a>Chapter 8: Intermediate UIStackView</h2><p>上一章已经学习了 Stack View 的用法，现在我们可以将之前手工添加的约束统一改为 Stack View 的形式了。</p>
<h3 id="Your-first-vertical-stack-view"><a href="#Your-first-vertical-stack-view" class="headerlink" title="Your first vertical stack view"></a>Your first vertical stack view</h3><p>现在我们来创建一个内部是垂直布局的 stack view，很简单将下面两个 Lable 选中，加入 stack view：</p>
<p><img src="/images/ibt44.jpg" alt="ibt44"></p>
<p>记得对 stack view 与周围的元素添加相应的约束</p>
<p><img src="/images/ibt45.jpg" alt="ibt45"></p>
<h3 id="Alignment"><a href="#Alignment" class="headerlink" title="Alignment"></a>Alignment</h3><p>在 Xcode 上设置 aligment 其实对应着枚举对象 <code>UIStackViewAlignment</code> 的 <code>alignment</code> 属性。分别在垂直和水平方向上对应着不同值：</p>
<p><img src="/images/ibt46.jpg" alt="ibt46"></p>
<p>Horizontal axis:</p>
<p><img src="/images/ibt47.jpg" alt="ibt47"></p>
<p>Vertical axis:</p>
<p><img src="/images/ibt48.jpg" alt="ibt48"></p>
<p>FirstBaseline and LastBaseline:</p>
<p><img src="/images/ibt49.jpg" alt="ibt49"></p>
<p>下面我们给 WEATHER 这部分加入 stack view，点击 Hiden，底下的内容会隐藏，同时注意 RATING 星星的变化：</p>
<p><img src="/images/ibt50.gif" alt="ibt50"></p>
<p>Stack view 按如下方式组织，且与周边元素添加合适的约束。</p>
<p><img src="/images/ibt51.jpg" alt="ibt51"></p>
<h3 id="Top-level-stack-view"><a href="#Top-level-stack-view" class="headerlink" title="Top-level stack view"></a>Top-level stack view</h3><p>现在我们有了五个 Stack View，并设置他们之间的约束，那么为什么不更进一步，把这五个 Stack View 也嵌入到 Stack View 中，这样我们就不用设置他之间的约束了。</p>
<p><img src="/images/ibt52.jpg" alt="ibt52"></p>
<p>在最外层加一个 Stack View，设置内部元素垂直布局，且间隔为 20。</p>
<p><img src="/images/ibt53.jpg" alt="ibt53"></p>
<blockquote>
<p>注意，把元素添加到 StackView，会清除掉该元素上的所有约束</p>
</blockquote>
<h3 id="Arranged-subviews"><a href="#Arranged-subviews" class="headerlink" title="Arranged subviews"></a>Arranged subviews</h3><p>观察上面的动图，WEATHER 位于 WHAT TO SEE 的下面，而他们现在都在 Stack View 里了，只需要在 Xcode 里简单的拖动一下二者的顺序就好。</p>
<p><code>UIStackView</code> 其实专门有一个属性 <code>arrangedSubviews</code> 数组来存储这些 View，而 <code>arrangedSubviews</code> 数组的索引也就是 StackView 中 view 的排列顺序。</p>
<p><code>UIStackView</code> 还有一个继承自 UIView 的 subviews 属性，该属性的含义与 UIView 的相同，是指自身层级结构中包含的子 View，而他的索引主要表示在 Z 轴维度上子 View 的排列顺序。</p>
<p>在 StoryBoard 左边栏（outline view），展开一个 StackView 里面的 views 其实都是 arrangedSubviews，而你想要给 StackView 添加一个 subviews，则只能通过代码方式</p>
<p>除了在Storyboard 中拖动 stackView 里的 views，你还可以通过代码的方式来实现：</p>
<ul>
<li><code>addArrangedSubview(_:)</code></li>
<li><code>insertArrangedSubview(_:atIndex:)</code></li>
<li><code>removeArrangedSubview(_:)</code></li>
</ul>
<blockquote>
<p>执行这些操作，仅对布局有影响，并不会改变真正的 view 层级中的 subviews</p>
</blockquote>
<h3 id="Size-class-based-configuration"><a href="#Size-class-based-configuration" class="headerlink" title="Size class based configuration"></a>Size class based configuration</h3><p>Stack View 还可以和 Size Class 配合起来满足各种需要，比如我们设置 vertical size class 为 compact 时，缩减 Stack View 内部元素之间的间距（由 20 减到 10）</p>
<p><img src="/images/ibt54.jpg" alt="ibt54"></p>
<p>为 Spacing 添加一个 size class（Any Width &gt; Compact Height）</p>
<p><img src="/images/ibt55.jpg" alt="ibt55"></p>
<p>为新 size class 下的 Spacing 设置 10</p>
<p><img src="/images/ibt56.jpg" alt="ibt56"></p>
<p>运行一下，横屏过来是不是更紧凑了呢</p>
<p><img src="/images/ibt57.jpg" alt="ibt57"></p>
<h3 id="Animation"><a href="#Animation" class="headerlink" title="Animation"></a>Animation</h3><p>还记得我们之前点击 Hidden 按钮的界面动画吗，整个 WEATHER 的详细内容被隐藏掉了，实现起来也很简单：用一个 BOOL 属性 <code>shouldHideWeatherInfo</code> 来存储当前是否应当被隐藏，然后根据这个属性来执行一些动画</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> animated &#123;</div><div class="line">      <span class="type">UIView</span>.animateWithDuration(<span class="number">0.3</span>,</div><div class="line">        delay: <span class="number">0.0</span>,</div><div class="line">        usingSpringWithDamping: <span class="number">0.6</span>,</div><div class="line">        initialSpringVelocity: <span class="number">10</span>,</div><div class="line">        options: [],</div><div class="line">        animations: &#123;</div><div class="line">          <span class="keyword">self</span>.weatherInfoLabel.hidden = shouldHideWeatherInfo</div><div class="line">        &#125;, completion: &#123; finished <span class="keyword">in</span></div><div class="line">          <span class="type">UIView</span>.animateWithDuration(<span class="number">0.3</span>) &#123;</div><div class="line">            <span class="keyword">self</span>.ratingStackView.axis =</div><div class="line">              shouldHideWeatherInfo ? .<span class="type">Vertical</span> : .<span class="type">Horizontal</span></div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      )</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      weatherInfoLabel.hidden = shouldHideWeatherInfo</div><div class="line">      ratingStackView.axis = shouldHideWeatherInfo ? .<span class="type">Vertical</span> : .<span class="type">Horizontal</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>注意，最后在 Completion Block 中（完成动画的时候）将 RATING 这部分对应的 StackView axis 布局做出相应的调整，根据当前的隐藏状态（shouldHideWeatherInfo）来决定 <code>Vertical</code> or <code>Horizontal</code>（隐藏垂直布局，不隐藏水平布局）</p>
<hr>
<h2 id="Chapter-9：What’s-New-in-Storyboards"><a href="#Chapter-9：What’s-New-in-Storyboards" class="headerlink" title="Chapter 9：What’s New in Storyboards?"></a>Chapter 9：What’s New in Storyboards?</h2><p>Xcode 7 带来了如下新特性：</p>
<ul>
<li>将单个 storyboard 分割成多个 storyboards，然后通过 storyboard references 将他们连接起来</li>
<li>使用 scene dock 为 view controller 添加 supplementary views</li>
<li>为 navigation bar 添加多个 buttons</li>
</ul>
<h3 id="Storyboard-references"><a href="#Storyboard-references" class="headerlink" title="Storyboard references"></a>Storyboard references</h3><p>之前团队开发一般都避免使用 storyboard，因为最后 merge 的时候着实蛋疼。现在的 Xcode 7 允许每个人维护一个小 storyboard，然后通过 storyboard references 将这些 storyboards 连接起来，一举解决了冲突问题。</p>
<h3 id="Creating-your-first-storyboard-reference"><a href="#Creating-your-first-storyboard-reference" class="headerlink" title="Creating your first storyboard reference"></a>Creating your first storyboard reference</h3><p>一般可以考虑将一个容器 view controller 单独放到一个新 storyboard 中。</p>
<p><img src="/images/ibt58.jpg" alt="ibt58"></p>
<p>拖选 scene，选择 <code>Editor\Refactor to Storyboard</code>，输入 <code>name</code>，设置 <code>Gruop</code>，保存。</p>
<p>Xcode 做了这么三件事:</p>
<ul>
<li>将选中的 scenes 放到新的 storyboard 中</li>
<li>将 tab bar controller 的 <code>view controllers</code> 指向其他 storyboard</li>
<li>将你带到新的 storyboard</li>
</ul>
<p>这个新创建的 storyboard 中 scenes 的布局和之前的也是一模一样</p>
<p><img src="/images/ibt59.jpg" alt="ibt59"></p>
<p>原来的 main storyboard 变成了下面的样子</p>
<p><img src="/images/ibt60.jpg" alt="ibt60"></p>
<p>被移走的 scenes 变成了 <code>storyboard reference</code></p>
<p>如果 <code>Editor\Refactor to Storyboard</code> 这步没有输入 <code>name</code>，Xcode 会自动给你生成一个，还是自己起一个有含义的名字吧</p>
<p>还是在 main storyboard 中，注意被移走的 scenes 留下了一个 <code>ChecklistsNavigationController</code> （referenceID），其实这个 ID 对应着将会 segue 的 VC</p>
<p><img src="/images/ibt61.jpg" alt="ibt61"></p>
<p>你也可以移除这个 <code>referenceID</code>，这样默认的 segue 指向下一个 storyboard 中的 Initial View Controller（当然你要在该 storyboard 中设置了 Initial View Controller 才行）</p>
<h3 id="Storyboards-within-a-team"><a href="#Storyboards-within-a-team" class="headerlink" title="Storyboards within a team"></a>Storyboards within a team</h3><p>如果你是一个团队成员，tabBar VC 里面的一个 VC 由你的同事完成，现在需要集成起来。步骤也很简单：</p>
<p>在 Main.storyboard 所在目录层级，点击 File\Add Files to 『当前工程目录』，选择你同事完成的文件夹（包含 swift 和 storyboard 文件），再到 Main.storyboard 中创建一个 <code>storyboard reference</code>指向这个新创建的文件夹中的 storyboard</p>
<h3 id="Focusing-on-a-storyboard"><a href="#Focusing-on-a-storyboard" class="headerlink" title="Focusing on a storyboard"></a>Focusing on a storyboard</h3><p>如果你有一个很大的工程，导航到达一个场景需要点击很多次，进入很多层级才能实现，此时可以按照功能单元来划分 storyboard，比如下面的，将点击 tableView cell 进入详情页面单独划分到一个 storyboard 中</p>
<p><img src="/images/ibt62.jpg" alt="ibt62"></p>
<p>剩下的操作和上面相同，现在我们回到主程序界面，在 Main Interface 中选择我们刚才创建的 storyboard</p>
<p><img src="/images/ibt63.jpg" alt="ibt63"></p>
<p>这样做的好处是，运行程序会直接从该 storyboard 的起始 VC 运行，也就是 App 一运行就会进入详情页面</p>
<p><img src="/images/ibt64.jpg" alt="ibt64"></p>
<blockquote>
<p>注意，因为没有从 main.storyboard 以及前面的 storyboard 启动，因此也不会出现 <code>navigation bar</code> 或 <code>tab bar</code> 还有要注意的一点是，如果当前的 initial VC 需要前面的 segue 提供数据，就会失败</p>
</blockquote>
<h3 id="Views-in-the-scene-dock"><a href="#Views-in-the-scene-dock" class="headerlink" title="Views in the scene dock"></a>Views in the scene dock</h3><p>storyboard 有一个容易被忽视的特性 scene dock，在 storyboard 中选中一个 scene</p>
<p><img src="/images/ibt65.jpg" alt="ibt65"></p>
<p>注意到上面三个个小图标了吗？分别对应着：</p>
<ul>
<li>当前 VC 的引用</li>
<li>第一响应者</li>
<li>unwind segues</li>
</ul>
<p>Xcode 7 现在允许你添加自定义的 view 到这上面（scene dock）去了。添加到 scene dock 上的 view 并不会同时添加到 view controller 的 subviews 数组中去，但是，你可以通过 IBOutlets 连续的方式添加一个引用，方面在运行时使用这个 view。</p>
<p>我们为上面选中 tableView row 添加一个背景颜色，首先拖一个 view 到 <code>tableView controller</code> 的 <code>scene dock</code> 上。</p>
<p><img src="/images/ibt66.jpg" alt="ibt66"></p>
<p>下面改变这个 view 的背景色为橙色，最后通过 Ctrl-drag 从 cell 到 view 拉一条连线，在弹出的菜单中选择 <code>selectedBackgroundView</code>，可供选择的还有 <code>accessoryView</code>、<code>backgroundView</code>、<code>editingAccessoryView</code>。运行 OK~</p>
<p><img src="/images/ibt67.jpg" alt="ibt67"></p>
<blockquote>
<p>并不支持多行选中启用的情形，因为在运行时只有一个 view 实例被创建，然后共享给各个 cell</p>
</blockquote>
<h3 id="Conditional-views-using-the-scene-dock"><a href="#Conditional-views-using-the-scene-dock" class="headerlink" title="Conditional views using the scene dock"></a>Conditional views using the scene dock</h3><p>如果你需要根据需要动态添加 View，那么就可以使用 scene dock 放置 view 的方式来实现，使用该方式的优势在于这个 view 不会对 view controller 中的 subviews 做出干扰，你可以之后使用代码方式动态将其添加到 view 层级结构中</p>
<p>现在我们来实现点击一行 table view cell，该行会延展其高度得到额外的空间显示 note，再次点击或点击不同的 row 又会恢复回去。</p>
<p>这次依然是拖一个 view 到 scene dock 上，设置 <code>width：320</code>，<code>height：128</code>。再拉一个 label 到这个 view 上，修改文字颜色（屎黄色🌝）</p>
<p><img src="/images/ibt68.jpg" alt="ibt68"></p>
<p>接着拉一个 <code>text view</code> 到新 view 上紧挨着之前的 label 下面</p>
<p><img src="/images/ibt69.jpg" alt="ibt69"></p>
<p>现在可以从 notes view 到 view controller 拖一个 IBOutlet，尽管屏幕上一次会显示多个 cell 实例，但每次只有点击了才会展示 note view，且始终只会展示一个，所以不用太担心只有一个 IBOutlet 会出问题。</p>
<p>现在从 notes view 拉两个 IBOutlet：</p>
<ul>
<li><code>notesView</code>（自身 view）</li>
<li><code>notesTextView</code>（text view）</li>
</ul>
<p>前面学过了 UIStackView，这里确保 Auto Layout 约束了 notes view 的高度，然后添加到 cell 的 stack view 中去，设置 clipsToBounds 是为了在左滑删除时阻止 text view 跑到 cell 外面去</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">addNotesViewToCell</span><span class="params">(cell: ChecklistItemTableViewCell)</span></span> &#123;</div><div class="line">  notesView.heightAnchor</div><div class="line">    .constraintEqualToConstant(notesViewHeight)</div><div class="line">    .active = <span class="literal">true</span></div><div class="line">  notesView.clipsToBounds = <span class="literal">true</span></div><div class="line"></div><div class="line">  cell.stackView.addArrangedSubview(notesView)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里使用 Auto Layout，是因为 <code>stack view</code> 的高度源自于他 <code>arrangedSubviews</code>，如果你这里不给 notesView 设置个高度，cell 不会在你添加 notes view 时自动增加高度。</p>
<p>下面移除 notes view：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeNotesView</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> stackView = notesView.superview <span class="keyword">as</span>? <span class="type">UIStackView</span> &#123;</div><div class="line">    stackView.removeArrangedSubview(notesView)</div><div class="line">    notesView.removeFromSuperview()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后实现点击 cell row 出现 notes view 的效果：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView,</span></span></div><div class="line">  didSelectRowAtIndexPath indexPath: NSIndexPath) &#123;</div><div class="line"><span class="comment">// 1</span></div><div class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> cell = tableView.cellForRowAtIndexPath(indexPath)</div><div class="line">    <span class="keyword">as</span>? <span class="type">ChecklistItemTableViewCell</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line"><span class="comment">// 2</span></div><div class="line">  tableView.beginUpdates()</div><div class="line"><span class="comment">// 3</span></div><div class="line">  <span class="keyword">if</span> cell.stackView.arrangedSubviews.<span class="built_in">contains</span>(notesView) &#123;</div><div class="line">    removeNotesView()</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    addNotesViewToCell(cell)</div><div class="line"><span class="comment">// 4</span></div><div class="line">    notesTextView.text = checklist.items[indexPath.row].notes</div><div class="line">  &#125;</div><div class="line"><span class="comment">// 5</span></div><div class="line">  tableView.endUpdates()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再次运行（这次注意将 Main Interface 改回 Main），点击任意 cell，你会看到 notes view 跑出来</p>
<p><img src="/images/ibt70.jpg" alt="ibt70"></p>
<blockquote>
<p>这种方式创建的 view 只能由一个 VC 使用，如果 view 需要重用，那么还是用代码整吧</p>
</blockquote>
<h3 id="Using-multiple-bar-buttons"><a href="#Using-multiple-bar-buttons" class="headerlink" title="Using multiple bar buttons"></a>Using multiple bar buttons</h3><p>Xcode 7 现在支持在 navigation bar 上直接添加多个 buttons 了</p>
<p><img src="/images/ibt71.jpg" alt="ibt71"></p>
<p>拖一个 bar button item 到 navigation bar 上，xcode 会自动为你创建一个 Left Bar Button Items 和 Right Bar Button Items，现在添加两个 bar button 到 navigation bar 上来</p>
<p><img src="/images/ibt72.jpg" alt="ibt72"></p>
<p>你可以通过 <code>rightBarButtonItems</code> 或 <code>leftBarButtonItems</code> 来获取</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">navigationItem.rightBarButtonItems![<span class="number">1</span>] = editButtonItem()</div></pre></td></tr></table></figure>
<blockquote>
<p>注意 leftBarButtonItems 数组中元素的顺序代表从左到右，而 rightBarButtonItems 则相反，代表从右到左，即最右边索引为 0</p>
</blockquote>
<hr>
<h2 id="Chapter-10-Custom-Segues"><a href="#Chapter-10-Custom-Segues" class="headerlink" title="Chapter 10: Custom Segues"></a>Chapter 10: Custom Segues</h2><p>iOS 9 通过自定义 segues 的方式 使 transition animation 和 view controller 在代码部分彻底分离。</p>
<p>还有比较重要的一点变化是 segues 可以在转场过程（modal or popover presentations of scenes）中被保留了（retained），通过 segues 导航到一个新的场景 VC，此时该 segues 已经初始化，之后一直被保留在内存中，直到该场景 VC 被 dismiss 掉，segues 才会被释放。</p>
<p>这意味着你可以将所有转场动画（transition’s animation）和自适应（adaptivity）相关代码移入 segue 类，随之带来的好处就是你可以重用这些 segue 了</p>
<p>本章主要内容：</p>
<ul>
<li>创建一个自定义的 segue</li>
<li>通过 segue 实施一个转场动画</li>
<li>使你自定义的 segue 在 navigation 和 tab controller 中重用</li>
</ul>
<p>本章我们要来实现一个宠物照看手册，大概是这个样子</p>
<p><img src="/images/ibt73.jpg" alt="ibt73"></p>
<p>打开 Storyboard 瞄一眼</p>
<p><img src="/images/ibt74.jpg" alt="ibt74"></p>
<p>现在还没有任何转场效果，下面我们来添加</p>
<h3 id="What-are-segues"><a href="#What-are-segues" class="headerlink" title="What are segues?"></a>What are segues?</h3><p>Segue 描述了两个 VC 之间的转换，有四种类型的 segues</p>
<ul>
<li>Show：将一个 VC push 到 navigation controller 上</li>
<li>Show Detail：使用 UISplitViewController 时替换一个 detail 场景</li>
<li>Present Modally</li>
<li>Popover</li>
</ul>
<blockquote>
<p>将一个 child VC 嵌入到容器 VC 这种 Relationships 关系虽然也是 segue，但不能自定义</p>
</blockquote>
<p>iOS 9 现在可以在上面四种 Segue 类型的基础上加入自定义的选项</p>
<p><img src="/images/ibt75.jpg" alt="ibt75"></p>
<h3 id="A-simple-segue"><a href="#A-simple-segue" class="headerlink" title="A simple segue"></a>A simple segue</h3><p>我们先来实现一个简单的 segue，用户点击一张宠物缩略图，model 展示一张大尺寸照片。实现需要分为两个步骤：</p>
<ul>
<li>设置 segue，<code>prepareForSegue(_:sender:)</code> 准备一些 destination VC 需要的数据</li>
<li>执行前往 destination VC 的转场动画，通常使用默认的，但这次我们来定制他</li>
</ul>
<p>Storyboard 选中 <code>Animal Detail View Controller</code> ，往上面的宠物缩略图拖一个 <code>Tap Gesture Recognizer</code> ，之后从这个 Tap 手势 Ctrl-drag 拉条线到 <code>Animal Photo View Controller</code> 来展示宠物大照片，过渡方式选择 <code>present modally</code></p>
<p>我们命名该 segue 为 PhotoDetail，之后在 <code>prepareForSegue</code> 做点准备工作</p>
<p><img src="/images/ibt76.jpg" alt="ibt76"></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepareForSegue</span><span class="params">(segue: UIStoryboardSegue,</span></span></div><div class="line">  sender: AnyObject?) &#123;</div><div class="line">  <span class="keyword">if</span> segue.identifier == <span class="string">"PhotoDetail"</span> &#123;</div><div class="line">    <span class="keyword">let</span> controller = segue.destinationViewController</div><div class="line">      <span class="keyword">as</span>! <span class="type">AnimalPhotoViewController</span></div><div class="line">    controller.image = imageView.image</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>为了 Dismiss，紧挨上面的方法添加一个 unwind 方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">unwindToAnimalDetailViewController</span><span class="params">(</span></span></div><div class="line">  segue:UIStoryboardSegue) &#123;</div><div class="line">  <span class="comment">// placeholder for unwind segue</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样的给 <code>Animal Photo View Controller</code> 上的宠物打照片加个 Tap 手势，Ctrl-drag 拉到 <code>Exit</code>，选择 <code>unwindToAnimalDetailViewController:</code></p>
<p><img src="/images/ibt77.jpg" alt="ibt77"></p>
<p>运行，点击金鱼小图片，会跳转大图片，再点击大图片，又会回到小图片</p>
<p><img src="/images/ibt78.jpg" alt="ibt78"></p>
<p>现在我们来分析下整个过程，伴随着点击缩略图，一个从 <code>AnimalDetailViewController</code> 到 <code>AnimalPhotoViewController</code> 的 model segue 初始化，该 segue 保持了 source 和 destination VC 的引用。</p>
<p><img src="/images/ibt79.jpg" alt="ibt79"></p>
<p>这个 segue 其实在幕后设置了 destination VC 的 <code>transitioning delegate</code>，并且根据当前 <code>size class</code> 设置了 <code>presentation</code></p>
<p>而 source VC 的 <code>prepareForSegue(_:sender:)</code> 主要为 destination VC 准备了所需要的数据</p>
<p>系统过渡到 destination VC 时，destination view controller 会调用他的 transition delegate 来执行动画（默认设置）</p>
<p>以上就是关于 Segue 的一些基本常识</p>
<h3 id="Your-custom-segue-library"><a href="#Your-custom-segue-library" class="headerlink" title="Your custom segue library"></a>Your custom segue library</h3><p>因为 Segue 在整个过渡过程中都是存在的，所以你可以将 UIViewController 中写的过渡代码转移到自定义的 seuges 类中来，segue 可以同时负责 <code>presentation</code> 和 <code>dismissal</code> 的过渡过程</p>
<p>我们这里已经创建了一个自定义的 seuges 类 DropSegue，在 Storyboard 中的 Segue Class 选择这个自定义类即可</p>
<p><img src="/images/ibt80.jpg" alt="ibt80"></p>
<p>现在运行，你会发现过渡动画效果完全不一样了呢</p>
<h3 id="Creating-a-custom-segue"><a href="#Creating-a-custom-segue" class="headerlink" title="Creating a custom segue"></a>Creating a custom segue</h3><p>看完了上面的，我们来创建一个自己的 segue 来取代 <code>DropSegue</code>，这个 segue 的过渡动画采用 Scale transition animation</p>
<p><img src="/images/ibt81.jpg" alt="ibt81"></p>
<p>进行实际操作前，先熟悉下下面几个方法：</p>
<ul>
<li><code>UIViewControllerTransitioningDelegate:</code> 自定义的 segue 部署这个协议来声明一个动画对象用在 presentation 和 dismissal 时</li>
<li><code>UIViewControllerAnimatedTransitioning:</code> 上面定义的动画对象部署这个协议来描述动画过程</li>
<li><code>UIViewControllerContextTransitioning:</code> 这个 context 包含所有关于 presentingVC 和 presentedVC 以及 views 的细节。你之后会传递给 animator 对象。</li>
</ul>
<p>在开始前，先来回顾下创建一个 animated segue 的步骤：</p>
<ol>
<li>创建 <code>UIStoryboardSegue</code> 的子类 segue，然后设置为 <code>destination controller</code> 的 <code>transitioning delegate</code></li>
<li>创建 presenting 和 dismissing 的 animator classes</li>
<li>定义一个 <code>animation</code> 并设置持续时间，将会用在第 2 步的 <code>animators</code> 中</li>
<li>构造一个 <code>segue</code>，animator 类将会用来 presentation 和 dismissal</li>
<li>最后，在 <code>storyboard</code> 中使用这个 <code>segue</code></li>
</ol>
<p>下面我们逐一来实现</p>
<h4 id="1-Subclass-UIStoryboardSegue"><a href="#1-Subclass-UIStoryboardSegue" class="headerlink" title="1.Subclass UIStoryboardSegue"></a>1.Subclass UIStoryboardSegue</h4><p>创建一个 <code>UIStoryboardSegue</code> 的子类 ScaleSegue.swift，用来部署 transitioning delegate 协议，从而指定自定义的转场动画</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScaleSegue</span>: <span class="title">UIStoryboardSegue</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">perform</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="comment">// 在执行转场时指定 transitioningDelegate</span></div><div class="line">    destinationViewController.transitioningDelegate = <span class="keyword">self</span></div><div class="line">    <span class="keyword">super</span>.perform()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>之前的版本你可能会把 转场动画放进 perform 中，而现在你让 segue 部署 <code>transitioning delegate</code> 来解耦</p>
<h4 id="2-Create-the-animator"><a href="#2-Create-the-animator" class="headerlink" title="2.Create the animator"></a>2.Create the animator</h4><p>现在我们把注意力放在创建一个转场动画上，添加一个 animator class <code>ScalePresentAnimator</code> 用来表现一段 modal 动画，dismissal 动画还未设定，先用系统提供的</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalePresentAnimator</span> : <span class="title">NSObject</span>, <span class="title">UIViewControllerAnimatedTransitioning</span> </span>&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-Define-the-animation"><a href="#3-Define-the-animation" class="headerlink" title="3.Define the animation"></a>3.Define the animation</h4><p>实现动画</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScalePresentAnimator</span> : <span class="title">NSObject</span>, <span class="title">UIViewControllerAnimatedTransitioning</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">transitionDuration</span><span class="params">(</span></span></div><div class="line">    transitionContext: UIViewControllerContextTransitioning?)</div><div class="line">    -&gt; <span class="type">NSTimeInterval</span> &#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">2.0</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">animateTransition</span><span class="params">(transitionContext:</span></span></div><div class="line">    UIViewControllerContextTransitioning) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 1. Get the transition context to- controller and view</span></div><div class="line">    <span class="keyword">let</span> toViewController = transitionContext</div><div class="line">      .viewControllerForKey(</div><div class="line">        <span class="type">UITransitionContextToViewControllerKey</span>)!</div><div class="line">    <span class="keyword">let</span> toView = transitionContext</div><div class="line">      .viewForKey(<span class="type">UITransitionContextToViewKey</span>)</div><div class="line"></div><div class="line">    <span class="comment">// 2. Add the to- view to the transition context</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> toView = toView &#123;</div><div class="line">      transitionContext.containerView()?.addSubview(toView)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 3. Set up the initial state for the animation</span></div><div class="line">    toView?.frame = .zero</div><div class="line">    toView?.layoutIfNeeded()</div><div class="line"></div><div class="line">    <span class="comment">// 4. Perform the animation</span></div><div class="line">    <span class="keyword">let</span> duration = transitionDuration(transitionContext)</div><div class="line">    <span class="keyword">let</span> finalFrame = transitionContext</div><div class="line">      .finalFrameForViewController(toViewController)</div><div class="line"></div><div class="line">    <span class="type">UIView</span>.animateWithDuration(duration, animations: &#123;</div><div class="line">      toView?.frame = finalFrame</div><div class="line">      toView?.layoutIfNeeded()</div><div class="line">    &#125;, completion: &#123;</div><div class="line">      finished <span class="keyword">in</span></div><div class="line">      <span class="comment">// 5. Clean up the transition context</span></div><div class="line">      transitionContext.completeTransition(<span class="literal">true</span>)</div><div class="line">    &#125;)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="4-Set-the-animator-in-the-segue"><a href="#4-Set-the-animator-in-the-segue" class="headerlink" title="4.Set the animator in the segue"></a>4.Set the animator in the segue</h4><p>上面提到以前我们会将动画的实现放在 perform 中，现在我们让 segue 部署 <code>transitioning delegate</code> 来解耦</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">ScaleSegue</span>: <span class="title">UIViewControllerTransitioningDelegate</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">animationControllerForPresentedController</span><span class="params">(presented: UIViewController, presentingController presenting: UIViewController, sourceController source: UIViewController)</span></span> -&gt; <span class="type">UIViewControllerAnimatedTransitioning</span>? &#123;</div><div class="line">    <span class="keyword">return</span> <span class="type">ScalePresentAnimator</span>()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="5-Use-the-segue-in-the-storyboard"><a href="#5-Use-the-segue-in-the-storyboard" class="headerlink" title="5.Use the segue in the storyboard"></a>5.Use the segue in the storyboard</h4><p>在 Storyboard Segue 选择刚才创建的自定义 segue 就好，Presentation 选择 Form Sheet 是为了在 iPad 上有更好的体验</p>
<p><img src="/images/ibt82.jpg" alt="ibt82"></p>
<p>运行，点击宠物缩略图，无码大图从左上角伸展开来铺满整个屏幕</p>
<p><img src="/images/ibt83.jpg" alt="ibt83"></p>
<h3 id="Passing-data-to-animators"><a href="#Passing-data-to-animators" class="headerlink" title="Passing data to animators"></a>Passing data to animators</h3><p>现在来继续改进，我们希望点击小图后，就在原有位置上小图伸展开来变成大图，而不是从左上角开始出来一个 view。那就需要告诉 animator 对象哪个 view 将会被 scale，最简单的方式是保持一个对 source image view 的引用，但用 Protocols 来实现更好一些</p>
<p>定义一个 Protocol，返回一个可以被 Scale 的 View</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">ViewScaleable</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> scaleView: <span class="type">UIView</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>任何使用自定义的 segue 的 VC 都能实现这个 <code>ViewScaleable</code> 协议，确定哪个 View 能被 Scale</p>
<p>我们在 <code>AnimalDetailViewController.swift</code>（Presenting VC）中实现这一 Protocol</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AnimalDetailViewController</span>: <span class="title">ViewScaleable</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> scaleView: <span class="type">UIView</span> &#123; <span class="keyword">return</span> imageView &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>表示可以被 Scale 的 view 是 <code>imageView</code>，即本例中的金鱼图片</p>
<p>之前的过渡动画没有用到 <code>fromVC</code>，而现在从 <code>fromView</code> 的位置（即 scaleView）直接展开大图，所以需要在创建 toVC 同时获取到 fromVC</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> fromViewController = transitionContext</div><div class="line">  .viewControllerForKey(</div><div class="line">    <span class="type">UITransitionContextFromViewControllerKey</span>)!</div><div class="line"><span class="keyword">let</span> fromView = transitionContext</div><div class="line">  .viewForKey(<span class="type">UITransitionContextFromViewKey</span>)</div></pre></td></tr></table></figure>
<p>将之前的从左上角开始 <code>toView?.frame = .zero</code> 替代为从 scaleView 的位置开始：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> startFrame = <span class="type">CGRect</span>.zero</div><div class="line"><span class="keyword">if</span> <span class="keyword">let</span> fromViewController = fromViewController</div><div class="line">  <span class="keyword">as</span>? <span class="type">ViewScaleable</span> &#123;</div><div class="line">    startFrame = fromViewController.scaleView.frame</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  <span class="built_in">print</span>(<span class="string">"Warning: Controller \(fromViewController) does not "</span> +</div><div class="line">    <span class="string">"conform to ViewScaleable"</span>)</div><div class="line">&#125;</div><div class="line">toView?.frame = startFrame</div></pre></td></tr></table></figure>
<p>设置 <code>toView</code> 的起始位置为 <code>scaleView</code> 的位置</p>
<blockquote>
<p>因为使用了 ViewScaleable 协议解耦，animator 除了 scaleView 外并不了解关于 source view controller 的信息</p>
</blockquote>
<p>再次运行，现在点击是从原始位置放大了</p>
<p><img src="/images/ibt84.jpg" alt="ibt84"></p>
<h3 id="Working-with-the-view-hierarchy"><a href="#Working-with-the-view-hierarchy" class="headerlink" title="Working with the view hierarchy"></a>Working with the view hierarchy</h3><p>我们之前通过 <code>transitionContext.viewForKey(_:)</code> 来获取 toView</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> toView = transitionContext.viewForKey(<span class="type">UITransitionContextToViewKey</span>)</div></pre></td></tr></table></figure>
<p>或许你会有疑问，为什么不用 PresentedVC（toVC） 的 view 属性直接获取？这是因为 transition context 会基于 size class 处理各种 presentations</p>
<p>在 regular-sized 情形下 modal 视图会以 sheet 的形式展示，并不会铺满整个屏幕。此时我们将屏幕展示的 presentation layer 看做两部分：</p>
<ul>
<li>暗下去的背景</li>
<li>sheet 展示 toVC 的内容</li>
</ul>
<p>在 compact-sized 情形下 modal 视图会全屏展示，此时没有 presentation layer 存在</p>
<p>结论：在 iPhone 设备上，除了 iPhone 6 Plus 横屏，destination controller（PresentedVC）的 <code>view</code> 与 <code>UITransitionContextToViewKey</code> 得到的 view 是一致的。而在 iPad 和 iPhone 6 Plus 横屏情形下，destination controller（PresentedVC）被封装在 <code>presentation layer</code> 进行展示</p>
<p>from view 也是一样，通过 <code>transitionContext.viewForKey(UITransitionContextFromViewKey)</code> 得到的 view 与 source view controller’s view 在不同 size class 下也不相同</p>
<p><code>compact-sized</code> 下，二者一样；<code>regular-sized</code> 下 <code>UITransitionContextFromViewKey</code> 方式得到的 view 会是 nil</p>
<p>最后我们在 <code>compact-sized</code> 下也让 fromView 随过渡动画的发生暗淡下去</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="type">UIView</span>.animateWithDuration(duration, animations: &#123;</div><div class="line">  toView?.frame = finalFrame</div><div class="line">  toView?.layoutIfNeeded()</div><div class="line">  fromView?.alpha = <span class="number">0.0</span></div><div class="line">  &#125;, completion: &#123;</div><div class="line">    finished <span class="keyword">in</span></div><div class="line">    fromView?.alpha = <span class="number">1.0</span></div><div class="line">    <span class="comment">// 5. Clean up the transition context</span></div><div class="line">    transitionContext.completeTransition(<span class="literal">true</span>)</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>上面 <code>fromView?.alpha</code> 仅仅会影响 iPhone，因为在 iPad 上通过 <code>viewForKey</code> 得到的 <code>fromView</code> 为 nil</p>
<h3 id="Handling-embedded-view-controllers"><a href="#Handling-embedded-view-controllers" class="headerlink" title="Handling embedded view controllers"></a>Handling embedded view controllers</h3><p>在 Main.storyboard 中选中最左边的 Navigation Controller 设回 <code>Is Initial View Controller</code>（之前是 <code>AnimalDetailViewController</code>）</p>
<p>运行点击缩略图，发现整个过程凌乱了，大图从左上角跑出来了。。。</p>
<p><img src="/images/ibt85.jpg" alt="ibt85"></p>
<p>原因很简单，之前 <code>AnimalDetailViewController</code> 是 presentingVC，决定哪个 view 可以被 scale，而现在 <code>AnimalDetailViewController</code> 被嵌入到 Nav 中，由 Nav 来接管，Nav 并没有实现 <code>ViewScaleable</code> 协议，所以不知道哪个 view 会被 scale，也就得不到 fromView 的初始位置。</p>
<p>取到的 <code>fromViewController</code> 先做判断，如果是 Nav，再向下取一次 <code>topViewController</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> fromViewController = transitionContext</div><div class="line">  .viewControllerForKey(</div><div class="line">    <span class="type">UITransitionContextFromViewControllerKey</span>)!</div><div class="line"><span class="keyword">if</span> <span class="keyword">let</span> fromNC = fromViewController <span class="keyword">as</span>? <span class="type">UINavigationController</span> &#123;</div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> controller = fromNC.topViewController &#123;</div><div class="line">    fromViewController = controller</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Completing-the-scale-segue-dismissal"><a href="#Completing-the-scale-segue-dismissal" class="headerlink" title="Completing the scale segue dismissal"></a>Completing the scale segue dismissal</h3><p>除了注意 fromVC 和 toVC 与之前 Presenting 不同外，还要注意添加到 containerView 中的顺序</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="keyword">let</span> fromView = fromView,</div><div class="line">  toView = toView &#123;</div><div class="line">  transitionContext.containerView()?</div><div class="line">    .insertSubview(toView, belowSubview: fromView)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="Chapter-11-UIKit-Dynamics"><a href="#Chapter-11-UIKit-Dynamics" class="headerlink" title="Chapter 11: UIKit Dynamics"></a>Chapter 11: UIKit Dynamics</h2><p>iOS 9 更新了他的物理引擎箱，如增加了重力、磁性领域、非矩形碰撞，和一些额外的附属连接行为。本章的主要着眼点在这些新特性上：</p>
<h3 id="Getting-started-1"><a href="#Getting-started-1" class="headerlink" title="Getting started"></a>Getting started</h3><p>打开 playground，添加下面内容：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"><span class="keyword">import</span> XCPlayground</div><div class="line"><span class="keyword">let</span> view = <span class="type">UIView</span>(frame: <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>,</div><div class="line">  width: <span class="number">600</span>, height: <span class="number">600</span>))</div><div class="line">view.backgroundColor = <span class="type">UIColor</span>.lightTextColor()</div><div class="line"><span class="type">XCPShowView</span>(<span class="string">"Main View"</span>, view: view)</div><div class="line"><span class="keyword">let</span> whiteSquare = <span class="type">UIView</span>(frame: <span class="type">CGRect</span>(x: <span class="number">100</span>, y: <span class="number">100</span>,</div><div class="line">  width: <span class="number">100</span>, height: <span class="number">100</span>))</div><div class="line">whiteSquare.backgroundColor = <span class="type">UIColor</span>.whiteColor()</div><div class="line">view.addSubview(whiteSquare)</div><div class="line"><span class="keyword">let</span> orangeSquare = <span class="type">UIView</span>(frame: <span class="type">CGRect</span>(x: <span class="number">400</span>, y: <span class="number">100</span>,</div><div class="line">  width: <span class="number">100</span>, height: <span class="number">100</span>))</div><div class="line">orangeSquare.backgroundColor = <span class="type">UIColor</span>.orangeColor()</div><div class="line">view.addSubview(orangeSquare)</div></pre></td></tr></table></figure>
<p>添加了两个矩形，一白、一橙</p>
<p>接下来创建 UIDynamicAnimator，该类负责管理所有的物理特性。也可以看做是一种媒介用来协调 <code>dynamic items</code>、<code>subviews</code>、<code>dynamic behaviors</code>、<code>iOS 物理引擎</code>。他提供了一个上下文用来计算将要渲染的动画。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> animator = <span class="type">UIDynamicAnimator</span>(referenceView: view)</div></pre></td></tr></table></figure>
<p>Dynamic behaviors 封装了某些特定的物理效果，如重力，引力，弹跳效果。Dynamic animators 在动画过程中负责追踪这些 items，你之前传递进去的 referenceView 可以看做是一张施展动画的画布，因此所有要动画的 views 必须是 referenceView 的子类</p>
<p>给橙色矩形加一个自由落体效果</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">animator.addBehavior(<span class="type">UIGravityBehavior</span>(items: [orangeSquare]))</div></pre></td></tr></table></figure>
<p>一运行橙色矩形就掉下去了（出了屏幕），现在来加个底，让他落在底边上</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">let boundaryCollision = UICollisionBehavior(items:</div><div class="line">  [whiteSquare, orangeSquare])</div><div class="line">boundaryCollision.translatesReferenceBoundsIntoBoundary = true</div><div class="line">animator.addBehavior(boundaryCollision)</div></pre></td></tr></table></figure>
<p>默认的所有 dynamic items 都会有一组行为集合来描述他的重量、下落速度、如何应对碰撞和其他一些物理特性。而这些都是由 <code>UIDynamicItemBehavior</code> 来负责描述</p>
<p>我们来设置一下橙色矩形的碰撞效果</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> bounce = <span class="type">UIDynamicItemBehavior</span>(items: [orangeSquare])</div><div class="line">bounce.elasticity = <span class="number">0.6</span></div><div class="line">bounce.density = <span class="number">200</span></div><div class="line">bounce.resistance = <span class="number">2</span></div><div class="line">animator.addBehavior(bounce)</div></pre></td></tr></table></figure>
<p>一个 <code>dynamic item</code> 的密度（<code>density</code>）和尺寸决定了他的重量，弹力（<code>Elasticity</code>）决定了碰撞后的弹跳效果（默认为 0 ），阻力（<code>Resistance</code>）也就是摩擦力，可以让 <code>dynamic item</code> 在线性运动时停下来</p>
<p>为了更好的观察，开启 debug 模式，现在你能在橙色矩形外看到一个蓝色矩形框（表示碰撞时的边界）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">animator.setValue(<span class="literal">true</span>, forKey: <span class="string">"debugEnabled"</span>)</div></pre></td></tr></table></figure>
<h3 id="Behaviors"><a href="#Behaviors" class="headerlink" title="Behaviors"></a>Behaviors</h3><p>下面来学习一下 UIDynamicBehavior 的七个子类</p>
<ul>
<li>UIAttachmentBehavior： 两个 <code>dynamic items</code> 连接起来或一个 <code>dynamic items</code> 和一个锚点连接在一起</li>
<li>UICollisionBehavior： 描述两个 item 接触时产生的效果，可以用来开启 item 边界： <code>translatesReferenceBoundsIntoBoundary</code> 设为 ture</li>
<li>UIDynamicItemBehavior： dynamic items 的一些物理特性</li>
<li>UIFieldBehavior：这个是 iOS 9 新加的，添加了很多物理场行为，包含电场（electric）、磁场（magnetic）、拖拽（dragging）、漩涡（vortex）、辐射（radial）、线性重力（linear gravity）、速率（velocity）、噪声（noise）、涡流（turbulence）、弹簧场（SpringField）</li>
<li>UIGravityBehavior：模拟重力效果</li>
<li>UIPushBehavior：应用在 <code>dynamic items</code> 上的一种力</li>
<li>UISnapBehavior：将 <code>dynamic items</code> 移动到指定的位置伴随着弹性效果</li>
</ul>
<p>最后你可以将上面七种行为混合组合使用，简单来说就是先创建一个 parentBehavior（<code>UIDynamicBehavior</code>），然后创建上面七个子类中的几个，在通过父类的 addChildBehavior 方法添加到 parentBehavior 中去</p>
<p>来实际例子中玩一下，先给白色矩形加点物理属性：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> parentBehavior = <span class="type">UIDynamicBehavior</span>()</div><div class="line"><span class="keyword">let</span> viewBehavior = <span class="type">UIDynamicItemBehavior</span>(items: [whiteSquare])</div><div class="line">viewBehavior.density = <span class="number">0.01</span></div><div class="line">viewBehavior.resistance = <span class="number">10</span></div><div class="line">viewBehavior.friction = <span class="number">0.0</span></div><div class="line">viewBehavior.allowsRotation = <span class="literal">false</span></div><div class="line">parentBehavior.addChildBehavior(viewBehavior)</div></pre></td></tr></table></figure>
<p>再定义一个弹簧场范围,白色矩形刚好位于其中：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">let fieldBehavior = UIFieldBehavior.springField()</div><div class="line">fieldBehavior.addItem(whiteSquare)</div><div class="line">fieldBehavior.position = CGPoint(x: 150, y: 350)</div><div class="line">fieldBehavior.region = UIRegion(size: CGSizeMake(500, 500))</div><div class="line">parentBehavior.addChildBehavior(fieldBehavior)</div></pre></td></tr></table></figure>
<p>运行</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">animator.addBehavior(parentBehavior)</div></pre></td></tr></table></figure>
<p>开启了 debug 模式，就是下面展示的效果：</p>
<p><img src="/images/ibt86.jpg" alt="ibt86"></p>
<p>Spring fields 弹簧场可以这么理解，你确定当中某个物体的位置，然后对该物体施加一个力，物体也许会偏离一点点，不过最终会稳定在那一点上，就像被栓了跟弹簧。看得不明显？施加一个向上的力来看看：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> delayTime = dispatch_time(<span class="type">DISPATCH_TIME_NOW</span>,</div><div class="line">  <span class="type">Int64</span>(<span class="number">2</span> * <span class="type">Double</span>(<span class="type">NSEC_PER_SEC</span>)))</div><div class="line">dispatch_after(delayTime, dispatch_get_main_queue()) &#123;</div><div class="line">  <span class="keyword">let</span> pushBehavior = <span class="type">UIPushBehavior</span>(items: [whiteSquare],</div><div class="line">    mode: .<span class="type">Instantaneous</span>)</div><div class="line">  pushBehavior.pushDirection = <span class="type">CGVector</span>(dx: <span class="number">0</span>, dy: -<span class="number">1</span>)</div><div class="line">  pushBehavior.magnitude = <span class="number">0.3</span></div><div class="line">  animator.addBehavior(pushBehavior)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Applying-dynamics-to-a-real-app"><a href="#Applying-dynamics-to-a-real-app" class="headerlink" title="Applying dynamics to a real app"></a>Applying dynamics to a real app</h3><p>之前我们都在 playground 里玩，现在我们应用在一个 Real App 上，下面是一个照片浏览应用，主界面 photos 是简单的 collectionView，点进去是一张大图和关于图片的细节信息</p>
<p><img src="/images/ibt87.jpg" alt="ibt87"></p>
<p>我们首先来将目光焦聚在右边大图照片中显示图片细节信息的部分，即照片拍摄的时间、尺寸、和名称。这些信息都显示在一个灰黑色半透明的圆角矩形中。我们来对这个圆角矩形应用一个自定义的 Sticky behavior，即使其变成可拖动的，但无论放置在屏幕的哪个位置，该圆角矩形都会自动慢慢停靠在最上边或最下边的边界上。</p>
<h3 id="Sticky-behavior"><a href="#Sticky-behavior" class="headerlink" title="Sticky behavior"></a>Sticky behavior</h3><figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StickyEdgesBehavior</span>: <span class="title">UIDynamicBehavior</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">var</span> edgeInset: <span class="type">CGFloat</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">let</span> itemBehavior: <span class="type">UIDynamicItemBehavior</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">let</span> collisionBehavior: <span class="type">UICollisionBehavior</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">let</span> item: <span class="type">UIDynamicItem</span></div><div class="line">  <span class="keyword">private</span> <span class="keyword">let</span> fieldBehaviors = [</div><div class="line">    <span class="type">UIFieldBehavior</span>.springField(),</div><div class="line">    <span class="type">UIFieldBehavior</span>.springField()</div><div class="line">  ]</div><div class="line"></div><div class="line">  <span class="keyword">init</span>(item: <span class="type">UIDynamicItem</span>, edgeInset: <span class="type">CGFloat</span>) &#123;</div><div class="line">    <span class="keyword">self</span>.item = item</div><div class="line">    <span class="keyword">self</span>.edgeInset = edgeInset</div><div class="line">    collisionBehavior = <span class="type">UICollisionBehavior</span>(items: [item])</div><div class="line">    collisionBehavior.translatesReferenceBoundsIntoBoundary = <span class="literal">true</span></div><div class="line">    itemBehavior = <span class="type">UIDynamicItemBehavior</span>(items: [item])</div><div class="line">    itemBehavior.density = <span class="number">0.01</span></div><div class="line">    itemBehavior.resistance = <span class="number">20</span></div><div class="line">    itemBehavior.friction = <span class="number">0.0</span></div><div class="line">    itemBehavior.allowsRotation = <span class="literal">false</span></div><div class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>()</div><div class="line">    addChildBehavior(collisionBehavior)</div><div class="line">    addChildBehavior(itemBehavior)</div><div class="line">    <span class="keyword">for</span> fieldBehavior <span class="keyword">in</span> fieldBehaviors &#123;</div><div class="line">      fieldBehavior.addItem(item)</div><div class="line">      addChildBehavior(fieldBehavior)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>StickyEdgesBehavior 是 <code>UIDynamicBehavior</code> 的子类，在这里的作用相当于之前提到的 parentBehavior，我们在该类中设置了 <code>UIDynamicItemBehavior</code>、<code>UICollisionBehavior</code>、<code>UIDynamicItem</code> 以及两个弹簧场 <code>UIFieldBehavior.springField()</code></p>
<p>初始化的时候，我们传入了一个 item（通常是遵循 <code>UIDynamicItem</code> 协议的 View）和一个距边界尺寸（edge inset）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">updateFieldsInBounds</span><span class="params">(bounds: CGRect)</span></span> &#123;</div><div class="line"><span class="comment">//1 确保 bounds 尺寸非零，且提取了长和宽</span></div><div class="line">  <span class="keyword">guard</span> bounds != <span class="type">CGRect</span>.zero <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">  <span class="keyword">let</span> h = bounds.height</div><div class="line">  <span class="keyword">let</span> w = bounds.width</div><div class="line">  <span class="keyword">let</span> itemHeight = item.bounds.height</div><div class="line"><span class="comment">//2 更新 field 的中心位置和区域（size）</span></div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">updateRegionForField</span><span class="params">(field: UIFieldBehavior,</span></span></div><div class="line">    <span class="number">_</span> point: CGPoint) &#123;</div><div class="line">    <span class="keyword">let</span> size = <span class="type">CGSize</span>(width: w - <span class="number">2</span> * edgeInset,</div><div class="line">      height: h - <span class="number">2</span> * edgeInset - itemHeight)</div><div class="line">    field.position = point</div><div class="line">    field.region = <span class="type">UIRegion</span>(size: size)</div><div class="line">  &#125;</div><div class="line"><span class="comment">//3 找出 bounds 上半部分和下半部分的中心点</span></div><div class="line">  <span class="keyword">let</span> top = <span class="type">CGPoint</span>(x: w / <span class="number">2</span>, y: edgeInset + itemHeight / <span class="number">2</span>)</div><div class="line">  <span class="keyword">let</span> bottom = <span class="type">CGPoint</span>(x: w / <span class="number">2</span>,</div><div class="line">    y: h - edgeInset - itemHeight / <span class="number">2</span>)</div><div class="line"><span class="comment">//4 更新 fieldBehaviors 中的 UIFieldBehavior.springField()</span></div><div class="line">  updateRegionForField(fieldBehaviors[<span class="type">StickyEdge</span>.<span class="type">Top</span>.rawValue],</div><div class="line">    top)</div><div class="line">  updateRegionForField(</div><div class="line">    fieldBehaviors[<span class="type">StickyEdge</span>.<span class="type">Bottom</span>.rawValue], bottom)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面这个方法传入一个 bounds 作为参数，描述了整个弹簧场（UIFieldBehavior.springField()）的范围。在方法内部，又将 bounds 一分为二：划分了上半部分和下半部分两个弹簧场（UIFieldBehavior.springField()）</p>
<p>接下来添加一个计算属性 <code>isEnabled</code>，用来在动画过程中关闭 behavior</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> isEnabled = <span class="literal">true</span> &#123;</div><div class="line">  <span class="keyword">didSet</span> &#123;</div><div class="line">    <span class="keyword">if</span> isEnabled &#123;</div><div class="line">      <span class="keyword">for</span> fieldBehavior <span class="keyword">in</span> fieldBehaviors &#123;</div><div class="line">        fieldBehavior.addItem(item)</div><div class="line">      &#125;</div><div class="line">      collisionBehavior.addItem(item)</div><div class="line">      itemBehavior.addItem(item)</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">for</span> fieldBehavior <span class="keyword">in</span> fieldBehaviors &#123;</div><div class="line">        fieldBehavior.removeItem(item)</div><div class="line">      &#125;</div><div class="line">      collisionBehavior.removeItem(item)</div><div class="line">      itemBehavior.removeItem(item)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后为 item 增加一个线性速度</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">addLinearVelocity</span><span class="params">(velocity: CGPoint)</span></span> &#123;</div><div class="line">  itemBehavior.addLinearVelocity(velocity, forItem: item)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在 StickyEdgesBehavior 已经定义完毕，我们来使用他。具体方法：回到 FullPhotoViewController.swift，即展示大图的 VC 为 照片细节部分 tagView（黑色矩形框）添加一个手势</p>
<p>添加下面的一些属性：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">var</span> animator: <span class="type">UIDynamicAnimator</span>!</div><div class="line"><span class="keyword">var</span> stickyBehavior: <span class="type">StickyEdgesBehavior</span>!</div><div class="line"><span class="keyword">private</span> <span class="keyword">var</span> offset = <span class="type">CGPoint</span>.zero</div></pre></td></tr></table></figure>
<p>在 viewDidload() 中做些初始配置：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> gestureRecognizer = <span class="type">UIPanGestureRecognizer</span>(target: <span class="keyword">self</span>,</div><div class="line">  action: <span class="string">"pan:"</span>)</div><div class="line">tagView.addGestureRecognizer(gestureRecognizer)</div><div class="line">animator = <span class="type">UIDynamicAnimator</span>(referenceView: containerView)</div><div class="line">stickyBehavior = <span class="type">StickyEdgesBehavior</span>(item: tagView,</div><div class="line">  edgeInset: <span class="number">8</span>)</div><div class="line">animator.addBehavior(stickyBehavior)</div></pre></td></tr></table></figure>
<p>为 tagView 上面添加了一个手势，stickyBehavior 也加在了 tagView 上。接着添加 layoutSubviews 方法，当 main view 的 layout 发生改变时，sticky behavior 会自动调整 bounds（例如旋转发生时）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLayoutSubviews</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">super</span>.viewDidLayoutSubviews()</div><div class="line">  stickyBehavior.isEnabled = <span class="literal">false</span></div><div class="line">  stickyBehavior.updateFieldsInBounds(containerView.bounds)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后来实现 <code>pan:</code> 手势</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">pan</span><span class="params">(pan:UIPanGestureRecognizer)</span></span> &#123;</div><div class="line">  <span class="keyword">var</span> location = pan.locationInView(containerView)</div><div class="line">  <span class="keyword">switch</span> pan.state &#123;</div><div class="line">  <span class="keyword">case</span> .<span class="type">Began</span>:</div><div class="line">    <span class="keyword">let</span> center = tagView.center</div><div class="line">    offset.x = location.x - center.x</div><div class="line">    offset.y = location.y - center.y</div><div class="line">    stickyBehavior.isEnabled = <span class="literal">false</span></div><div class="line">  <span class="keyword">case</span> .<span class="type">Changed</span>:</div><div class="line">    <span class="keyword">let</span> referenceBounds = containerView.bounds</div><div class="line">    <span class="keyword">let</span> referenceWidth = referenceBounds.width</div><div class="line">    <span class="keyword">let</span> referenceHeight = referenceBounds.height</div><div class="line">    <span class="keyword">let</span> itemBounds = tagView.bounds</div><div class="line">    <span class="keyword">let</span> itemHalfWidth = itemBounds.width / <span class="number">2.0</span></div><div class="line">    <span class="keyword">let</span> itemHalfHeight = itemBounds.height / <span class="number">2.0</span></div><div class="line">    location.x -= offset.x</div><div class="line">    location.y -= offset.y</div><div class="line">    location.x = <span class="built_in">max</span>(itemHalfWidth, location.x)</div><div class="line">    location.x = <span class="built_in">min</span>(referenceWidth - itemHalfWidth, location.x)</div><div class="line">    location.y = <span class="built_in">max</span>(itemHalfHeight, location.y)</div><div class="line">    location.y = <span class="built_in">min</span>(referenceHeight - itemHalfHeight, location.y)</div><div class="line">    tagView.center = location</div><div class="line">  <span class="keyword">case</span> .<span class="type">Cancelled</span>, .<span class="type">Ended</span>:</div><div class="line">    <span class="keyword">let</span> velocity = pan.velocityInView(containerView)</div><div class="line">    stickyBehavior.isEnabled = <span class="literal">true</span></div><div class="line">    stickyBehavior.addLinearVelocity(velocity)</div><div class="line">  <span class="keyword">default</span>: ()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当 pan gesture 开始时，sticky behavior 将会被关掉，接着他会记录用户手势移动的偏移量 offset，在 .Changed case 中根据 offset 来实时更新 metadata view 的位置，并保证 metadata view 不会超出 container view 的范围。在手势结束或取消时，再开启 sticky behavior，此时你会发现 metadata view （tagView）会先判断在上下半场哪个半场，然后再根据上下弹簧场的各自特性（上面的向上运动，下面的向下运动）自行移动到相应位置。</p>
<p>最后在 viewDidload 里开启 debug 模式运行看一下：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">animator.setValue(<span class="literal">true</span>, forKey: <span class="string">"debugEnabled"</span>)</div></pre></td></tr></table></figure>
<h3 id="Full-photo-with-a-thud"><a href="#Full-photo-with-a-thud" class="headerlink" title="Full photo with a thud"></a>Full photo with a thud</h3><p>现在回到 collectionView 上的照片集合界面，点击其中任意一张照片，一张大图从天匀速而降，让我们来加入点自由落体和弹性效果。</p>
<p>实现起来也很简单，在 PhotosCollectionViewController.swift 中增加一个 <code>UIDynamicAnimator</code>，然后创建一些 <code>UIDynamicBehavior</code> 加进去</p>
<p>创建 <code>UIDynamicAnimator</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> animator: <span class="type">UIDynamicAnimator</span>!</div></pre></td></tr></table></figure>
<p>随后在 <code>viewDidLoad()</code> 中初始化</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">animator = <span class="type">UIDynamicAnimator</span>(referenceView: <span class="keyword">self</span>.view)</div></pre></td></tr></table></figure>
<p>创建 UIGravityBehavior、UICollisionBehavior，以及为 item 增加点物理特性（UIDynamicItemBehavior）。最后将这些 behavior 统统添加到 animator 中来</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">showFullImageView</span><span class="params">(index: Int)</span></span> &#123;</div><div class="line">  <span class="comment">//1 将 fullPhotoView 向上移出屏幕</span></div><div class="line">  fullPhotoViewController.photoPair = photoData[index]</div><div class="line">  fullPhotoView.center = <span class="type">CGPoint</span>(x: fullPhotoView.center.x,</div><div class="line">    y: fullPhotoView.frame.height / -<span class="number">2</span>)</div><div class="line">  fullPhotoView.hidden = <span class="literal">false</span></div><div class="line"></div><div class="line">  <span class="comment">//2 先清空 animator 再添加 behaviors</span></div><div class="line">  animator.removeAllBehaviors()</div><div class="line"></div><div class="line">  <span class="keyword">let</span> dynamicItemBehavior = <span class="type">UIDynamicItemBehavior</span>(items:</div><div class="line">    [fullPhotoView])</div><div class="line">  dynamicItemBehavior.elasticity = <span class="number">0.2</span></div><div class="line">  dynamicItemBehavior.density = <span class="number">400</span></div><div class="line">  animator.addBehavior(dynamicItemBehavior)</div><div class="line"></div><div class="line">  <span class="keyword">let</span> gravityBehavior = <span class="type">UIGravityBehavior</span>(items:</div><div class="line">    [fullPhotoView])</div><div class="line">  gravityBehavior.magnitude = <span class="number">5.0</span></div><div class="line">  animator.addBehavior(gravityBehavior)</div><div class="line"></div><div class="line">  <span class="keyword">let</span> collisionBehavior = <span class="type">UICollisionBehavior</span>(items:</div><div class="line">    [fullPhotoView])</div><div class="line">  <span class="keyword">let</span> <span class="keyword">left</span> = <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: fullPhotoView.frame.height + <span class="number">1.5</span>)</div><div class="line">  <span class="keyword">let</span> <span class="keyword">right</span> = <span class="type">CGPoint</span>(x: fullPhotoView.frame.width,</div><div class="line">    y: fullPhotoView.frame.height + <span class="number">1.5</span>)</div><div class="line">  collisionBehavior.addBoundaryWithIdentifier(<span class="string">"bottom"</span>,</div><div class="line">    fromPoint: <span class="keyword">left</span>, toPoint: <span class="keyword">right</span>)</div><div class="line">  animator.addBehavior(collisionBehavior)</div><div class="line"></div><div class="line">  <span class="comment">//3 执行动画，动画完成时添加 barButton（Done）</span></div><div class="line">  <span class="type">UIView</span>.animateWithDuration(<span class="number">0.5</span>, animations:</div><div class="line">      &#123; () -&gt; <span class="type">Void</span> <span class="keyword">in</span></div><div class="line">        <span class="keyword">self</span>.fullPhotoView.center = <span class="keyword">self</span>.view.center</div><div class="line">      &#125;, completion: &#123;</div><div class="line">        (completed: <span class="type">Bool</span>) -&gt; <span class="type">Void</span> <span class="keyword">in</span></div><div class="line">        <span class="keyword">let</span> doneButton = <span class="type">UIBarButtonItem</span>(barButtonSystemItem: <span class="type">UIBarButtonSystemItem</span>.<span class="type">Done</span>,</div><div class="line">          target: <span class="keyword">self</span>, action: <span class="string">"dismissFullPhoto:"</span>)</div><div class="line">        <span class="keyword">self</span>.navigationItem.rightBarButtonItem = doneButton</div><div class="line">      &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意我们在底部从 left 到 right 创建了一条线 <code>collisionBehavior.addBoundaryWithIdentifier(&quot;bottom&quot;,
      fromPoint: left, toPoint: right)</code> 这条线稍微比 view 的下边界还要偏下一点</p>
</blockquote>
<hr>
<h2 id="Chapter-12-Contacts"><a href="#Chapter-12-Contacts" class="headerlink" title="Chapter 12: Contacts"></a>Chapter 12: Contacts</h2><p>在 iOS 9 之前，开发者只能使用 C API 来访问 iOS 设备上的通讯录，随着 iOS 9 的推出，Apple 彻底废除了之前的做法，介绍了两种全新的面向对象的高级框架来管理用户通讯录（Contacts 和 ContactsUI）</p>
<p>本章将展示如何使用这两个框架：</p>
<ol>
<li>使用 ContactsUI 框架显示和选择联系人</li>
<li>添加联系人到用户的通讯录中</li>
<li>搜索用户通讯录并使用 NSPredicate 来过滤</li>
</ol>
<h3 id="Getting-started-2"><a href="#Getting-started-2" class="headerlink" title="Getting started"></a>Getting started</h3><p>本章的 Start Demo 也很简单，主界面是一个 <code>tableView</code> ，每行 cell 显示一个联系人信息，包括：联系人头像、名字、邮箱地址</p>
<p><img src="/images/ibt88.jpg" alt="ibt88"></p>
<p>App 初始化的时候会提供几个联系人的信息以供显示，下面来完成我们的第一个任务：使用 <code>ContactsUI</code> 框架来显示联系人的详细细节信息。</p>
<p>App 的主要类：</p>
<ul>
<li>FriendsViewController.swift UITableViewController 类</li>
<li>Friend.swift Model 类，代表每个联系人</li>
<li>FriendCell.swift 管理着每个 cell 的显示效果</li>
</ul>
<h3 id="Displaying-a-contact"><a href="#Displaying-a-contact" class="headerlink" title="Displaying a contact"></a>Displaying a contact</h3><p>第一步为 cell 加一个 <code>Disclosure Indicator</code>，新增的标识告诉用户可点击进入详情页面</p>
<p><img src="/images/ibt89.jpg" alt="ibt89"></p>
<p>在显示用户详细信息之前，我们需要将 Friend 实例转换成一个 CNContact</p>
<h3 id="Convert-friends-to-CNContacts"><a href="#Convert-friends-to-CNContacts" class="headerlink" title="Convert friends to CNContacts"></a>Convert friends to CNContacts</h3><p>Contacts 框架将每个联系人看做是 <code>CNContact</code> 类的一个实例，包含了很多联系人属性，如 <code>givenName</code>、<code>familyName</code>、<code>emailAddresses</code>、<code>imageData</code> 等</p>
<p>现在来做转换，在 Friend.swift 中 <code>import Contacts</code>，添加一个 <code>extension</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Friend</span> </span>&#123;</div><div class="line">  <span class="keyword">var</span> contactValue: <span class="type">CNContact</span> &#123;</div><div class="line"><span class="comment">// 1</span></div><div class="line">    <span class="keyword">let</span> contact = <span class="type">CNMutableContact</span>()</div><div class="line">    <span class="comment">// 2</span></div><div class="line">    contact.givenName = firstName</div><div class="line">    contact.familyName = lastName</div><div class="line">    <span class="comment">// 3</span></div><div class="line">    contact.emailAddresses = [</div><div class="line">      <span class="type">CNLabeledValue</span>(label: <span class="type">CNLabelWork</span>, value: workEmail)</div><div class="line">    ]</div><div class="line"><span class="comment">// 4</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> profilePicture = profilePicture &#123;</div><div class="line">      <span class="keyword">let</span> imageData =</div><div class="line">        <span class="type">UIImageJPEGRepresentation</span>(profilePicture, <span class="number">1</span>)</div><div class="line">      contact.imageData = imageData</div><div class="line">&#125;</div><div class="line"><span class="comment">// 5</span></div><div class="line">    <span class="keyword">return</span> contact.copy() <span class="keyword">as</span>! <span class="type">CNContact</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先创建了一个 CNMutableContact 实例（CNContact 的可变子类），接着更新了相关属性（从 Friend 结构体之前定义的常量中获取相关属性）。emailAddresses 是一个 <code>CNLabeledValue</code> 对象的数组，意味着每个 email 都对应着一个标签 label，有许多这样的标记，暂且这里设定为 <code>CNLabelWork</code>。最后我们返回一个不可变的拷贝对象（<code>CNContact</code>）</p>
<blockquote>
<p><code>CNContact</code> 是线程安全的，而 <code>CNMutableContact</code> 不是</p>
</blockquote>
<h3 id="Showing-the-contact’s-information"><a href="#Showing-the-contact’s-information" class="headerlink" title="Showing the contact’s information"></a>Showing the contact’s information</h3><p>接着实现点击联系人列表进入详情页面，在 FriendsViewController.swift 中导入</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">import</span> Contacts</div><div class="line"><span class="keyword">import</span> ContactsUI</div></pre></td></tr></table></figure>
<p>添加 <code>UITableViewDelegate</code> 方法：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">//MARK: UITableViewDelegate</span></div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FriendsViewController</span> </span>&#123;</div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView,</span></span></div><div class="line">    didSelectRowAtIndexPath indexPath: NSIndexPath) &#123;</div><div class="line">      tableView.deselectRowAtIndexPath(indexPath,</div><div class="line">        animated: <span class="literal">true</span>)</div><div class="line">      <span class="comment">// 1</span></div><div class="line">      <span class="keyword">let</span> friend = friendsList[indexPath.row]</div><div class="line">      <span class="keyword">let</span> contact = friend.contactValue</div><div class="line">      <span class="comment">// 2</span></div><div class="line">      <span class="keyword">let</span> contactViewController =</div><div class="line">        <span class="type">CNContactViewController</span>(forUnknownContact: contact)</div><div class="line">      contactViewController.navigationItem.title = <span class="string">"Profile"</span></div><div class="line">      contactViewController.hidesBottomBarWhenPushed = <span class="literal">true</span></div><div class="line">      <span class="comment">// 3</span></div><div class="line">      contactViewController.allowsEditing = <span class="literal">false</span></div><div class="line">      contactViewController.allowsActions = <span class="literal">false</span></div><div class="line">      <span class="comment">// 4</span></div><div class="line">      navigationController?.pushViewController</div><div class="line">        (contactViewController, animated: <span class="literal">true</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>观察注释 2 ，实例化了一个 <code>CNContactViewController</code>，这是 ContactsUI 框架用来展示联系人信息用的。这里用到了 <code>forUnknownContact</code> 来初始化是因为该联系人并不存在于 iOS 的通讯录中，随后通过 <code>contactViewController</code> 的相关属性对 navigation bar 和 tab bar 做了些配置</p>
<p>运行，选中某个 cell，<code>ContactsUI</code> 框架会展示选中联系人的信息：</p>
<p><img src="/images/ibt90.jpg" alt="ibt90"></p>
<p>如果我们要添加更多的好友，可以使用 <code>ContactsUI</code> 类中的 <code>CNContactPickerViewController</code> 来让用户从联系人中选择添加到 App</p>
<h3 id="Picking-your-friends"><a href="#Picking-your-friends" class="headerlink" title="Picking your friends"></a>Picking your friends</h3><p>我们在 SB 中给 <code>FriendsViewController</code> 加一个 AddButton（<code>UIBarButtonItem</code>）</p>
<p><img src="/images/ibt91.jpg" alt="ibt91"></p>
<p>为这个 AddButton 创建一个关联（target-action）的方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">addFriends</span><span class="params">(sender: UIBarButtonItem)</span></span> &#123;</div><div class="line">  <span class="keyword">let</span> contactPicker = <span class="type">CNContactPickerViewController</span>()</div><div class="line">  presentViewController(contactPicker, animated: <span class="literal">true</span>, completion: <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在点击 AddButton 会展示一个 <code>CNContactPickerViewController</code>，此时如果你选中任意一个联系人，只会将你带到详情页面，并不能将选中的联系人添加回主页面列表</p>
<p><img src="/images/ibt92.jpg" alt="ibt92"></p>
<p>要解决这个问题，需要利用到 <code>CNContactPickerDelegate</code></p>
<h3 id="Conforming-to-CNContactPickerDelegate"><a href="#Conforming-to-CNContactPickerDelegate" class="headerlink" title="Conforming to CNContactPickerDelegate"></a>Conforming to CNContactPickerDelegate</h3><p><code>CNContactPickerDelegate</code> 有五个可选方法，目前我们只对 <code>contactPicker(_:didSelectContacts:)</code> 感兴趣，当你实现了该方法，<code>CNContactPickerViewController</code> 就会知道你想要支持多选中，下面让我们来实现下</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FriendsViewController</span>: <span class="title">CNContactPickerDelegate</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">contactPicker</span><span class="params">(picker: CNContactPickerViewController,</span></span></div><div class="line">    didSelectContacts contacts: [CNContact]) &#123;</div><div class="line">    <span class="comment">// TODO</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后一个参数 <code>contacts</code>，存储着选中的多个联系人信息（<code>CNContact</code> 数组）。回顾一下， 在 <code>FriendsViewController</code> 中我们使用的数据源是数组：<code>friendsList</code>（<code>[Friend]</code>）。所以这里转换一下，将 [CNContact] -&gt; [Friend]，我们将这种转换放到 model 中来实现</p>
<p>为 <code>Friend</code> 再添加一个初始方法，可通过传入一个 <code>CNContact</code> 来初始化一个 <code>Friend</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">init</span>(contact: <span class="type">CNContact</span>)&#123;</div><div class="line">  firstName = contact.givenName</div><div class="line">  lastName = contact.familyName</div><div class="line">  workEmail = contact.emailAddresses.first!.value <span class="keyword">as</span>! <span class="type">String</span></div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> imageData = contact.imageData&#123;</div><div class="line">    profilePicture = <span class="type">UIImage</span>(data: imageData)</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    profilePicture = <span class="literal">nil</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>contact.emailAddresses.first!</code> 代表一个 <code>CNLabeledValue</code>对象，所以通过 <code>.value</code> 来提取具体的值。</p>
<p>有了 [CNContact] -&gt; [Friend] 转换方法，我们来实现这个代理方法：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">FriendsViewController</span>: <span class="title">CNContactPickerDelegate</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">func</span> <span class="title">contactPicker</span><span class="params">(picker: CNContactPickerViewController,</span></span></div><div class="line">    didSelectContacts contacts: [CNContact]) &#123;</div><div class="line">    <span class="keyword">let</span> newFriends = contacts.<span class="built_in">map</span> &#123; <span class="type">Friend</span>(contact: $<span class="number">0</span>) &#125;</div><div class="line">    <span class="keyword">for</span> friend <span class="keyword">in</span> newFriends &#123;</div><div class="line">       <span class="keyword">if</span> !friendsList.<span class="built_in">contains</span>(friend)&#123;</div><div class="line">         friendsList.append(friend)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    tableView.reloadData()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将选中的 <code>[CNContact]</code> 转化成 <code>[Friend]</code>，再填加到数据源数组 <code>friendsList</code> 中</p>
<p>最后别忘了在 addFriends 方法中设置 delegate</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">contactPicker.delegate = <span class="keyword">self</span></div></pre></td></tr></table></figure>
<p>运行，现在可以选中多个联系人了</p>
<p><img src="/images/ibt93.jpg" alt="ibt93"></p>
<p>选择完毕后按 Done，添加了几个朋友回到了主界面</p>
<p><img src="/images/ibt94.jpg" alt="ibt94"></p>
<p>注意这里有个问题！如果你选中的联系人没有 email，那么 App 会崩溃掉，这是因为之前我们在 Friend 的初始化方法 <code>init(contact:)</code> 中对 email 地址使用了强制解包，没有 email 的 contact 就会崩溃。</p>
<p>有没有办法只允许用户选择存在 email 的联系人呢？当然可以，在 <code>presentViewController(_:animated:completion:):</code> 之前先筛选一下子呗：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">contactPicker.predicateForEnablingContact = <span class="type">NSPredicate</span>(format: <span class="string">"emailAddresses.@count &gt; 0"</span>)</div></pre></td></tr></table></figure>
<p>属性 <code>predicateForEnablingContact</code> 让你决定筛选哪些联系人可以被选定，这里我们限定了 email 不为空</p>
<p>现在运行，单击添加按钮，你会看到 email 不存在的联系人都变灰色了（不可选中状态）</p>
<p><img src="/images/ibt95.jpg" alt="ibt95"></p>
<p>现在你可以很自然地从通讯录中创建好友了</p>
<h3 id="Saving-friends-to-the-user’s-contacts"><a href="#Saving-friends-to-the-user’s-contacts" class="headerlink" title="Saving friends to the user’s contacts"></a>Saving friends to the user’s contacts</h3><p>接下来我们实现：当用户在 table view cell 上向左滑动，会显示一个 Create Contact 操作按钮来将当前对应的联系人添加到系统通讯录中</p>
<p>先来实现 UI 层面上效果，在 FriendsViewController.swift 的 delegate 中添加：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView,</span></span></div><div class="line">  editActionsForRowAtIndexPath indexPath: NSIndexPath)</div><div class="line">  -&gt; [<span class="type">UITableViewRowAction</span>]? &#123;</div><div class="line">  <span class="keyword">let</span> createContact = <span class="type">UITableViewRowAction</span>(style: .<span class="type">Normal</span>,</div><div class="line">    title: <span class="string">"Create Contact"</span>) &#123; rowAction, indexPath <span class="keyword">in</span></div><div class="line">    tableView.setEditing(<span class="literal">false</span>, animated: <span class="literal">true</span>)</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> Add the contact</span></div><div class="line">  &#125;</div><div class="line">  createContact.backgroundColor = <span class="type">BlueColor</span></div><div class="line">  <span class="keyword">return</span> [createContact]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码创建了一个名称为 Create Contact 的 row action，背景是蓝色的</p>
<p><img src="/images/ibt96.jpg" alt="ibt96"></p>
<p>在你访问或修改用户通讯录之前，最重要的事情是记得先向用户申请权限，Contacts 框架里已经内建了权限功能，你不能在没有授权的情况下访问或修改通讯录</p>
<blockquote>
<p>之前我们使用 CNContactPickerViewController 时并没有向用户鉴权，是因为使用 CNContactPickerViewController 的时候，你的 App 并不直接参与访问或修改通讯录。</p>
</blockquote>
<h3 id="Asking-for-permission"><a href="#Asking-for-permission" class="headerlink" title="Asking for permission"></a>Asking for permission</h3><p>我们来完善上面的代码，在 TODO 的地方申请通讯录权限：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(tableView: UITableView,</span></span></div><div class="line">  editActionsForRowAtIndexPath indexPath: NSIndexPath)</div><div class="line">  -&gt; [<span class="type">UITableViewRowAction</span>]? &#123;</div><div class="line">  <span class="keyword">let</span> createContact = <span class="type">UITableViewRowAction</span>(style: .<span class="type">Normal</span>,</div><div class="line">    title: <span class="string">"Create Contact"</span>) &#123; rowAction, indexPath <span class="keyword">in</span></div><div class="line">    <span class="comment">// 将系统默认的左滑删除关掉了</span></div><div class="line">    tableView.setEditing(<span class="literal">false</span>, animated: <span class="literal">true</span>)</div><div class="line">    <span class="comment">// 申请通讯录权限</span></div><div class="line">    <span class="keyword">let</span> contactStore = <span class="type">CNContactStore</span>()</div><div class="line">    contactStore.requestAccessForEntityType(<span class="type">CNEntityType</span>.<span class="type">Contacts</span>) &#123;</div><div class="line">      userGrantedAccess, <span class="number">_</span> <span class="keyword">in</span></div><div class="line">      <span class="keyword">guard</span> userGrantedAccess <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">self</span>.presentPermissionErrorAlert()</div><div class="line">        <span class="keyword">return</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  createContact.backgroundColor = <span class="type">BlueColor</span></div><div class="line">  <span class="keyword">return</span> [createContact]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在上面的代码中，我们首先创建了 <code>CNContactStore</code> 的实例，表示用户的通讯录，接着通过 <code>requestAccessForEntityType(:completion:)</code> 来向用户申请权限，而用户最终的反馈结果将以 completion handler 闭包的形式通过一个 Bool 参数 <code>userGrantedAccess</code> 传回来。最后为了更好的用户体验，当 <code>userGrantedAccess</code> 为 NO 的时候，我们会弹一个 Alert 说明理由，并引导用户去 Setting 里重新分配权限。</p>
<p>关于 <code>presentPermissionErrorAlert</code> ：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">presentPermissionErrorAlert</span><span class="params">()</span></span> &#123;</div><div class="line">  dispatch_async(dispatch_get_main_queue()) &#123;</div><div class="line">    <span class="keyword">let</span> alert =</div><div class="line">      <span class="type">UIAlertController</span>(title: <span class="string">"Could Not Save Contact"</span>,</div><div class="line">        message: <span class="string">"How am I supposed to add the contact if "</span> +</div><div class="line">        <span class="string">"you didn't give me permission?"</span>,</div><div class="line">        preferredStyle: .<span class="type">Alert</span>)</div><div class="line"></div><div class="line">    <span class="keyword">let</span> openSettingsAction = <span class="type">UIAlertAction</span>(title: <span class="string">"Settings"</span>,</div><div class="line">      style: .<span class="type">Default</span>, handler: &#123; alert <span class="keyword">in</span></div><div class="line">        <span class="type">UIApplication</span>.sharedApplication()</div><div class="line">          .openURL(</div><div class="line">            <span class="type">NSURL</span>(string: <span class="type">UIApplicationOpenSettingsURLString</span>)!)</div><div class="line">    &#125;)</div><div class="line"></div><div class="line">    <span class="keyword">let</span> dismissAction = <span class="type">UIAlertAction</span>(title: <span class="string">"OK"</span>,</div><div class="line">      style: .<span class="type">Cancel</span>, handler: <span class="literal">nil</span>)</div><div class="line"></div><div class="line">    alert.addAction(openSettingsAction)</div><div class="line">    alert.addAction(dismissAction)</div><div class="line">    <span class="keyword">self</span>.presentViewController(alert, animated: <span class="literal">true</span>,</div><div class="line">      completion: <span class="literal">nil</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我们使用了 <code>dispatch_async(dispatch_get_main_queue())</code> 是因为 <code>requestAccessForEntityType(:completion:)</code> 的 completion handler 会在后台线程中执行，因此弹窗这种 UI 操作还是要回主线程</p>
<p>弹窗的第一个 UIAlertAction 使用 <code>UIApplicationOpenSettingsURLString</code> key 来打开 Settings</p>
<p>运行一下，左滑 cell 选择 Create Contact 创建联系人，弹出</p>
<p><img src="/images/ibt97.jpg" alt="ibt97"></p>
<p>选择 Don’t Allow，guard 判断并执行一个弹窗操作，引导用户去 Setting 里授权</p>
<p><img src="/images/ibt98.jpg" alt="ibt98"></p>
<p>按下 Setting，弹窗将会把你呆到 Settings 界面</p>
<p><img src="/images/ibt99.jpg" alt="ibt99"></p>
<h3 id="Saving-friends-to-contacts"><a href="#Saving-friends-to-contacts" class="headerlink" title="Saving friends to contacts"></a>Saving friends to contacts</h3><p>下面处理授权通过的情况下如何将好友保存到通讯录</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveFriendToContacts</span><span class="params">(friend: Friend)</span></span> &#123;</div><div class="line">  <span class="comment">// 1</span></div><div class="line">  <span class="keyword">let</span> contact = friend.contactValue.mutableCopy()</div><div class="line">    <span class="keyword">as</span>! <span class="type">CNMutableContact</span></div><div class="line">  <span class="comment">// 2</span></div><div class="line">  <span class="keyword">let</span> saveRequest = <span class="type">CNSaveRequest</span>()</div><div class="line">  <span class="comment">// 3</span></div><div class="line">  saveRequest.addContact(contact,</div><div class="line">    toContainerWithIdentifier: <span class="literal">nil</span>)</div><div class="line">  <span class="keyword">do</span> &#123;</div><div class="line">    <span class="comment">// 4</span></div><div class="line">    <span class="keyword">let</span> contactStore = <span class="type">CNContactStore</span>()</div><div class="line">    <span class="keyword">try</span> contactStore.executeSaveRequest(saveRequest)</div><div class="line">    <span class="comment">// Show Success Alert</span></div><div class="line">    dispatch_async(dispatch_get_main_queue()) &#123;</div><div class="line">      <span class="keyword">let</span> successAlert = <span class="type">UIAlertController</span>(title: <span class="string">"Contacts Saved"</span>,</div><div class="line">        message: <span class="literal">nil</span>, preferredStyle: .<span class="type">Alert</span>)</div><div class="line">      successAlert.addAction(<span class="type">UIAlertAction</span>(title: <span class="string">"OK"</span>,</div><div class="line">        style: .<span class="type">Cancel</span>, handler: <span class="literal">nil</span>))</div><div class="line">      <span class="keyword">self</span>.presentViewController(successAlert, animated: <span class="literal">true</span>,</div><div class="line">        completion: <span class="literal">nil</span>)</div><div class="line">      &#125;</div><div class="line">  &#125; <span class="keyword">catch</span> &#123;</div><div class="line">    <span class="comment">// Show Failure Alert</span></div><div class="line">    dispatch_async(dispatch_get_main_queue()) &#123;</div><div class="line">      <span class="keyword">let</span> failureAlert = <span class="type">UIAlertController</span>(</div><div class="line">        title: <span class="string">"Could Not Save Contact"</span>,</div><div class="line">        message: <span class="string">"An unknown error occurred."</span>,</div><div class="line">        preferredStyle: .<span class="type">Alert</span>)</div><div class="line">      failureAlert.addAction(<span class="type">UIAlertAction</span>(title: <span class="string">"OK"</span>,</div><div class="line">        style: .<span class="type">Cancel</span>, handler: <span class="literal">nil</span>))</div><div class="line">      <span class="keyword">self</span>.presentViewController(failureAlert, animated: <span class="literal">true</span>,</div><div class="line">        completion: <span class="literal">nil</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>因为 <code>addContact:toContainerWithIdentifier:</code> 需要一个 <code>CNMutableContact</code> 作为参数，所以第一步先做个转换；第二步创建了 <code>CNSaveRequest</code> 对象，我们利用该对象来传递增加、更新或删除联系人等操作信息给通讯录（<code>CNContactStore</code>）；第三步告诉 <code>CNSaveRequest</code> 你想要增加一个联系人到通讯录中；最后执行保存操作</p>
<blockquote>
<p>无论 <code>contactStore.executeSaveRequest(saveRequest)</code> 成功还是失败，都会弹窗提醒用户</p>
</blockquote>
<p>回到 <code>tableView(_:editActionsForRowAtIndexPath:)</code> 在 guard block 后保存当前索引对应的 friend</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> friend = <span class="keyword">self</span>.friendsList[indexPath.row]</div><div class="line"><span class="keyword">self</span>.saveFriendToContacts(friend)</div></pre></td></tr></table></figure>
<p>重置模拟器运行，现在你可以左划 cell 将当前联系人添加到系统通讯录中了</p>
<p><img src="/images/ibt100.jpg" alt="ibt100"></p>
<p>细心的童鞋或许已经发现：可以重复添加联系人到通讯录中，下面来修正：</p>
<h3 id="Checking-for-existing-contacts"><a href="#Checking-for-existing-contacts" class="headerlink" title="Checking for existing contacts"></a>Checking for existing contacts</h3><p>为了去重，我们在保存联系人之前先判断一下，在 <code>saveFriendToContacts(_:):</code> 一开始添加</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">//1</span></div><div class="line"><span class="keyword">let</span> contactFormatter = <span class="type">CNContactFormatter</span>()</div><div class="line"><span class="comment">//2</span></div><div class="line"><span class="keyword">let</span> contactName = contactFormatter</div><div class="line">  .stringFromContact(friend.contactValue)!</div><div class="line"><span class="comment">//3</span></div><div class="line"><span class="keyword">let</span> predicateForMatchingName = <span class="type">CNContact</span></div><div class="line">  .predicateForContactsMatchingName(contactName)</div><div class="line"><span class="comment">//4</span></div><div class="line"><span class="keyword">let</span> matchingContacts = <span class="keyword">try</span>! <span class="type">CNContactStore</span>()</div><div class="line">  .unifiedContactsMatchingPredicate(predicateForMatchingName,</div><div class="line">    keysToFetch: [])</div><div class="line"><span class="comment">//4</span></div><div class="line"><span class="keyword">guard</span> matchingContacts.isEmpty <span class="keyword">else</span> &#123;</div><div class="line">  dispatch_async(dispatch_get_main_queue()) &#123;</div><div class="line">    <span class="keyword">let</span> alert = <span class="type">UIAlertController</span>(</div><div class="line">      title: <span class="string">"Contact Already Exists"</span>, message: <span class="literal">nil</span>,</div><div class="line">      preferredStyle: .<span class="type">Alert</span>)</div><div class="line">    alert.addAction(<span class="type">UIAlertAction</span>(title: <span class="string">"OK"</span>, style: .<span class="type">Cancel</span>,</div><div class="line">      handler: <span class="literal">nil</span>))</div><div class="line">    <span class="keyword">self</span>.presentViewController(alert, animated: <span class="literal">true</span>,</div><div class="line">      completion: <span class="literal">nil</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li><code>CNContactFormatter</code> 根据本机环境（通讯录）来定义联系人的样式，有点类似于 <code>NSDateFormatter</code> 做的事情</li>
<li>使用这种 formatter 来得到一个联系人的姓名</li>
<li>用上面获得的联系人姓名创建一个谓词</li>
<li>利用这个谓词来获取所有匹配姓名的联系人，注意这一步返回的是一个 <code>[CNContact]</code> 数组</li>
<li>判断一下，如果有重复的联系人就给用户弹个警告窗，直接返回了</li>
</ol>
<blockquote>
<p>在 <code>unifiedContactsMatchingPredicate(_:keysToFetch:)</code> 方法中，我们为参数 keysToFetch 传入了一个空数组，因为当时我们并不需要访问或修改获取到的联系人。但是假如要访问获取到的联系人 first name，你就要添加 <code>CNContactGivenNameKey</code> 到 <code>keysToFetch</code> 数组中去。</p>
</blockquote>
<hr>
<h2 id="Chapter-13-Testing"><a href="#Chapter-13-Testing" class="headerlink" title="Chapter 13: Testing"></a>Chapter 13: Testing</h2><p>这几年 Apple 在 iOS 测试上改进不少，越来越简单快捷了：</p>
<ul>
<li>Xcode 5 苹果推出了 XCTest 框架的第一个版本，相较上一版 SenTestingKit 增加了很多现代化的实现</li>
<li>Xcode 6 增加了异步 asynchronous 和性能 performance 测试</li>
<li>今年随着 Xcode 7 面世 Apple 又推出了 code coverage reports（测试覆盖率报告）和 UI testing</li>
</ul>
<p>关于测试我之前专门写过两篇文章详述，具体可以看这里： <a href="http://chengway.in/unit-testing-for-ios-part-i/" target="_blank" rel="external">Unit Testing for iOS Part Ⅰ</a>，<a href="http://chengway.in/unit-testing-for-ios-part-ii/" target="_blank" rel="external">Unit Testing for iOS Part Ⅱ</a></p>
<p>本章就挑摘要记录下，不做具体的深入了</p>
<h3 id="Code-coverage"><a href="#Code-coverage" class="headerlink" title="Code coverage"></a>Code coverage</h3><p>开启代码覆盖率可以让你知道整个工程当前的测试情况，开启很简单：在 Product\Scheme\Edit Scheme… 下选择 Test，勾选 Code Coverage — Gather coverage data 就 OK 了</p>
<p><img src="/images/ibt101.jpg" alt="ibt101"></p>
<p>运行测试，在 Xcode 左侧导航栏切换到 report navigator，点击 test action</p>
<p><img src="/images/ibt102.jpg" alt="ibt102"></p>
<p>切换到 Coverage tab，你就能看到测试覆盖率报告了</p>
<p><img src="/images/ibt103.jpg" alt="ibt103"></p>
<p>这个报告展示了基于当前文件的方法测试覆盖情况，你甚至可以进入单独的类中去查看单个方法被测试的次数</p>
<p><img src="/images/ibt104.jpg" alt="ibt104"></p>
<h3 id="testable-imports-and-access-control"><a href="#testable-imports-and-access-control" class="headerlink" title="@testable imports and access control"></a>@testable imports and access control</h3><p>通常我们在 test target 中要测试 model 的时候，都要先导入相应的 module，这是因为你的 app 和 test bundle 一般是分离的，但仅仅这样做还不够。</p>
<p>这涉及到了访问控制的概念，通常很多语言都会对从一个代码区块访问另一个代码区块做出限制， Swift 也不例外，在 Swift 中这种访问控制模式基于 modules 和 source files 的概念。</p>
<p>一个 module 是一个独立的代码分发单元，这可以是一个应用或一个框架，在本例子中，所有在 Workouts app 里的源代码是一个 module，而所有在 testing bundle 中代码是另外一个独立的 module；而一个 source file 是 module 中的一个 Swift 源代码文件，比如 Workout.swift</p>
<p>Swift 提供了三种等级的访问控制：</p>
<ol>
<li>Public access 本权限下的实例允许任意 module 的代码访问</li>
<li>Internal access 本权限的实例仅允许同一 module 的代码访问</li>
<li>Private access 本权限的实例仅允许在当前 source file 中使用</li>
</ol>
<p>默认的是 internal，所以想要从 test bundle 访问 app 中的实例是不可能的（因为跨了 module），全部设为 Public 又不现实，苹果审时度势在 Swift 2.0 推出了 @testable，可以让 internal 在 test bundle 中访问到</p>
<p>现在你只需要在 DataModelTests.swift 中将</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">import Workouts</div><div class="line"></div><div class="line">替换为：</div><div class="line"></div><div class="line">@testable import Workouts</div></pre></td></tr></table></figure>
<blockquote>
<p>@testable 对 Private access 不起作用</p>
</blockquote>
<h3 id="UI-testing"><a href="#UI-testing" class="headerlink" title="UI testing"></a>UI testing</h3><p>如果你的工程是用 Xcode 7 之前版本创建的，那么在写 UI test 之前先要添加 <code>UI testing target</code></p>
<h3 id="Run-your-first-UI-test"><a href="#Run-your-first-UI-test" class="headerlink" title="Run your first UI test"></a>Run your first UI test</h3><p>第一步将我们要测试的 View 先标记出来</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">super</span>.viewDidLoad()</div><div class="line">  tableView.accessibilityIdentifier = <span class="string">"Workouts Table"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后来写我们的 UI 测试方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">testRaysFullBodyWorkout</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">let</span> app = <span class="type">XCUIApplication</span>()</div><div class="line">  <span class="comment">// 1 得到所有的 table</span></div><div class="line">  <span class="keyword">let</span> tableQuery = app.descendantsMatchingType(.<span class="type">Table</span>)</div><div class="line">  <span class="comment">// 2 找出之前标记为 "WorkoutsTable" 的 table</span></div><div class="line">  <span class="keyword">let</span> workoutTable = tableQuery[<span class="string">"Workouts Table"</span>]</div><div class="line">  <span class="keyword">let</span> cellQuery = workoutTable.childrenMatchingType(.<span class="type">Cell</span>)</div><div class="line">  <span class="keyword">let</span> identifier = <span class="string">"Ray's Full Body Workout"</span></div><div class="line">  <span class="keyword">let</span> workoutQuery = cellQuery</div><div class="line">    .containingType(.<span class="type">StaticText</span>, identifier: identifier)</div><div class="line">  <span class="keyword">let</span> workoutCell = workoutQuery.element</div><div class="line">  workoutCell.tap()</div><div class="line">  <span class="comment">// 3 模拟一些点按操作</span></div><div class="line">  <span class="keyword">let</span> navBarQuery = app.descendantsMatchingType(.<span class="type">NavigationBar</span>)</div><div class="line">  <span class="keyword">let</span> navBar = navBarQuery[identifier]</div><div class="line">  <span class="keyword">let</span> buttonQuery = navBar.descendantsMatchingType(.<span class="type">Button</span>)</div><div class="line">  <span class="keyword">let</span> backButton = buttonQuery[<span class="string">"Workouts"</span>]</div><div class="line">  backButton.tap()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当运行测试的时候，你会发现模拟器会自动启动并模拟整个操作过程。你也许又会问为什么没有 <code>assertions</code>，因为如果界面上某个 UI 元素不存在，测试就会失败。所以执行 UI test 其实暗含了 <code>asserts</code></p>
<h4 id="UI-test-classes"><a href="#UI-test-classes" class="headerlink" title="UI test classes"></a>UI test classes</h4><p>在 UI testing 中主要有这三种独立的类</p>
<ul>
<li>XCUIApplication 表示代理当前 App</li>
<li>XCUIElement 表示代理当前 UI 元素</li>
<li>XCUIElementQuery 用做查询<ul>
<li><code>descendantsMatchingType(_:)</code></li>
<li><code>childrenMatchingType(:_)</code></li>
<li><code>containingType(_:)</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>记住 <code>XCUIApplication</code> 和 <code>XCUIElement</code> 都仅仅是 proxies（代理人），并不是真正的 UI 对象</p>
</blockquote>
<h4 id="UI-testing-convenience-methods"><a href="#UI-testing-convenience-methods" class="headerlink" title="UI testing convenience methods"></a>UI testing convenience methods</h4><p>现在添加另一个测试，在具体某一项 Workout 详情页面，滚动到底部，点击 Select &amp; Workout 按钮，此时会弹一个警告框，我们点 OK 来 dismiss 掉，最后返回到之前的 list 界面 同样是在 <code>viewDidLoad()</code> 中先标记 detail 页面的 table</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">tableView.accessibilityIdentifier = <span class="string">"Workout Detail Table"</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">testRaysFullBodyWorkout</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">let</span> app = <span class="type">XCUIApplication</span>()</div><div class="line">  <span class="comment">//1</span></div><div class="line">  <span class="keyword">let</span> identifier = <span class="string">"Ray's Full Body Workout"</span></div><div class="line">  <span class="keyword">let</span> workoutQuery = app.tables.cells</div><div class="line">    .containingType(.<span class="type">StaticText</span>, identifier: identifier)</div><div class="line">  workoutQuery.element.tap()</div><div class="line">  <span class="comment">//2</span></div><div class="line">  app.tables[<span class="string">"Workout Detail Table"</span>].swipeUp()</div><div class="line">  app.tables.buttons[<span class="string">"Select &amp; Workout"</span>].tap()</div><div class="line">  app.alerts.buttons[<span class="string">"OK"</span>].tap()</div><div class="line">  <span class="comment">//3</span></div><div class="line">  app.buttons[<span class="string">"Workouts"</span>].tap()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>获取到所有 cells，然后根据 identifier 筛选出来对应的 cell，点击进入详情页面</li>
<li>向上滚动 table，找到 Select &amp; Workout 按钮点击，弹出的对话框点 OK</li>
<li>最后点击 navigation bar 上的 Workouts 按钮返回到 list 主页面</li>
</ol>
<p>运行测试，失败了…</p>
<p><img src="/images/ibt105.jpg" alt="ibt105"></p>
<p>一般有三种方式向下查找到需要的 UI 元素</p>
<ol>
<li>如果你有一个唯一的标识可以使用下标，<code>buttonsQuery[&quot;OK&quot;]</code></li>
<li>使用索引 <code>tables.cells.elementAtIndex(0)</code></li>
<li>如果能确保查询到只有一个元素，可以使用 XCUIElementQuery 的 element 属性</li>
</ol>
<p>如果使用以上三种方法最后找到多个 <code>XCUIElement</code>，那么测试就会失败，这是因为 UI testing framework 不知道你到底想要与哪个 UI 元素进行交互。</p>
<p>而上面的测试失败是因为下面这行找到了两个以 Workouts 命名的按钮</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">app.buttons[<span class="string">"Workouts"</span>]</div></pre></td></tr></table></figure>
<p><img src="/images/ibt106.jpg" alt="ibt106"></p>
<p>注意黄圈圈出来的 Button，修正也很简单，指明我们要点击的按钮是导航栏上的 Workouts 就好</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">app.navigationBars.buttons[<span class="string">"Workouts"</span>].tap()</div></pre></td></tr></table></figure>
<h3 id="UI-recording"><a href="#UI-recording" class="headerlink" title="UI recording"></a>UI recording</h3><p>这个比较简单，新建一个空白的测试方法，光标移到方法内部起始位置，点击红色的 Record UI Test 小圆点会启动模拟器，此时你在模拟器上的操作会被 Xcode 记录下来转换成操作代码，也就是上一步写过的那些代码。</p>
<p><img src="/images/ibt107.jpg" alt="ibt107"></p>
<hr>
<h2 id="Chapter-14-Location-and-Mapping"><a href="#Chapter-14-Location-and-Mapping" class="headerlink" title="Chapter 14 Location and Mapping"></a>Chapter 14 Location and Mapping</h2><p>尽管 iOS 的地图服务被大家广为诟病，但 Apple 每年都会持续改进，iOS 9 也不例外，MapKit 和 Core Location 迎来一大波更新。</p>
<p>其中最有用的一个改进就是在地图上增加了行程导航，本章将学习这些新特性：</p>
<ul>
<li>自定义地图外观的新方法</li>
<li>行程导航</li>
<li>估计行程的时间</li>
<li>使用 Core Location 进行单个位置更新</li>
</ul>
<p>这一章，Café Transit 的示例应用程序是为所有的咖啡爱好者开发的。它可以帮助你寻找那些称赞的咖啡。目前，它只显示附近的的一小撮咖啡馆。而当你完成了这一章，App 会显示大量的有用的信息，包括每个咖啡店，评级，定价信息和开放时间。还会提供到指定咖啡店的行程导航信息，以及告诉你什么时候出发和什么时候到达。</p>
<h3 id="Getting-started-3"><a href="#Getting-started-3" class="headerlink" title="Getting started"></a>Getting started</h3><p>熟悉下 Demo 程序</p>
<p><img src="/images/ibt108.jpg" alt="ibt108"></p>
<ul>
<li>ViewController.swift<ul>
<li>setupMap() 设置地图并限定显示区域</li>
<li>addMapData() 从 model 中载入地图注释信息</li>
</ul>
</li>
<li>CoffeeShop.swift 咖啡馆的 model 信息，并负责从 plist 载入信息</li>
<li>CoffeeShopPinDetailView.swift 和 CoffeeShopPinDetailView.xib 负责表示自定义的注释，该注释将会显示评分、价格信息和营业时间</li>
</ul>
<h3 id="Customizing-maps"><a href="#Customizing-maps" class="headerlink" title="Customizing maps"></a>Customizing maps</h3><p>iOS 9 之前你只能通过编程的方式开启/关闭地图上的特定建筑物。iOS 9 介绍了三个新的 Boolen 属性，让你开启/关闭地图上的 compass-罗盘, scale bar-比例尺，traffic-交通流量</p>
<p><img src="/images/ibt109.jpg" alt="ibt109"></p>
<p>我们可以为 Café Transit 开启比例尺，在 setupMap() 里开启</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">mapView.showsScale = <span class="literal">true</span></div></pre></td></tr></table></figure>
<p><img src="/images/ibt110.jpg" alt="ibt110"></p>
<p>随着对地图的缩放，比例尺也会跟着变化</p>
<h3 id="Customizing-map-pins"><a href="#Customizing-map-pins" class="headerlink" title="Customizing map pins"></a>Customizing map pins</h3><p>在 iOS 9 中，苹果用 pinTintColor 替代了 pincolor，新的属性允许你将标记大头针设置成自己喜欢的颜色了（原属性只能设红、绿、紫三种颜色）</p>
<p>我们来将五星评价的餐厅在地图上设为黄色，其余的设为棕色</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">if</span> annotation.coffeeshop.rating.value == <span class="number">5</span> &#123;</div><div class="line">  annotationView!.pinTintColor =</div><div class="line">    <span class="type">UIColor</span>(red:<span class="number">1</span>, green:<span class="number">0.79</span>, blue:<span class="number">0</span>, alpha:<span class="number">1</span>)</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  annotationView!.pinTintColor =</div><div class="line">    <span class="type">UIColor</span>(red:<span class="number">0.419</span>, green:<span class="number">0.266</span>, blue:<span class="number">0.215</span>, alpha:<span class="number">1</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Customizing-annotation-callouts"><a href="#Customizing-annotation-callouts" class="headerlink" title="Customizing annotation callouts"></a>Customizing annotation callouts</h3><p>咖啡馆在地图上以大头针形式标注，且当你点击大头针 <code>annotation view</code> 时，会显示一个标注信息 callout，展示关于该咖啡馆的额外的信息</p>
<p><img src="/images/ibt111.jpg" alt="ibt111"></p>
<p>在 iOS 9 之前，你想要在 annotation view 里添加一个自定义 View 并不是一件容易的事情。但现在 iOS 9 让事情变得简单了。<code>MKAnnotationView</code> 现在有一个新属性 <code>detailCalloutAccessoryView</code> 来展示这个 callouts，并且该 View 并没什么限制。</p>
<h3 id="Managing-callout-size"><a href="#Managing-callout-size" class="headerlink" title="Managing callout size"></a>Managing callout size</h3><p>Callouts 将根据你的自定义视图的大小来调整自己的尺寸。你的自定义 callouts 可以利用下面两种方式：</p>
<ul>
<li>在你的自定义视图中使用 Auto Layout 来布局</li>
<li>你可以覆盖 intrinsicContentSize 来定制你需要的尺寸</li>
</ul>
<p>这里用了 CoffeeShopPinDetailView.XIB 来设计自定义的 Callout，在 XIB 中我们使用 <code>UIStackView</code> 和 <code>Auto Layout</code> 来布局</p>
<p>自定义的 callouts 并不会铺满整个标注信息视图，他会显示一个标题和四周留白：</p>
<p><img src="/images/ibt112.jpg" alt="ibt112"></p>
<blockquote>
<p>没办法修改标题和四周的留白区域</p>
</blockquote>
<h3 id="Adding-a-custom-callout-accessory-view"><a href="#Adding-a-custom-callout-accessory-view" class="headerlink" title="Adding a custom callout accessory view"></a>Adding a custom callout accessory view</h3><p>理论学习完了，现在我们来添加自定义的 callout，UI 已经在 <code>CoffeeShopPinDetailView.xib</code> 中设计好了</p>
<p><img src="/images/ibt113.jpg" alt="ibt113"></p>
<p>打开 ViewController.swift 在 <code>mapView(_:viewForAnnotation:)</code> 里加入下面的方法：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">let</span> detailView = <span class="type">UIView</span>.loadFromNibNamed(identifier) <span class="keyword">as</span>!</div><div class="line">  <span class="type">CoffeeShopPinDetailView</span></div><div class="line">detailView.coffeeShop = annotation.coffeeshop</div><div class="line">annotationView!.detailCalloutAccessoryView = detailView</div></pre></td></tr></table></figure>
<p>首先从 XIB 文件中载入 <code>CoffeeShopPinDetailView</code>，然后为其分配当前的 <code>coffeeshop</code>，最后设置 view 的 <code>detailCalloutAccessoryView</code> 属性即可。</p>
<p><img src="/images/ibt114.jpg" alt="ibt114"></p>
<blockquote>
<p>点击 Yelp 按钮会打开 Safari 将你带到该咖啡店在 Yelp 的评价主页，但时钟按钮现在还点不了，稍后我们来实现</p>
</blockquote>
<h3 id="Supporting-time-zones"><a href="#Supporting-time-zones" class="headerlink" title="Supporting time zones"></a>Supporting time zones</h3><p>我们上面添加的 callouts 包含一个标识，指示当前咖啡馆是否正在营业：</p>
<p><img src="/images/ibt115.jpg" alt="ibt115"></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">var</span> timeZone = <span class="type">NSTimeZone</span>(abbreviation: <span class="string">"PST"</span>)!</div><div class="line"></div><div class="line"><span class="comment">/// Calculates whether a coffee shop is currently open for business</span></div><div class="line"><span class="keyword">var</span> isOpenNow: <span class="type">Bool</span> &#123;</div><div class="line">    <span class="keyword">let</span> calendar = <span class="type">NSCalendar</span>.currentCalendar()</div><div class="line">    <span class="keyword">let</span> nowComponents = calendar.componentsInTimeZone(<span class="type">CoffeeShop</span>.timeZone, fromDate: <span class="type">NSDate</span>())</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>isOpenNow 是个计算属性，用来标识当前营业状态。这里使用了 NSDate() 得到当前时间，并转换成咖啡馆所在时区的时间，以此来判断咖啡馆现在是否开始营业了。</p>
<p>很简单不是吗？但我们观察这一句：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">var</span> timeZone = <span class="type">NSTimeZone</span>(abbreviation: <span class="string">"PST"</span>)!</div></pre></td></tr></table></figure>
<p>这里硬编码了时区 PST，虽然我们的 APP 只包含了三藩的咖啡馆，但如果能根据地理位置自动推断出对应的时区时间岂不是更赞！</p>
<p>iOS 9 为 <code>MKMapItem</code> 和 <code>CLPlacemark</code> 添加了 <code>timeZone</code> 属性，我们利用该属性来得到符合当前地理位置的正确时间。</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">allCoffeeShops</span><span class="params">()</span></span> -&gt; [<span class="type">CoffeeShop</span>] &#123;</div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> path = <span class="type">NSBundle</span>.mainBundle().pathForResource(<span class="string">"sanfrancisco_coffeeshops"</span>, ofType: <span class="string">"plist"</span>),</div><div class="line">      <span class="keyword">let</span> array = <span class="type">NSArray</span>(contentsOfFile: path) <span class="keyword">as</span>? [[<span class="type">String</span> : <span class="type">AnyObject</span>]] <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">return</span> [<span class="type">CoffeeShop</span>]()</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 1</span></div><div class="line">    <span class="keyword">let</span> shops = array.flatMap &#123; <span class="type">CoffeeShop</span>(dictionary: $<span class="number">0</span>) &#125;</div><div class="line">      .<span class="built_in">sort</span> &#123; $<span class="number">0</span>.name &lt; $<span class="number">1</span>.name &#125;</div><div class="line">    <span class="comment">// 2</span></div><div class="line">    <span class="keyword">let</span> first = shops.first!</div><div class="line">    <span class="keyword">let</span> location = <span class="type">CLLocation</span>(latitude: first.location.latitude,</div><div class="line">      longitude: first.location.longitude)</div><div class="line">    <span class="comment">// 3</span></div><div class="line">    <span class="keyword">let</span> geocoder = <span class="type">CLGeocoder</span>()</div><div class="line">    geocoder.reverseGeocodeLocation(location) &#123; (placemarks, <span class="number">_</span>) <span class="keyword">in</span></div><div class="line">      <span class="keyword">if</span> <span class="keyword">let</span> placemark = placemarks?.first, timeZone =</div><div class="line">      placemark.timeZone &#123;</div><div class="line">      <span class="keyword">self</span>.timeZone = timeZone</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> shops</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ol>
<li>根据 plist 文件得到所有的咖啡馆</li>
<li>找出第一个咖啡馆的地理位置：经纬度</li>
<li>将经纬度转码成地理信息，在回调闭包得到 timeZone ，并设置为咖啡馆（CoffeeShop）的 timeZone</li>
</ol>
<p>现在运行，你会发现每个咖啡馆会基于旧金山时间来显示是否营业，而不是你当地的时间。</p>
<blockquote>
<p>在实际项目中，你需要判断每个咖啡馆的地理位置，因为他们可能分布在不同时区</p>
</blockquote>
<h3 id="Simulating-your-location"><a href="#Simulating-your-location" class="headerlink" title="Simulating your location"></a>Simulating your location</h3><p>我们当前所有的咖啡馆都在旧金山，所以我们也要假装自己在旧金山。比较幸运的是 Xcode 很容易就能做到这一点</p>
<p>点击 CafeTransit scheme 选择 Edit Scheme</p>
<p><img src="/images/ibt116.jpg" alt="ibt116"></p>
<p>勾选 Allow Location Simulation</p>
<p><img src="/images/ibt117.jpg" alt="ibt117"></p>
<h3 id="Making-a-single-location-request"><a href="#Making-a-single-location-request" class="headerlink" title="Making a single location request"></a>Making a single location request</h3><p>在 iOS 9 之前，得到用户当前位置需要一个相当繁琐的过程，你要创建一个 <code>CLLocationManager</code>，实现一些代理方法，然后调用 <code>startUpdatingLocation()</code>，然后随着用户位置移动，会反复调用 location manager delegate 方法。如果一旦达到了期望的精度，你需要调用 <code>stopUpdatingLocation()</code> 来让 location manager 停止工作，不然你的手机电量会很快耗光。</p>
<p>在 iOS 9 将这些繁琐的过程封装成了一个方法：requestLocation()，他仍然利用了 API 中的 delegate 回调方法，但不需要你手动控制开始结束了。你进需要设置期望的精度，然后 Core Location 会提供给你位置信息。他只调用一次 delegate 并且只返回一个位置。</p>
<p>理论听够了，来看实际例子</p>
<h4 id="Adding-a-location-manager"><a href="#Adding-a-location-manager" class="headerlink" title="Adding a location manager"></a>Adding a location manager</h4><p>在 ViewController.swift 的类声明下添加两个对象：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="built_in">lazy</span> <span class="keyword">var</span> locationManager = <span class="type">CLLocationManager</span>()</div><div class="line"><span class="comment">// 用来存储用户位置</span></div><div class="line"><span class="keyword">var</span> currentUserLocation: <span class="type">CLLocationCoordinate2D</span>?</div></pre></td></tr></table></figure>
<p>在 <code>viewDidLoad()</code> 中设置代理和期望精度：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">locationManager.delegate = <span class="keyword">self</span></div><div class="line">locationManager.desiredAccuracy = kCLLocationAccuracyHundredMeters</div></pre></td></tr></table></figure>
<p>下面我们来实现这个 <code>CLLocationManagerDelegate</code> 代理</p>
<figure class="highlight"><table><tr><td class="code"><pre><div class="line">// MARK:- CLLocationManagerDelegate</div><div class="line">extension ViewController: CLLocationManagerDelegate &#123;</div><div class="line">  // 查看该 App 是否有权限查看用户位置信息，如果有，请求用户位置</div><div class="line">  func locationManager(manager: CLLocationManager,</div><div class="line">didChangeAuthorizationStatus status: CLAuthorizationStatus) &#123;</div><div class="line">    if (status == CLAuthorizationStatus.AuthorizedAlways ||</div><div class="line">        status == CLAuthorizationStatus.AuthorizedWhenInUse) &#123;</div><div class="line">      locationManager.requestLocation()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  // 存储返回的第一个位置坐标</div><div class="line">  func locationManager(manager: CLLocationManager,</div><div class="line">    didUpdateLocations locations: [CLLocation]) &#123;</div><div class="line">    currentUserLocation = locations.first?.coordinate</div><div class="line">  &#125;</div><div class="line">  // 记录错误</div><div class="line">  func locationManager(manager: CLLocationManager,</div><div class="line">    didFailWithError error: NSError) &#123;</div><div class="line">    print("Error finding location: +</div><div class="line">      \(error.localizedDescription)")</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在你需要从其他地方调用 <code>requestLocation()</code></p>
<p>下面在 ViewController.swift 添加一个私有方法用来获取用户位置：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">requestUserLocation</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="comment">// 在地图上显示用户位置</span></div><div class="line">  mapView.showsUserLocation = <span class="literal">true</span></div><div class="line">  <span class="comment">// 请求之前判断权限，有权限更新位置，无权限先鉴权</span></div><div class="line">  <span class="keyword">if</span> <span class="type">CLLocationManager</span>.authorizationStatus() == .<span class="type">AuthorizedWhenInUse</span> &#123;</div><div class="line">    locationManager.requestLocation()</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    locationManager.requestWhenInUseAuthorization()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>注意，当你调用 <code>requestWhenInUseAuthorization()</code> 请求权限时，必须已经提前在 Info.plist 文件中，为 key：<code>NSLocationWhenInUseUsageDescription</code> 设置好了对应的键值。这个键值通常是一个字符串，会随鉴权请求弹窗一起展示给用户。</p>
<p><img src="/images/ibt118.jpg" alt="ibt118"></p>
<p>我们让地图一出现在屏幕上就请求用户位置</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidAppear</span><span class="params">(animated: Bool)</span></span> &#123;</div><div class="line">  <span class="keyword">super</span>.viewDidAppear(animated)</div><div class="line">  requestUserLocation()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后我们在 MKMapViewDelegate 中将用户位置传递给选中的 <code>annotation</code>（咖啡馆大头针标记），为下一节交通导航路线做准备</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapView</span><span class="params">(mapView: MKMapView,</span></span></div><div class="line">  didSelectAnnotationView view: MKAnnotationView) &#123;</div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> detailView = view.detailCalloutAccessoryView</div><div class="line">    <span class="keyword">as</span>? <span class="type">CoffeeShopPinDetailView</span> &#123;</div><div class="line">    detailView.currentUserLocation = currentUserLocation</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Requesting-transit-directions"><a href="#Requesting-transit-directions" class="headerlink" title="Requesting transit directions"></a>Requesting transit directions</h3><p>既然已经得到用户位置，现在让我们来添加前往指定咖啡馆的交通搭乘路线，这次在 CoffeeShopPinDetailView.swift 中添加一个 helper 方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">openTransitDirectionsForCoordinates</span><span class="params">(</span></span></div><div class="line">  coord:CLLocationCoordinate2D) &#123;</div><div class="line">  <span class="keyword">let</span> placemark = <span class="type">MKPlacemark</span>(coordinate: coord,</div><div class="line">    addressDictionary: coffeeShop.addressDictionary) <span class="comment">// 1</span></div><div class="line">  <span class="keyword">let</span> mapItem = <span class="type">MKMapItem</span>(placemark: placemark)  <span class="comment">// 2</span></div><div class="line">  <span class="keyword">let</span> launchOptions = [<span class="type">MKLaunchOptionsDirectionsModeKey</span>:</div><div class="line">    <span class="type">MKLaunchOptionsDirectionsModeTransit</span>]  <span class="comment">// 3</span></div><div class="line">  mapItem.openInMapsWithLaunchOptions(launchOptions)  <span class="comment">// 4</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>创建一个 <code>MKPlacemark</code> 用来存储你的坐标，<code>Placemarks</code> 通常有一个相对应的地址，而 coffee shop model 提供了基本的店名（从通讯录中）</li>
<li>用第一步的 <code>placemark</code> 初始化一个 <code>MKMapItem</code>（封装地图上某一点的相关信息）</li>
<li>指定导航模式，这里一共有三种可供设置：<ul>
<li><code>MKLaunchOptionsDirectionsModeDriving</code> 开车</li>
<li><code>MKLaunchOptionsDirectionsModeWalking</code> 步行</li>
<li><code>MKLaunchOptionsDirectionsModeTransit</code> 搭乘公共交通</li>
</ul>
</li>
<li>以指定的导航模式打开地图，并显示导航线路</li>
</ol>
<p>我们在 transitTapped() 中调用这个 helper 方法</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">transitTapped</span><span class="params">()</span></span> &#123;</div><div class="line">  openTransitDirectionsForCoordinates(coffeeShop.location)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>运行，在地图上点击标记的咖啡馆大头针，弹出的 callout 视图中点按 train 图标，你就会直接进入公共交通导航界面</p>
<p><img src="/images/ibt119.jpg" alt="ibt119"></p>
<h3 id="Querying-transit-times"><a href="#Querying-transit-times" class="headerlink" title="Querying transit times"></a>Querying transit times</h3><p>最后一个新特性是，MapKit 允许你查询公共交通行程信息。<code>MKETAResponse</code> 类在 iOS 9 新增了下面一些有用的属性：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">var</span> expectedTravelTime: <span class="type">NSTimeInterval</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"><span class="meta">@available</span>(iOS <span class="number">7.0</span>, *)</div><div class="line"><span class="keyword">public</span> <span class="keyword">var</span> <span class="built_in">distance</span>: <span class="type">CLLocationDistance</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"><span class="meta">@available</span>(iOS <span class="number">9.0</span>, *)</div><div class="line"><span class="keyword">public</span> <span class="keyword">var</span> expectedArrivalDate: <span class="type">NSDate</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"><span class="meta">@available</span>(iOS <span class="number">9.0</span>, *)</div><div class="line"><span class="keyword">public</span> <span class="keyword">var</span> expectedDepartureDate: <span class="type">NSDate</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line"><span class="meta">@available</span>(iOS <span class="number">9.0</span>, *)</div><div class="line"><span class="keyword">public</span> <span class="keyword">var</span> transportType: <span class="type">MKDirectionsTransportType</span> &#123; <span class="keyword">get</span> &#125;</div></pre></td></tr></table></figure>
<p>这些属性告诉你旅行的距离，时间以及出发时间和到达时间。</p>
<p>同样在地图上点击标记的咖啡馆大头针，弹出的 callout 视图中点按时钟图标，整个 view 会以动画的形式向上展示预估的出发时间和达到时间，下面让我们来实现这种效果：</p>
<p>还是在 CoffeeShopPinDetailView.swift 中，刚才的 helper 方法下面添加：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">requestTransitTimes</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">guard</span> <span class="keyword">let</span> currentUserLocation = currentUserLocation <span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 1</span></div><div class="line">  <span class="keyword">let</span> request = <span class="type">MKDirectionsRequest</span>()</div><div class="line"><span class="comment">// 2</span></div><div class="line">  <span class="keyword">let</span> source = <span class="type">MKMapItem</span>(placemark:</div><div class="line">    <span class="type">MKPlacemark</span>(coordinate: currentUserLocation,</div><div class="line">    addressDictionary: <span class="literal">nil</span>))</div><div class="line">  <span class="keyword">let</span> destination = <span class="type">MKMapItem</span>(placemark:</div><div class="line">    <span class="type">MKPlacemark</span>(coordinate: coffeeShop.location,</div><div class="line">    addressDictionary: <span class="literal">nil</span>))</div><div class="line"><span class="comment">// 3</span></div><div class="line">  request.source = source</div><div class="line">  request.destination = destination</div><div class="line">  request.transportType = <span class="type">MKDirectionsTransportType</span>.<span class="type">Transit</span></div><div class="line"><span class="comment">// 4</span></div><div class="line">  <span class="keyword">let</span> directions = <span class="type">MKDirections</span>(request: request)</div><div class="line">  directions.calculateETAWithCompletionHandler &#123;</div><div class="line">    response, error <span class="keyword">in</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</div><div class="line">      <span class="built_in">print</span>(error.localizedDescription)</div><div class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// 5</span></div><div class="line">      <span class="keyword">self</span>.updateEstimatedTimeLabels(response)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>一旦确认用户位置，初始化一个 <code>MKDirectionsRequest</code> 实例</li>
<li>创建两个 MKMapItem 实例，一个表示用户位置，另一个表示咖啡馆的位置。这里没有用到 addressDictionary 是因为我们只需要经纬度信息。</li>
<li>设置 <code>MKDirectionsRequest</code> 对象的源地址和目的地址，交通工具类型</li>
<li>用上面的 <code>request</code> 创建一个 <code>MKDirections</code> 对象实例，并执行 ETA 计算</li>
<li>最终结果将以闭包形式返回，如果收到一个成功的响应，则根据 response 更新在 view 上更新出发时间和到达时间</li>
</ol>
<p>最后实现点按时钟图标获取行程时间的方法，依然是在 CoffeeShopPinDetailView.swift：</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="meta">@IBAction</span> <span class="function"><span class="keyword">func</span> <span class="title">timeTapped</span><span class="params">()</span></span> &#123;</div><div class="line">  <span class="keyword">if</span> timeStackView.hidden &#123;</div><div class="line">    animateView(timeStackView, toHidden: <span class="literal">false</span>)</div><div class="line">    requestTransitTimes()</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    animateView(timeStackView, toHidden: <span class="literal">true</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>现在，当你按下时钟（clock）图标，时间视图会向上滑出，并向苹果服务器发送计算请求，最终行程的计算结果会自动更新子时间视图上。</p>
<p><img src="/images/ibt120.jpg" alt="ibt120"></p>
<hr>
<h2 id="Chapter-15：What’s-New-in-Xcode"><a href="#Chapter-15：What’s-New-in-Xcode" class="headerlink" title="Chapter 15：What’s New in Xcode?"></a>Chapter 15：What’s New in Xcode?</h2><p>这章我们来学习一下 Xcode 7 的新变化</p>
<h3 id="Getting-started-4"><a href="#Getting-started-4" class="headerlink" title="Getting started"></a>Getting started</h3><p>本章 demo 叫做 Local Weather，是一个基于你的地理位置显示天气的 APP。你可以在真机上运行一下，下面让我们来探索 Xcode 的新特性。</p>
<p><img src="/images/ibt121.jpg" alt="ibt121"></p>
<blockquote>
<p>想要看到 energy gauge 只能在真机上运行</p>
</blockquote>
<h3 id="Free-provisioning"><a href="#Free-provisioning" class="headerlink" title="Free provisioning"></a>Free provisioning</h3><p>Xcode 7 最大的变化是允许你免费真机调试了，也就是说不用每年交 99 美金也可以在你的手机上运行你写的程序了，但如果提交上架还是需要加入开发者计划。</p>
<p>使用免费的 Provisioning 在真机上运行看<a href="https://developer.apple.com/library/ios/documentation/IDEs/Conceptual/AppDistributionGuide/LaunchingYourApponDevices/LaunchingYourApponDevices.html" target="_blank" rel="external">这里</a></p>
<blockquote>
<p>本章天气的 API 来自于 openweathermap.org</p>
</blockquote>
<h3 id="Energy-impact-gauge"><a href="#Energy-impact-gauge" class="headerlink" title="Energy impact gauge"></a>Energy impact gauge</h3><p>我们来研究一下 Energy Impact</p>
<p><img src="/images/ibt122.jpg" alt="ibt122"></p>
<p>Energy Impact 显示了你 App 的耗电情况</p>
<p><img src="/images/ibt123.jpg" alt="ibt123"></p>
<p>Utilization 部分显示了当前时刻的 energy impact，右边的 average 是平均值</p>
<p>在底部，有四行分别代表 CPU、网络、位置和后台。每个小方格代表 1 秒的状态，如果这 1 秒钟状态是活跃的，则小方格会被灰色填满。</p>
<p>注意，CPU 和 位置状态始终是活跃状态，而网络活跃一段时间会停 4 ~ 5 秒钟，后台状态则是完全不活跃状态。</p>
<p>按下 Home 键将 App 退到后台，此时将会中止网络和位置状态，而后台状态变成活跃，CPU 始终是活跃状态。</p>
<p><img src="/images/ibt124.jpg" alt="ibt124"></p>
<p>观察一下 console，log 表明所有的后台程序将在 10.79 秒后结束，但是后台 energy graph 不会中止</p>
<p><img src="/images/ibt125.jpg" alt="ibt125"></p>
<h3 id="Code-browsing-features"><a href="#Code-browsing-features" class="headerlink" title="Code browsing features"></a>Code browsing features</h3><p>新版 Xcode 允许我们接手一个新项目时，能够快速熟悉整个 App 结构</p>
<h3 id="Interface-of-Swift-classes"><a href="#Interface-of-Swift-classes" class="headerlink" title="Interface of Swift classes"></a>Interface of Swift classes</h3><p>Swift 和 Objective-C 的一个显著区别就是没有头文件了，但头文件让我们可以快速熟悉一个类的用途，真的是很方便。Xcode 7 终于让 Swift 也能显示头文件了</p>
<p>随便打开一个 swift 文件 <code>WeatherViewController.swift</code> ，打开 assistant editor 点击 assistant editor 菜单，选择 Counterparts (1) ▶ WeatherViewController.swift (Interface)</p>
<p><img src="/images/ibt126.jpg" alt="ibt126"></p>
<blockquote>
<p>你也可以选择 Generated Interface</p>
</blockquote>
<p><img src="/images/ibt127.jpg" alt="ibt127"></p>
<p>私有变量和方法并不会显示出来，还注意到头文件中的注释了吗？只有在源文件中使用 /// 或 /** 才会在 Interface 中显示注释</p>
<p><img src="/images/ibt128.jpg" alt="ibt128"></p>
<h3 id="Generated-Swift-interface-for-Objective-C-headers"><a href="#Generated-Swift-interface-for-Objective-C-headers" class="headerlink" title="Generated Swift interface for Objective-C headers"></a>Generated Swift interface for Objective-C headers</h3><p>你也可以为 Objective-C 的头文件生成 Swift 接口。我们找一对用 Objective-C 写的类文件：<code>RWHTTPManager.h</code> 和 <code>RWHTTPManager.m</code>，<code>RWHTTPManager</code> 类用 OC 语法封装了 <code>NSURLSession</code></p>
<p><img src="/images/ibt129.jpg" alt="ibt129"></p>
<p>现在用同样的方法转成 Swift 接口：</p>
<p><img src="/images/ibt130.jpg" alt="ibt130"></p>
<p>是不是很奇幻，用 Swift 生成的新接口貌似更加通俗易懂</p>
<p>这里有两个小 issue，可能是 OC 转 Swift 时编译器还不那么完美：</p>
<p>1.注意转换后 <code>baseURL</code> 作为属性是 optional，而作为参数是 non-optional 的。但是 baseURL 显示是必须的。我们在 OC 文件中修正一下，用 <code>_Nonnull</code> 替换 <code>_Nullable</code></p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">@property (nonatomic, strong) <span class="type">NSURL</span> * _Nonnull baseURL;</div></pre></td></tr></table></figure>
<p>保存，再生成一次 Swift 接口，现在 baseURL 变成 non-optional 的了</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="keyword">var</span> baseURL: <span class="type">NSURL</span></div></pre></td></tr></table></figure>
<p>2.另外一个 issue 是在 <code>fetchJSONAtPath</code> 方法中注意参数 relativePath，在 Swift 接口中也变成可选的了，但是通过文档我们知道这个参数不能为 nil，同样的方法，用 <code>_Nonnull</code> 替换 <code>_Nullable</code></p>
<h4 id="New-documentation-features"><a href="#New-documentation-features" class="headerlink" title="New documentation features"></a>New documentation features</h4><p>现在 Xcode 7 中的注释支持 markdown 语法了，NSHipster 有篇文章很棒，看<a href="http://nshipster.com/swift-documentation/" target="_blank" rel="external">这里</a></p>
<h4 id="Find-call-hierarchy"><a href="#Find-call-hierarchy" class="headerlink" title="Find call hierarchy"></a>Find call hierarchy</h4><p>现在查找指定方法在哪里被调用也很方便，选中方法右键或 Control 单击，弹出菜单选择 Find Call Hierarchy 即可</p>
<p><img src="/images/ibt131.jpg" alt="ibt131"></p>
<h3 id="Decreasing-energy-impact"><a href="#Decreasing-energy-impact" class="headerlink" title="Decreasing energy impact"></a>Decreasing energy impact</h3><p>回到我们的 App 上来，现在有点费电，下面来修复一下。在开始前，先回顾下整个 App 的工作流程：</p>
<ol>
<li>请求用户当前位置</li>
<li>一旦获取到用户位置，使用 Http 请求抓取当地天气</li>
<li>收到天气数据后，更新 UI 并且定时 15 秒后再次发送更新请求</li>
<li>countdownLabel 显示倒计时，距下次发送请求还有多少时间。计时间隔为 0.1 秒</li>
</ol>
<p>我们可以搜索 // Step，查看详细的步骤：</p>
<p><img src="/images/ibt132.jpg" alt="ibt132"></p>
<p>回想一下之前在 energy impact 中网络的活跃状态，活跃 10 ~ 11 秒后跟随 3 ~ 5 秒的非活跃状态，这是因为只要发出网络请求，他会持续 10 秒钟，即使已经完成了请求</p>
<p>这会导致每次网络请求都会很耗电，你可能认为 15 秒只发一次请求，只占 7%，对资源消耗并不严重，但这只是理想状态，真实的情况是每 15 秒发一次请求，网络请求会持续 11 秒，时间占用达到了 73%</p>
<p>这是我们第一个要修复的问题</p>
<h4 id="Reducing-network-energy-impact"><a href="#Reducing-network-energy-impact" class="headerlink" title="Reducing network energy impact"></a>Reducing network energy impact</h4><p>天气虽然变化很快，但 15 秒更新一次的频率显然有点太快了。我们让他再每次启动时更新一次就够了，因为这也符合用户习惯，打开看一眼就关掉了。</p>
<p>注释掉 Step 6 每隔 15 秒更新的代码</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// Step 6: Set a timer to fetch the weather again in 15 seconds</div><div class="line">// networkFetchTimer = NSTimer</div><div class="line">//  .scheduledTimerWithTimeInterval(15, ...</div></pre></td></tr></table></figure>
<p>运行，Energy Impact 结果好了很多</p>
<p><img src="/images/ibt133.jpg" alt="ibt133"></p>
<h4 id="Reducing-CPU-energy-impact"><a href="#Reducing-CPU-energy-impact" class="headerlink" title="Reducing CPU energy impact"></a>Reducing CPU energy impact</h4><p>每隔 0.1 秒更新一次 view 的倒计时动画是消耗 CPU 的罪魁祸首，让我们停掉他</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// Step 7: Update the countdown label every 0.1 seconds using a timer</div><div class="line">// countdownUpdateTimer = NSTimer.scheduledTimerWithTimeInterval(0.1 ...</div></pre></td></tr></table></figure>
<p>同时也不需要 <code>countdownLabelStackView</code> 显示了</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// countdownLabelStackView.hidden = false</div></pre></td></tr></table></figure>
<p>现在又好了很多，不是吗？</p>
<p><img src="/images/ibt134.jpg" alt="ibt134"></p>
<h4 id="Reducing-location-energy-impact"><a href="#Reducing-location-energy-impact" class="headerlink" title="Reducing location energy impact"></a>Reducing location energy impact</h4><p>我们获取到用户地理位置就不该再继续请求了，iOS 9 提供了新的请求方法 requestLocation() 他成功请求一次用户位置就会停止继续请求</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">// Step 2: Request the location</div><div class="line">locationManager.requestLocation()</div></pre></td></tr></table></figure>
<p><img src="/images/ibt135.jpg" alt="ibt135"></p>
<h4 id="Reducing-background-energy-impact"><a href="#Reducing-background-energy-impact" class="headerlink" title="Reducing background energy impact"></a>Reducing background energy impact</h4><p>进入后台，我们通过控制台发现 11 秒后，后台任务已经完成了，但后台线程依然在消耗电池资源。这是因为调用 <code>beginBackgroundTaskWithExpirationHandler(_:)</code> 执行后台任务完成后，我们并没有调用 <code>endBackgroundTask(_:)</code> 告知系统你的任务已经结束了。</p>
<p>在 <code>performBackgroundWork()</code> 方法末尾手动补上就行了</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="built_in">print</span>(<span class="string">"Background work completed in: \(formattedElapsedTime) "</span> +  </div><div class="line">  <span class="string">"sec"</span>)</div><div class="line"><span class="type">UIApplication</span>.sharedApplication().endBackgroundTask(  </div><div class="line">  backgroundTaskIdentifier)</div></pre></td></tr></table></figure>
<p>至此，你已经修复了所有的耗电问题</p>
<p><img src="/images/ibt136.jpg" alt="ibt136"></p>
<h3 id="Core-Location-instrument"><a href="#Core-Location-instrument" class="headerlink" title="Core Location instrument"></a>Core Location instrument</h3><p>如果你想深挖一下用户位置是如何获取的，iOS 9 的新 Core Location instrument 很可能适合你。运行 App，去 energy gauge 界面，点击 Location 按钮</p>
<p><img src="/images/ibt137.jpg" alt="ibt137"></p>
<p><img src="/images/ibt138.jpg" alt="ibt138"></p>
<p>Instruments 将会打开运行 Core Location instrument</p>
<p><img src="/images/ibt139.jpg" alt="ibt139"></p>
<p>注意第二行 “CLLocationManager changed accuracy to kCLLocationAccuracyBest”，获取到这种精度的位置信息花费了 892.03 ms，天气 App 显然不需要这么细的精度，改成 <code>kCLLocationAccuracyKilometer</code> 就足够了</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line">locationManager.desiredAccuracy = kCLLocationAccuracyKilometer</div></pre></td></tr></table></figure>
<p>这次精度调低，获取地理位置的时间也加快了上百倍</p>
<p><img src="/images/ibt140.jpg" alt="ibt140"></p>
<h3 id="Playground-improvements"><a href="#Playground-improvements" class="headerlink" title="Playground improvements"></a>Playground improvements</h3><p>天气 App 优化到此结束，我们下面来玩一下 Playground，Xcode 7 还是增加了很多新特性</p>
<h4 id="Rich-playground-authoring"><a href="#Rich-playground-authoring" class="headerlink" title="Rich playground authoring"></a>Rich playground authoring</h4><p>现在 playground 支持 Markdown 语法了，你可以用 Markdown 语法写完，然后开启 Render Documentation 渲染</p>
<p><img src="/images/ibt141.jpg" alt="ibt141"></p>
<p>开启渲染</p>
<p><img src="/images/ibt142.jpg" alt="ibt142"></p>
<p>单行注释用  <code>///</code> 或 <code>/**</code>，多行用 <code>/*</code>: 和 <code>*/</code>，更多 Markup 格式看<a href="https://developer.apple.com/library/ios/documentation/Xcode/Reference/xcode_markup_formatting_ref/index.html#//apple_ref/doc/uid/TP40016497" target="_blank" rel="external">这里</a></p>
<h4 id="Playground-pages"><a href="#Playground-pages" class="headerlink" title="Playground pages"></a>Playground pages</h4><p>现在你可以在 playground 里添加多个页面了，回到 project navigator，点击左下角加号按钮，选择 New Page</p>
<p><img src="/images/ibt143.jpg" alt="ibt143"></p>
<p>添加完毕，将第一个命名为 Home</p>
<p><img src="/images/ibt144.jpg" alt="ibt144"></p>
<p>选中 Page Two，会发现 Previous 和 Next 两个链接（需要关闭 <code>Render Documentation</code> 才能看见）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">//: [Previous](@previous)</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> Foundation</div><div class="line"></div><div class="line"><span class="keyword">var</span> str = <span class="string">"Hello, playground"</span></div><div class="line"></div><div class="line"><span class="comment">//: [Next](@next)</span></div></pre></td></tr></table></figure>
<p>@next 和 @previous 代表特殊符号，用来链接前后的页面，如果要链接到指定页面，需要提供 page name，如果名字中间有空格用 %20 代替</p>
<p>可以在 Page Two 页面的任意位置添加下面的链接（跳转到 Home）</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">//: [Jump to Home](Home)</span></div></pre></td></tr></table></figure>
<p>在 Home 页面添加跳转 Page Two 的链接</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><div class="line"><span class="comment">//: [Jump to Page Two](Page%20Two)</span></div></pre></td></tr></table></figure>
<h4 id="Inline-results"><a href="#Inline-results" class="headerlink" title="Inline results"></a>Inline results</h4><p>Inline results 允许你在 playground 里直接看运行结果，比如我们写个 view，在右边的 sidebar 里点击 Show Result，可以直接查看渲染好的 view</p>
<p><img src="/images/ibt145.jpg" alt="ibt145"></p>
<p>在 view 变量下面直接可以看到渲染结果</p>
<p><img src="/images/ibt146.jpg" alt="ibt146"></p>
<p>改变 view layer 的 borderWidth 到 40，渲染结果也跟着更新</p>
<p><img src="/images/ibt147.jpg" alt="ibt147"></p>
<h4 id="Sources-and-resources"><a href="#Sources-and-resources" class="headerlink" title="Sources and resources"></a>Sources and resources</h4><p>现在你可以在 playground 里添加辅助的源文件和资源文件了（分别放在 Sources 文件夹和 Resources 文件夹）将这些支持文件放到相关文件夹里，可以使结构更清晰</p>
<p><img src="/images/ibt148.jpg" alt="ibt148"></p>
<p>每一个 playground page 都有自己的 sources 和 resources 文件夹，且优先于使用自己的支援文件夹里的内容</p>
<h4 id="Manually-run-playgrounds"><a href="#Manually-run-playgrounds" class="headerlink" title="Manually run playgrounds"></a>Manually run playgrounds</h4><p>不想每次在 playground 上做点修改都自动编译运行，机器还卡成狗，现在你可以手动控制允许了</p>
<p><img src="/images/ibt149.jpg" alt="ibt149"></p>
<h3 id="Other-improvements"><a href="#Other-improvements" class="headerlink" title="Other improvements"></a>Other improvements</h3><p>Storyboards 和 Interface Builder 还有几个改进：</p>
<ul>
<li>Control-dragging 从 View 到另一个 View 加约束的时候，按住 Option 键，将会看到可添加的 constants</li>
<li>现在可以设置一个 view 的 layout margins 和为约束（constraint）设置一个标识（identifier），这样出现在 document outline 中的 constraint 有了更好的可读性。</li>
</ul>
<p>还有很多新特性需要你自己去挖掘</p>
<h4 id="Address-sanitizer"><a href="#Address-sanitizer" class="headerlink" title="Address sanitizer"></a>Address sanitizer</h4><p>Xcode 推出了一个新的工具，会帮助捕获在使用 Objective-C 或 C 时，可能出现的内存损坏错误</p>
<p>你可以去 Product \ Scheme \ Edit Scheme 中开启：Enable Address Sanitizer</p>
<p><img src="/images/ibt150.jpg" alt="ibt150"></p>
<blockquote>
<p>开启后，Xcode 将添加额外的 instrumentation 来构建你的应用程序，以便于更好地找出内存错误</p>
</blockquote>
<h4 id="Right-to-left-support"><a href="#Right-to-left-support" class="headerlink" title="Right-to-left support"></a>Right-to-left support</h4><p>iOS 9 的一个重大更新是开始支持从右到左的语言，如果你使用了 Auto Layout，那么几乎不需要你做什么工作就能正常在这种语言环境下使用</p>
<p>Xcode 提供了一个不需要更改语言环境就能测试 view 在从右到左环境下的特性 ，编辑你的 scheme，在 Options 界面下，展开 Application Language，这里有个 Right to Left Pseudolanguage 选项，勾上就能开心地测试了~</p>
<p><img src="/images/ibt151.jpg" alt="ibt151"></p>
<p>iOS 9 by Tutorials 全书到此结束，终于写完了，呼呼~</p>

    
  </div>


          </div>
          

  <p>热评文章</p>
  <div class="ds-top-threads" data-range="weekly" data-num-items="4"></div>


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="vault/ios9-by-tutorial-note.html"
           data-title="iOS 9 by Turorials 笔记" data-url="http://wdxtub.com/vault/ios9-by-tutorial-note.html">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/misc/avatar.jpg"
               alt="wdxtub" />
          <p class="site-author-name" itemprop="name">wdxtub</p>
          <p class="site-description motion-element" itemprop="description">人文/科学/读书/写作/思考/编程/架构/数据/广交朋友/@SYSU/@CMU</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">710</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">874</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/wdxtub" target="_blank" title="GitHub">
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/wdxtub" target="_blank" title="微博">
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://douban.com/people/wdx" target="_blank" title="豆瓣">
                  
                  豆瓣
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.zhihu.com/people/wdxtub" target="_blank" title="知乎">
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              不妨看看
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://zhchbin.github.io/" title="zhchbin" target="_blank">zhchbin</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.algorithmdog.com/" title="算法狗" target="_blank">算法狗</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.52cs.org/" title="我爱计算机" target="_blank">我爱计算机</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://jackqdyulei.github.io/" title="雷雷" target="_blank">雷雷</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://guojiex.github.io/" title="瓜瓜" target="_blank">瓜瓜</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://wdxtub.lofter.com/" title="我的 Lofter" target="_blank">我的 Lofter</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://wdxtub.com/interview/" title="刷题笔记" target="_blank">刷题笔记</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2013 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">wdxtub</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"wdxblog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementById('footer')
      || document.getElementById('footer')).appendChild(ds);
    })();
  </script>

  
    
      
      <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
      <script src="/js/src/hook-duoshuo.js"></script>
    
  





  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();

    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
            // get the contents from search data
            isfetched = true;
            $('.popup').detach().appendTo('.header-inner');
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var matchcounts = 0;
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length > 1) {
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        matchcounts += 1;
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 50;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substring(start, end);
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                })};
                str += "</ul>";
                if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
                if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
                $resultContent.innerHTML = str;
            });
            proceedsearch();
        }
    });}

    // handle and trigger popup window;
    $('.popup-trigger').mousedown(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };

    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>
  <script type="text/javascript" src=""></script>


  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->


</body>
</html>
